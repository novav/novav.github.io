<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"novav.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Simon Shi的小站">
<meta property="og:url" content="https://novav.github.io/page/14/index.html">
<meta property="og:site_name" content="Simon Shi的小站">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Simon Shi">
<meta property="article:tag" content="AI,Machine Learning, Deep Learning">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://novav.github.io/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Simon Shi的小站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Simon Shi的小站</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">人工智能，机器学习， 强化学习，大模型，自动驾驶</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/08/04/Sub_Language/CPlus/Cplus_thirdlibs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/04/Sub_Language/CPlus/Cplus_thirdlibs/" class="post-title-link" itemprop="url">C++ 三方库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-04 12:00:00" itemprop="dateCreated datePublished" datetime="2022-08-04T12:00:00+00:00">2022-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:40" itemprop="dateModified" datetime="2025-08-06T08:16:40+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="loguru-hpp"><a href="#loguru-hpp" class="headerlink" title="loguru.hpp"></a>loguru.hpp</h3><p>office web: <a target="_blank" rel="noopener" href="https://github.com/emilk/loguru">GitHub - emilk&#x2F;loguru: A lightweight C++ logging library</a></p>
<p><a target="_blank" rel="noopener" href="https://emilk.github.io/loguru/index.html">Docments</a></p>
<p>loguru一共只需要两个源文件: loguru.hpp 和 loguru.cpp.<br>链接的时候还需要: -lpthread -ldl</p>
<h4 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loguru::g_stderr_verbosity = <span class="number">9</span>;                            <span class="comment">// print everything</span></span><br><span class="line"><span class="comment">// 不想打印到console</span></span><br><span class="line">loguru::g_stderr_verbosity = loguru::Verbosity_OFF;        <span class="comment">// not print anthing</span></span><br></pre></td></tr></table></figure>

<h4 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loguru::add_file(<span class="string">&quot;everything.log&quot;</span>, loguru::Append, loguru::Verbosity_MAX);</span><br></pre></td></tr></table></figure>

<p>标准输出,后缀_F类似于<code>printf</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOG_F(INFO, <span class="string">&quot;I&#x27;m hungry for some %.3f!&quot;</span>, <span class="number">3.14159</span>);</span><br></pre></td></tr></table></figure>

<p>判断程序，如果真，则输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOG_IF_F(ERROR, <span class="literal">true</span>, <span class="string">&quot;Will only show if badness happens&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>断言，会中断程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHECK_F(<span class="number">1</span> == <span class="number">0</span>, <span class="string">&quot;Assertion 1 == 0 failed.\n &#x27;%s&#x27;\n &#x27;%d&#x27; &quot;</span>, a.c_str(), <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// g++ demo.cpp loguru.cpp -lpthread -ldl</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;loguru.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">    loguru::g_stderr_verbosity = <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optional, but useful to time-stamp the start of the log.</span></span><br><span class="line">    <span class="comment">// Will also detect verbosity level on command line as -v.</span></span><br><span class="line">    <span class="comment">// loguru::init(argc, argv);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Put every log message in &quot;everything.log&quot;:</span></span><br><span class="line">    loguru::add_file(<span class="string">&quot;everything.log&quot;</span>, loguru::Append, loguru::Verbosity_MAX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only log INFO, WARNING, ERROR and FATAL to &quot;latest_readable.log&quot;:</span></span><br><span class="line">    loguru::add_file(<span class="string">&quot;latest_readable.log&quot;</span>, loguru::Truncate, loguru::Verbosity_INFO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only show most relevant things on stderr:</span></span><br><span class="line">    <span class="comment">// loguru::g_stderr_verbosity = 1;</span></span><br><span class="line"></span><br><span class="line">    LOG_SCOPE_F(INFO, <span class="string">&quot;Will indent all log messages within this scope.&quot;</span>);</span><br><span class="line">    LOG_F(INFO, <span class="string">&quot;I&#x27;m hungry for some %.3f!&quot;</span>, <span class="number">3.14159</span>);</span><br><span class="line">    LOG_F(<span class="number">2</span>, <span class="string">&quot;Will only show if verbosity is 2 or higher&quot;</span>);</span><br><span class="line">    <span class="comment">// VLOG_F(get_log_level(), &quot;Use vlog for dynamic log level (integer in the range 0-9, inclusive)&quot;);</span></span><br><span class="line">    LOG_IF_F(ERROR, <span class="literal">true</span>, <span class="string">&quot;Will only show if badness happens&quot;</span>);</span><br><span class="line">    <span class="comment">// auto fp = fopen(filename, &quot;r&quot;);</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> a = <span class="string">&quot;Here is a string.&quot;</span>; </span><br><span class="line">    <span class="comment">//CHECK_F(1 == 0, &quot;Assertion 1 == 0 failed.\n &#x27;%s&#x27;\n &#x27;%d&#x27; &quot;, a.c_str(), 1000);</span></span><br><span class="line">    <span class="comment">/// CHECK_GT_F(length, 0); // Will print the value of `length` on failure.</span></span><br><span class="line">    <span class="comment">/// CHECK_EQ_F(a, b, &quot;You can also supply a custom message, like to print something: %d&quot;, a + b);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Each function also comes with a version prefixed with D for Debug:</span></span><br><span class="line">    <span class="comment">/// DCHECK_F(expensive_check(x)); // Only checked #if !NDEBUG</span></span><br><span class="line">    DLOG_F(INFO, <span class="string">&quot;Only written in debug-builds&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turn off writing to stderr:</span></span><br><span class="line">    loguru::g_stderr_verbosity = loguru::Verbosity_OFF;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Turn off writing err/warn in red:</span></span><br><span class="line">    loguru::g_colorlogtostderr = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6fdd1a99e815">简书-logurn</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/28/Tools/Tools_shortcutkeys/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/28/Tools/Tools_shortcutkeys/" class="post-title-link" itemprop="url">日常使用的快捷键</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-28 10:00:00" itemprop="dateCreated datePublished" datetime="2022-07-28T10:00:00+00:00">2022-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:40" itemprop="dateModified" datetime="2025-08-06T08:16:40+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/shortcut-key/" itemprop="url" rel="index"><span itemprop="name">shortcut-key</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Win窗口快捷键"><a href="#Win窗口快捷键" class="headerlink" title="Win窗口快捷键"></a>Win窗口快捷键</h3><p>Win + ←：最大化窗口到左侧的屏幕上（与开始屏幕应用无关）<br>Win + →：最大化窗口到右侧的屏幕上（与开始屏幕应用无关）</p>
<p>Win+ ↑：最大化窗口（与开始屏幕应用无关）<br>Win+ ↓：最小化窗口（与开始屏幕应用无关）</p>
<p>Win+ SHIFT +↑：垂直拉伸窗口，宽度不变（与开始屏幕应用无关）<br>Win+ SHIFT +↓：垂直缩小窗口，宽度不变（与开始屏幕应用无关）</p>
<p>Win+SHIFT+←：将活动窗口移至左侧显示器 （与开始屏幕应用无关）<br>Win+SHIFT+→：将活动窗口移至右侧显示器（与开始屏幕应用无关）</p>
<h3 id="WIN桌面快捷键"><a href="#WIN桌面快捷键" class="headerlink" title="WIN桌面快捷键"></a>WIN桌面快捷键</h3><p>Ctrl + Win + ← 切换到上一个桌面</p>
<p>Ctrl + Win + → 切换到下一个桌面</p>
<h3 id="WPS"><a href="#WPS" class="headerlink" title="WPS"></a>WPS</h3><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>编辑</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>复制格式</td>
<td>Ctrl+Shift+C</td>
</tr>
<tr>
<td></td>
<td>粘贴格式</td>
<td>Ctrl+Shift+V</td>
</tr>
<tr>
<td></td>
<td>撤销</td>
<td>Ctrl+Z</td>
</tr>
<tr>
<td></td>
<td>恢复</td>
<td>Ctrl+Y</td>
</tr>
<tr>
<td></td>
<td>插入分页符</td>
<td>Ctrl+Enter</td>
</tr>
<tr>
<td></td>
<td>插入换行符</td>
<td>Shift+Enter</td>
</tr>
<tr>
<td></td>
<td>插入空域</td>
<td>Ctrl+F9</td>
</tr>
<tr>
<td></td>
<td>插入超链接</td>
<td>Ctrl+K</td>
</tr>
<tr>
<td></td>
<td>删除行</td>
<td>Ctrl+”-“</td>
</tr>
<tr>
<td>格式</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>增大字号</td>
<td>Ctrl+Shift+. 或者</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Ctrl+]</td>
</tr>
<tr>
<td></td>
<td>减小字号</td>
<td>Ctrl+Shift+, 或者</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Ctrl+[</td>
</tr>
<tr>
<td></td>
<td>上标</td>
<td>Ctrl+Shift+&#x3D;</td>
</tr>
<tr>
<td></td>
<td>下标</td>
<td>Ctrl++</td>
</tr>
<tr>
<td></td>
<td>筛选</td>
<td>Ctrl+Shift+L</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>合并单元格</td>
<td>Ctrl + M</td>
</tr>
<tr>
<td></td>
<td>替换</td>
<td>Ctrl + H</td>
</tr>
<tr>
<td>运算</td>
<td>求和</td>
<td>Alt + “&#x3D;”</td>
</tr>
</tbody></table>
<h3 id="VS-Code"><a href="#VS-Code" class="headerlink" title="VS Code"></a>VS Code</h3><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Ctrl+K Ctrl+L</td>
<td>全部展开</td>
</tr>
<tr>
<td></td>
<td>Ctrl+K Ctrl+0</td>
<td>全部折叠</td>
</tr>
<tr>
<td></td>
<td>Ctrl + shift + U</td>
<td>切换输出视图</td>
</tr>
<tr>
<td></td>
<td>Ctrl + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ctrl + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Alt + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Alt + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Alt + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Alt + shift + down</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Alt + shift + down</td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/27/Course/SLAM/ch07_vo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/27/Course/SLAM/ch07_vo/" class="post-title-link" itemprop="url">SMPL 第七讲 视觉里程计 ICP和实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-27 21:00:00" itemprop="dateCreated datePublished" datetime="2022-07-27T21:00:00+00:00">2022-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:39" itemprop="dateModified" datetime="2025-08-06T08:16:39+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/VO/" itemprop="url" rel="index"><span itemprop="name">VO</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/VO/ICP/" itemprop="url" rel="index"><span itemprop="name">ICP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>目标：</p>
<ul>
<li><p>理解图像特征点的意义，掌握在单张图像中提取出特征点，掌握<mark>多副图像匹配特征点</mark>的方法</p>
</li>
<li><p>理解<mark>对极几何</mark>的原理，利用对极几何的约束，恢复图像之间摄像机的三维运动</p>
</li>
<li><p>理解<mark>PNP(3D-2D)</mark>问题，利用已知三维结构与图像对应关系，求解摄像机的三维运动</p>
</li>
<li><p>理解<mark>ICP问题(3D-3D)</mark>，利用点云匹配关系，求解摄像机的三维运动</p>
</li>
<li><p>理解如何通过<mark>三角化</mark>，获得二维图像上对应点的三维结构。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>视觉里程计（VO）算法</th>
<th>现状</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>特征点法</td>
<td>目前的主流算法</td>
<td></td>
</tr>
<tr>
<td>直接法</td>
<td>追赶者的角色</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>特征点提取算法</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>方法</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>角点</td>
<td>Harris 角点、FAST 角点 、GFTT 角点</td>
<td></td>
</tr>
<tr>
<td>局部图像特征</td>
<td>SIFT 、SURF 、ORB</td>
<td>速度: ORB &lt; SIFI</td>
</tr>
<tr>
<td></td>
<td>关键点</td>
<td>描述子</td>
</tr>
<tr>
<td>ORB特征</td>
<td>Oriented FAST and Rotated BRIEF</td>
<td>BRIEF</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>匹配算法</strong><br>    - 暴力匹配</p>
<p>    - 汉明距离</p>
<p>    - 快速近似最近邻</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: Start</span><br><span class="line">e=&gt;end: End</span><br><span class="line">op1=&gt;operation: 特征点 | past</span><br><span class="line">op2=&gt;operation: ORB匹配 | past</span><br><span class="line">op3=&gt;operation: 特征匹配 | past</span><br><span class="line"></span><br><span class="line">st(right)-&gt;op1(right)-&gt;op2(right)-&gt;op3(right)-&gt;e</span><br></pre></td></tr></table></figure>

<h3 id="1、特征点法"><a href="#1、特征点法" class="headerlink" title="1、特征点法"></a>1、特征点法</h3><p>一个 SLAM 系统分为前端和后端,其中是<strong>视觉SLAM前端</strong>也称为<strong>视觉里程计(VO)</strong>。VO根据相邻图像的信息估计出粗略的相机运动,给后端提供较好的初始值。VO的算法主要分为两个大类:<strong>特征点法</strong>和<strong>直接法</strong>。基于特征点法的前端,被认为是视觉里程计的主流方法。它具有稳定,对光照、动态物体不敏感的优势,是目前比较成熟的解决方案。如何提取、匹配图像特征点,然后估计两帧之间的相机运动和场景结构,从而实现一个两帧间视觉里程计。这类算法也称为<u>两视图几何(Two-view geometry)</u>。</p>
<h4 id="1-1-特征点"><a href="#1-1-特征点" class="headerlink" title="1.1 特征点"></a>1.1 特征点</h4><p>VO的核心问题是如何根据图像来估计相机运动。然而,图像本身是一个由亮度和色彩组成的矩阵,如果直接从矩阵层面考虑运动估计,将会非常困难。所以,比较方便的做法是:首先,从图像中选取比较有代表性的点。这些点在相机视角发生少量变化后会保持不变,于是能在各个图像中找到相同的点。然后,在这些点的基础上,讨论相机位姿估计问题,以及这些点的定位问题。在经典SLAM模型中称这些点为路标(Landmark)。而在视觉 SLAM 中,路标则是指图像特征(Feature)。其定义为：一组与计算任务相关的信息,计算任务取决于具体的应用。简而言之,<u>特征是图像信息的另一种数字表达形式</u>。一组好的特征对于在指定任务上的最终表现至关重要。数字图像在计算机中以灰度值矩阵的方式存储,所以最简单的单个图像像素也是一种“特征”。但是,在视觉里程计中希望特征点在相机运动之后保持稳定,而灰度值受光照、形变、物体材质的影响严重,在不同图像间变化非常大,不够稳定。理想的情况是,当场景和相机视角发生少量改变时,算法还能从图像中判断哪些地方是同一个点。所以,仅凭灰度值是不够的,需要对图像提取特征点。 特征点是图像里一些特别的地方，可以把图像中的角点、边缘和区块都当成图像中有代表性的地方。不过更容易精确地指出,某两幅图像中出现了同一个角点;同一 个边缘则稍微困难一些,因为沿着该边缘前进,图像局部是相似的;同一个区块则是最困难的。可以发现,图像中的角点、边缘相比于像素区块而言更加“特别”,在不同图像之间的辨识度更强。<u>所以,一种直观的提取特征的方式就是在不同图像间辨认角点,确定它们的对应关</u>系。在这种做法中,角点就是所谓的特征。角点的提取算法有很多,例如<strong>Harris 角点、FAST 角点 、GFTT 角点</strong>等等。然而,在大多数应用中,单纯的角点依然不能满足很多需求。例如,从远处看上去是角点的地方,当相机走近之后,可能就不显示为角点了。或者,当旋转相机时,角点的外观会发生变化,也就不容易辨认出那是同一个角点。为此,就提出了许多更加稳定的<strong>局部图像特征</strong>,如著名的<strong>SIFT 、SURF 、ORB</strong> ,等等。相比于普通角点,这些人工设计的特征点能够拥有如下的性质:</p>
<ol>
<li>可重复性(Repeatability):相同的特征可以在不同的图像中找到。</li>
<li>可区别性(Distinctiveness):不同的特征有不同的表达。</li>
<li>高效率(Efficiency):同一图像中,特征点的数量应远小于像素的数量。</li>
<li>本地性(Locality):特征仅与一小片图像区域相关。</li>
</ol>
<p><strong>特征点由关键点(Key-point)和描述子(Descriptor)两部分组成</strong>。关键点是指该特征点在图像里的位置,有些特征点还具有朝向、大小等信息。描述子通常是一个向量,按照某种人为设计的方式,描述了该关键点周围像素的信息。描述子是按照“外观相似的特征应该有相似的描述子”的原则设计的。因此,只要两个特征点的描述子在向量空间上的距离相近,就可以认为它们是同样的特征点。<strong>SIFT(尺度不变特征变换,Scale-Invariant FeatureTransform)</strong>：充分考虑了在图像变换过程中出现的光照、尺度、旋转等变化,但随之而来的是极大的计算量。 <strong>FAST</strong>关键点则考虑适当降低精度和鲁棒性,以提升计算的速度，属于计算特别快的一种特征点(没有描述子)；而<strong>ORB</strong>(Oriented FASTand Rotated BRIEF)特征则是改进了 FAST 检测子不具有方向性的问题,并采用速度极快的二进制描述子<strong>BRIEF</strong>,使整个图像特征提取的环节大大加速。根据作者在论文中所述测试,在同一幅图像中同时提取约 1000 个特征点的情况下,ORB 约要花费 15.3ms,SIFT 约花费 5228.7ms。由此可以看出,ORB在保持了特征子具有旋转、尺度不变性的同时,速度方面提升明显,对于实时性要求很高的SLAM来说是一个很好的选择。大部分特征提取都具有较好的并行性,可以通过 GPU 等设备来加速计算。经过GPU加速后的SIFT,就可以满足实时计算要求。但是,引入GPU将带来整个SLAM成本的提升。在目前的 SLAM方案中,ORB 是质量与性能之间较好的折中。</p>
<h4 id="1-2-ORB特征"><a href="#1-2-ORB特征" class="headerlink" title="1.2 ORB特征"></a>1.2 ORB特征</h4><p>ORB特征也由关键点和描述子两部分组成。它的关键点称为“Oriented FAST”,是一种改进的FAST角点。它的描述子称为BRIEF(Binary Robust Independent Elementary Feature)。提取 ORB 特征分为如下两个步骤:</p>
<ol>
<li>FAST 角点提取:找出图像中的“角点”。相较于原版的 FAST,ORB中计算了特征点的主方向,为后续的BRIEF描述子增加了旋转不变特性。</li>
<li>BRIEF 描述子:对前一步提取出特征点的周围图像区域进行描述。ORB 对BRIEF进行了一些改进,主要是指在 BRIEF中使用了先前计算的方向信息。</li>
</ol>
<p><strong>FAST 关键点</strong></p>
<p>FAST 是一种角点,主要检测局部像素灰度变化明显的地方,以速度快著称。它的思想是:如果一个像素与邻域的像素差别较大(过亮或过暗),那么它更可能是角点。相比于其他角点检测算法,FAST 只需比较像素亮度的大小,十分快捷。它的检测过程如下:</p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-07-27-20-41-15-image.png"></p>
<ol>
<li>在图像中选取像素p,假设它的亮度为Ip。</li>
<li>设置一个阈值T (比如,Ip 的20%)。</li>
<li>以像素p为中心,选取半径为3的圆上的16个像素点。</li>
<li>假如选取的圆上有连续的N个点的亮度大于 Ip + T 或小于 Ip − T,那么像素p可以被认为是特征点(N通常取12,即为 FAST-12。其他常用的 N 取值为 9 和 11,它们分别被称为FAST-9 和 FAST-11)。</li>
<li>循环以上四步,对每一个像素执行相同的操作。</li>
</ol>
<p>在 FAST-12 算法中,为了更高效,可以添加一项预测试操作,以快速地排除绝大多数不是角点的像素。具体操作为,对于每个像素,直接检测邻域圆上的第 1, 5, 9, 13 个像素的亮度。只有当这 4个像素中有 3 个同时大于 Ip + T 或小于 Ip − T 时,当前像素才有可能是一个角点,否则应该直接排除。这样的预测试操作大大加速了角点检测。此外,原始的 FAST角点经常出现“扎堆”的现象。所以在第一遍检测之后，还需要用非极大值抑制（Non-maximal suppression），在一定区域内仅保留响应极大值的角点，避免角点集中的问题。</p>
<p>FAST特征点的计算仅仅是比较像素间亮度的差异，所以速度非常快，但它也有重复性不强，分布不均匀的缺点。此外，FAST角点不具有方向信息。同时，由于它固定取半径为3的圆，存在尺度问题：远处看着像是角点的地方，接近后看可能就不是角点了。针对FAST角点不具有方向性和尺度的弱点，ORB添加了尺度和旋转的描述。尺度不变性由构建图像金字塔，并在金字塔的每一层上检测角点来实现。而特征的旋转是由灰度质心法（Intensity Centroid）实现的。 金字塔是计算图视觉中常用的一种处理方法，如下图。</p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-07-27-20-42-12-image.png"></p>
<p>金字塔底层是原始图像。每往上一层，就对图像进行一个固定倍率的缩放，这样就有了不同分辨率的图像。较小的图像可以看成是远处看过来的场景。在特征匹配算法中可以匹配不同层上的图像，从而实现尺度不变性。 例如，如果相机在后退，那么应该能够在上一个图像金字塔的上层和下一个图像的下层中找到匹配。 在旋转方面，计算特征点附近的图像灰度质心。所谓质心是指以图像块灰度值作为权重的中心。其具体操作步骤如下：</p>
<ol>
<li>在一个小的图像块B中，定义图像块的矩为</li>
</ol>
<p><img src="https://pic4.zhimg.com/80/v2-2bb2c5181d5108dc55efeae9309dbe2f_720w.jpeg"></p>
<ol start="2">
<li>通过矩可以找到图像块的质心：</li>
</ol>
<p><img src="https://pic1.zhimg.com/80/v2-c0c509ded65b7743bc6967892e08b6f0_720w.png"></p>
<ol start="3">
<li>连接图像块的几何中心O与质心 C，得到一个方向向量 OC，于是特征点的方向可以定义为</li>
</ol>
<p>$$<br>\theta &#x3D; \arctan(m_{01}&#x2F;m_{10})<br>$$</p>
<p>通过以上方法，FAST角点便具有了尺度与旋转的描述，从而大大提升了其在不同图像之间表述的鲁棒性。ORB 中，把这种改进后的FAST称为 Oriented FAST。</p>
<p>注：金字塔是指对图像进行不同层次的降采样，以获得不同分辨率的图像。</p>
<p><strong>BRIEF 描述子</strong></p>
<p>在提取 Oriented FAST 关键点后，对每个点计算其描述子。ORB使用改进的BRIEF特征描述。</p>
<p>BRIEF 是一种二进制描述子，其描述向量由许多个0和1组成，这里的0和1编码了关键点附近两个随机像素（比如 p 和 q）的大小关系：如果 p 比 q 大，则取 1，反之就取 0。如果取了 128 个这样的 p, q，最后就得到128维由 0、1 组成的向量。BRIEF 使用了随机选点的比较，速度非常快，而且由于使用了二进制表达，存储起来也十分方便，适用于实时的图像匹配。原始的 BRIEF描述子不具有旋转不变性，因此在图像发生旋转时容易丢失。而 ORB 在 FAST 特征点提取阶段计算了关键点的方向，所以可以利用方向信息，计算了旋转之后的“Steer BRIEF”特征使ORB 的描述子具有较好的旋转不变性。 由于考虑到了旋转和缩放，使得 ORB 在平移、旋转和缩放的变换下仍有良好的表现。同时，FAST和BREIF的组合也非常高效，使得ORB特征在实时SLAM中非常受欢迎。</p>
<h4 id="1-3-特征匹配"><a href="#1-3-特征匹配" class="headerlink" title="1.3 特征匹配"></a>1.3 特征匹配</h4><p><strong>特征匹配</strong>是视觉 SLAM 中极为关键的一步，解决了SLAM中的数据关联问题（data association），即确定当前看到的路标与之前看到的路标之间的对应关系。通过对图像与图像或者图像与地图之间的描述子进行准确匹配，可以为后续的姿态估计、优化等操作减轻大量负担。然而，由于图像特征的局部特性，误匹配的情况广泛存在，成为视觉SLAM中制约性能提升的一大瓶颈。部分原因是场景中经常存在大量的重复纹理，使得特征描述非常相似。在这种情况下，仅利用局部特征解决误匹配是非常困难的。</p>
<p>考虑两个时刻的图像。如果在图像It中提取到特征点</p>
<p>$$<br>x_t^m,m &#x3D; 1,2…,M<br>$$</p>
<p>在图像 It+1 中也提取到特征点xnt+1。如何寻找这两个集合元素的对应关系？最简单的特征匹配方法就是<strong>暴力匹配</strong>（Brute-Force Matcher）。即对每一个特征点 xm t 与所有的 xn t+1 测量描述子的距离，然后排序，取最近的一 个作为匹配点。描述子距离表示了两个特征之间的相似程度，不过在实际运用中还可以取不同的距离度量范数。对于浮点类型的描述子，使用<u>欧氏距离</u>进行度量即可。而对于二进制的描述子（比如BRIEF），往往使用<strong>汉明距离</strong>（Hamming distance）作为度量——两个二进制串之间的汉明距离，指的是其不同位数的个数。 然而，当特征点数量很大时，暴力匹配法的运算量将变得很大，特别是当想要匹配某个帧和一张地图的时候。这不符合在SLAM中的实时性需求。此时<u><strong>快速近似最近邻</strong></u>（FLANN）算法更加适合于匹配点数量极多的情况。这些匹配算法理论已经成熟，实现上集成到OpenCV了。</p>
<p>[47] M. Muja and D. G. Lowe, “Fast approximate nearest neighbors with automatic algorithm configuration.,” in VISAPP (1), pp. 331–340, 2009.</p>
<h3 id="2、实践：特征提取和匹配"><a href="#2、实践：特征提取和匹配" class="headerlink" title="2、实践：特征提取和匹配"></a>2、实践：特征提取和匹配</h3><p>OpenCV集成了多数主流的图像特征，可以很方便地进行调用。</p>
<h4 id="2-1-OpenCV-的-ORB-特征"><a href="#2-1-OpenCV-的-ORB-特征" class="headerlink" title="2.1 OpenCV 的 ORB 特征"></a>2.1 OpenCV 的 ORB 特征</h4><p>调用OpenCV来提取和匹配ORB。图像位于slambook2&#x2F;ch7&#x2F;下的1.png 和 2.png，可以看到相机发生了微小的运动。程序演示如何提取ORB特征并进行匹配：</p>
<blockquote>
<p>slambook&#x2F;ch7&#x2F;orb_cv.cpp</p>
</blockquote>
<p>首先要安装g2o，github下载20200410版本的:<a href="https://link.zhihu.com/?target=https://github.com/RainerKuemmerle/g2o.git">https://github.com/RainerKuemmerle/g2o.git</a></p>
<p>对ch7文件夹中的cmake工程进行编译，报错：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined reference to `vtable for fmt::v7::format_error‘</span><br></pre></td></tr></table></figure>

<p>链接上fmt 库：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target_link_libraries(&quot;可执行文件&quot; $&#123;Sophus_LIBRARIES&#125; fmt)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-08-10-12-17-19-image.png"></p>
<p>未筛选的匹配中带有大量的误匹配。经过一次筛选之后，匹配数量减少了许多，大多数匹配都是正确的。这里筛选的依据是汉明距离小于最小距离的两倍，这是一种工程上的经验方法。尽管在示例图像中能够筛选出正确的匹配，但仍然不能保证在所有其他图像中得到的匹配都是正确的。因此，在后面的运动估计中，还需要使用去除误匹配的算法。</p>
<h4 id="2-2-手写-ORB-特征"><a href="#2-2-手写-ORB-特征" class="headerlink" title="2.2 手写 ORB 特征"></a>2.2 手写 ORB 特征</h4><p>代码：slambook&#x2F;ch7&#x2F;orb_self.cpp</p>
<p>运行结果：</p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-07-27-20-58-07-image.png"></p>
<p>在计算中用256位的二进制描述，即对应到8个32位的unsigned int数据，用 typedef 将它表示成 DescType。然后计算 FAST 特征点的角度，再使用该角度计算描述子。此代码中通过三角函数的原理回避了复杂的 arctan 以及 sin、cos 计算，从而达到加速的效果。在 BfMatch 函数中还使用了 SSE 指令集中的_mm_popcnt_u32 函数来计算一个 unsigned int 变量中1的个数，从而达到计算汉明距离的效果。</p>
<p>这个程序中，通过一些简单的算法修改，对ORB的提取加速了数倍。如果对提取特征部分进一步并行化处理，算法还可以有加速的空间。</p>
<h4 id="2-3-计算相机运动"><a href="#2-3-计算相机运动" class="headerlink" title="2.3 计算相机运动"></a>2.3 计算相机运动</h4><p>有了匹配好的点对后要根据点对来估计相机的运动。</p>
<ol>
<li>当相机为单目时，只知道2D的像素坐标，因而问题是根据两组2D点估计运动。该问题用对极几何来解决。</li>
<li>当相机为双目、RGB-D 时，或者通过某种方法得到了距离信息，那么问题就是根据两组3D点估计运动。该问题通常用 ICP 来解决。</li>
<li>如果一组为 3D，一组为 2D，即得到了一些 3D 点和它们在相机的投影位置，也能估计相机的运动。该问题通过 PnP 求解。</li>
</ol>
<h3 id="3、2D−2D-对极几何-Epipolar-Geometry"><a href="#3、2D−2D-对极几何-Epipolar-Geometry" class="headerlink" title="3、2D−2D: 对极几何(Epipolar Geometry)"></a>3、2D−2D: 对极几何(Epipolar Geometry)</h3><p>描述的是两幅视图之间的内在射影关系，与外部场景无关，只依赖于摄像机内参数和这两幅试图之间的的相对姿态。</p>
<p>对极几何（Epipolar Geometry）是Structure from Motion问题中，在两个相机位置产生的两幅图像的之间存在的一种特殊几何关系，是sfm问题中2D-2D求解两帧间相机姿态的基本模型。</p>
<h4 id="3-1对极约束"><a href="#3-1对极约束" class="headerlink" title="3.1对极约束"></a>3.1对极约束</h4><p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-07-27-21-05-39-image.png"></p>
<p>如果有若干对这样的匹配点,就可以通过这些二维图像点的对应关系,恢复出在两帧之间摄像机的运动。求取两帧图像I1, I2之间的运动,设第一帧到第二帧的运动为R,t。两个相机中心分别为O1,O2。如果I1中有一个特征点p1 ,它在I2中对应着特征点p2，两者是通过特征匹配得到的。如果匹配正确,说明它们是同一个空间点在两个成像平面上的投影。首先,连线O1p1和连线O2p2在三维空间中会相交于点P。这时候点O1, O2 ,P三个点可以确定一个平面,称为<u><strong>极平面(Epipolar plane)</strong></u> 。O1O2连线与像平面I1, I2 的交点分别为 e1, e2 。e1, e2 称为<strong>极点(Epipoles)</strong> ,O1O2被称为<strong>基线(Baseline)</strong> 。称极平面与两个像平面 I1, I2之间的相交线 L1, L2<strong>极线(Epipolar line)</strong> 。</p>
<p>直观讲,从第一帧的角度看,射线O1p1是某个像素可能出现的空间位置——因为该射线上的所有点都会投影到同一个像素点。同时,如果不知道P的位置,那么当在第二幅图像上看时,连线e2p2(也就是第二幅图像中的极线)就是P可能出现的投影的位置,也就是射线O1p1在第二个相机中的投影。<u>由于通过特征点匹配确定了p2的像素位置,所以能够推断P的空间位置,以及相机的运动。</u>如果没有特征匹配，就没法确定p2到底在极线的哪个位置了。</p>
<p>从代数角度来看一下这里的几何关系。在第一帧的坐标系下,设P的空间位置为P &#x3D; [X, Y, Z]T.根据<u>针孔相机模型</u>知道两个像素点 p1, p2的像素位置为：</p>
<p><img src="https://pic2.zhimg.com/80/v2-60418d4de716bc993fc81d38a9059859_720w.jpeg"></p>
<p>这里K为相机内参矩阵,R, t 为两个坐标系的相机运动。具体来说,这里计算的是 R21和 t21 ,因为是把第一个坐标系下的坐标转换到第二个坐标系下。在使用齐次坐标时,一个向量等于它自身乘上任意的非零常数。这通常用于表达一个投影关系。例如 s1p1 和 p1 成投影关系,它们在齐次坐标的意义下是相等的。称这种相等关系为尺度意义下相等(equal up to a scale),记作:sp ≃ p.那么,上述两个投影关系可写为:p1 ≃ KP ,p2 ≃ K(RP + t) .现在取:</p>
<p><img src="https://pic1.zhimg.com/80/v2-269d982e741ccc0cebd959b06a8aada0_720w.jpeg"></p>
<p>这里的x1,x2是两个像素点的归一化平面上的坐标。代入上式,得:x2 ≃ Rx1 + t.</p>
<p>两边同时左乘 t∧ 。根据∧的定义,这相当于两侧同时与t做外积:</p>
<p><img src="https://pic1.zhimg.com/80/v2-238d97667a8d232ee294492c08606ea0_720w.jpeg"></p>
<p>然后,两侧同时左乘</p>
<p><img src="https://pic3.zhimg.com/80/v2-24bec599547353e62035677688a357b2_720w.jpeg"></p>
<p>得：</p>
<p><img src="https://pic2.zhimg.com/80/v2-e8a701b2be82d4859518b63d78e90f3d_720w.jpeg"></p>
<p>观察等式左侧</p>
<p><img src="https://pic1.zhimg.com/80/v2-107f489907c5a60930c82d784cb6185c_720w.jpeg"></p>
<p>是一个与 t 和x2都垂直的向量。把它再和x2做内积时,将得到0。由于等式左侧严格为零,那么乘以任意非零常数之后也为零,于是可以把 ≃ 写成通常的等号。因此,就得到了:</p>
<p><img src="https://pic1.zhimg.com/80/v2-93ddf5a091ecf31c2280d68bdbb0d158_720w.jpeg"></p>
<p>重新代入 p1, p2 ,有:</p>
<p><img src="https://pic1.zhimg.com/80/v2-92c6617d75953754bac43a0b5f06ced4_720w.png"></p>
<p>这两个式子都称为对极约束。它的几何意义是O1, P, O2三者共面。对极约束中同时包含了平移和旋转。把中间部分记作两个矩阵:基础矩阵(Fundamental Matrix)F和本质矩阵(Essential Matrix)E,于是可以进一步简化对极约束:</p>
<p><img src="https://pic3.zhimg.com/80/v2-242bc2f4d0b5e1f92586b049667a792e_720w.png"></p>
<p>对极约束简洁地给出了两个匹配点的空间位置关系。于是,<mark>相机位姿估计</mark>问题变为以下两步:</p>
<ol>
<li>根据配对点的像素位置求出 E 或者 F 。</li>
<li>根据E或者F求出 R, t。由于 E 和 F 只相差了相机内参,而内参在SLAM中通常是已知的,所以实践当中往往使用形式更简单的E。</li>
</ol>
<h4 id="3-2本质矩阵E"><a href="#3-2本质矩阵E" class="headerlink" title="3.2本质矩阵E"></a>3.2本质矩阵E</h4><p>根据定义,本质矩阵 E &#x3D; t∧R。它是一个3 × 3的矩阵,内有 9 个未知数。从E的构造方式上看,有以下值得注意的地方:</p>
<p>• 本质矩阵是由对极约束定义的。由于对极约束是等式为零的约束,所以对E乘以任意非零常数后,对极约束依然满足。这称为E在不同尺度下是等价的。</p>
<p>• 根据 E &#x3D; t∧R,可以证明,本质矩阵E的奇异值必定是 [σ, σ, 0]T的形式。这称为本质矩阵的内在性质。</p>
<p>• 另一方面,由于平移和旋转各有 3 个自由度,故 t∧R 共有 6 个自由度。但由于尺度等价性,故 E 实际上有 5 个自由度。表明最少可以用5对点来求解E。但是,E的内在性质是一种非线性性质,在估计时会带来麻烦,因此,也可以只考虑它的尺度等价性,使用8对点来估计E——这就是经典的八点法(Eight-point-algorithm) 。八点法只利用了E的线性性质,因此可以在线性代数框架下求解。</p>
<p>考虑一对匹配点,它们的归一化坐标为 x1&#x3D; [u1 , v1 , 1] T , x2 &#x3D; [u2 , v2 , 1] T 。根据对极约束,有:</p>
<p><img src="https://pic1.zhimg.com/80/v2-42a6f9323a0945ed1e79525da7ec0008_720w.jpg"></p>
<p>把矩阵 E 展开,写成向量的形式:e &#x3D; [e1 , e2 , e3 , e4 , e5 , e6 , e7 , e8 , e9 ] T ,那么对极约束可以写成与e有关的线性形式:[u1u2 , u1v2 , u1, v1u2, v1v2, v1, u2, v2, 1] ·e &#x3D; 0.同理,对于其他点对也有相同的表示。把所有点都放到一个方程中,变成线性方程组(ui , vi 表示第 i 个特征点，以此类推）：</p>
<p><img src="https://pic2.zhimg.com/80/v2-23042be2006636aa338aa444238848bd_720w.jpg"></p>
<p>这八个方程构成了一个线性方程组。它的系数矩阵由特征点位置构成，大小为 8 × 9。 e 位于该矩阵的零空间中。如果系数矩阵是满秩的（即秩为 8），那么它的零空间维数为 1， 也就是 e 构成一条线。这与 e 的尺度等价性是一致的。如果八对匹配点组成的矩阵满足秩为 8 的条件，那么E的各元素就可由上述方程解得。</p>
<p>接下来的问题是如何根据已经估得的本质矩阵E，恢复出相机的运动 R, t。这个过程是由奇异值分解（SVD）得到的。设 E 的 SVD 分解为：</p>
<p><img src="https://pic2.zhimg.com/80/v2-67c5f5deb9001eaf1bee15a24e697dd1_720w.jpeg"></p>
<p>其中 U,V 为正交阵，Σ 为奇异值矩阵。根据 E 的内在性质，可以知道 Σ &#x3D; diag(σ, σ, 0)。 在 SVD 分解中，对于任意一个 E，存在两个可能的 t, R 与它对应：</p>
<p><img src="https://pic2.zhimg.com/80/v2-bbd92d3e42f50e40411d6385fa8714e9_720w.jpg"></p>
<p>其中</p>
<p><img src="https://pic3.zhimg.com/80/v2-10b6f2f50b84d9b608f4c90eb0eddb2e_720w.jpeg"></p>
<p>表示沿 Z 轴旋转 90 度得到的旋转矩阵。同时，由于 −E 和 E 等价，所以对任意一个 t 取负号，也会得到同样的结果。因此，从 E 分解到 t, R 时，一共存在四个可能的解。只有第一种解中，P 在两个相机中都具有正的深度。因此，只要把任意一点代入四种解中，检测该点在两个相机下的深度，就可以确定哪个解是正确的了。</p>
<p>如果利用 E 的内在性质，那么它只有五个自由度。所以最小可以通过五对点来求解相机运动。然而这种做法形式复杂，从工程实现角度考虑，由于平时通常会有几十对乃至上百对的匹配点，从八对减至五对意义并不明显。剩下的问题还有一个：根据线性方程解出的 E，可能不满足 E 的内在性质——它的奇异值不一定为 σ, σ, 0 的形式。这时，在做 SVD 时会刻意地把 Σ 矩阵调整成上面的样子。通常的做法是，对八点法求得的 E 进行 SVD 分解后，会得到奇异值矩阵 Σ &#x3D; diag(σ1, σ2, σ3)，不妨设 σ1 ≥ σ2 ≥ σ3。取：</p>
<p><img src="https://pic4.zhimg.com/80/v2-1696fab00f8963728b320f65c7922953_720w.jpeg"></p>
<p>这相当于是把求出来的矩阵投影到了 E 所在的流形上。更简单的做法是将奇异值矩阵取成 diag(1, 1, 0)，因为 E 具有尺度等价性，这样做也是合理的。</p>
<h4 id="3-3单应矩阵"><a href="#3-3单应矩阵" class="headerlink" title="3.3单应矩阵"></a>3.3单应矩阵</h4><p>单应矩阵（Homography）H ，描述了两个平面之间的映射关系。若场景中的特征点都落在同一平面上（比如墙，地面等），则可以通过单应性来进行运动估计。这种情况在无人机携带的俯视相机，或扫地机携带的顶视相机中比较常见。单应矩阵通常描述处于共同平面上的一些点，在两张图像之间的变换关系。考虑在图像I1和I2有一对匹配好的特征点p1和p2。这些特征点落在某平面上。设这个平面满足方程：</p>
<p><img src="https://pic2.zhimg.com/80/v2-82db91c1372750af642f6f3b858abe1d_720w.jpeg"></p>
<p>然后代入</p>
<p><img src="https://pic2.zhimg.com/80/v2-60418d4de716bc993fc81d38a9059859_720w.jpeg"></p>
<p>得：</p>
<p><img src="https://pic1.zhimg.com/80/v2-f4bea2b37992329b43661b4484aa319c_720w.jpg"></p>
<p>把直接描述图像坐标 p1 和 p2 之间的变换的中间这部分记为 H，于是 p2 &#x3D; Hp1。它的定义与旋转、平移以及平面的参数有关。单应矩阵H是一个 3 × 3 的矩阵，求解时的思路可以先根据匹配点计算H，然后将它分解以计算旋转和平移。把上式展开，得：</p>
<p><img src="https://pic3.zhimg.com/80/v2-9208fe3121abeb5a4bb276aea2156f26_720w.jpg"></p>
<p>注意这里的等号是在非零因子下成立的。在实际处理中，通常乘以一个非零因子使得 h9 &#x3D; 1（在它取非零值时）。然后根据第三行，去掉这个非零因子，于是有：</p>
<p><img src="https://pic4.zhimg.com/80/v2-bc5fc5d06b417cb0ef98a5ce0f24df83_720w.jpg"></p>
<p>这样一组匹配点对就可以构造出两项约束（事实上有三个等式，但是因为线性相关，只取前两个），于是自由度为 8 的单应矩阵可以通过 4 对匹配特征点算出（注意：这些特征点不能有三点共线的情况），即求解以下的线性方程组（当 h9 &#x3D; 0 时，右侧为零）：</p>
<p><img src="https://pic2.zhimg.com/80/v2-ab831fbbff069ffb18e3a120880e445d_720w.jpg"></p>
<p>这种做法把H矩阵看成了向量，通过解该向量的线性方程来恢复H，又称直接线性变换法（Direct Linear Transform）。求出单应矩阵以后需要对其进行分解，才可以得到相应的旋转矩阵 R 和平移向量 t。分解的方法包括数值法与解析法 。单应矩阵的分解会返回四组旋转矩阵与平移向量，并且同时可以计算出它们分别对应的场景点所在平面的法向量。如果已知成像的地图点的深度全为正值（即在相机前方），则又可以排除两组解。最后仅剩两组解，这时需要通过更多的先验信息进行判断。通常可以通过假设已知场景平面的法向量来解决，如场景平面 与相机平面平行，那么法向量n的理论值为1。</p>
<p>单应性在 SLAM 中具有重要意义。当特征点共面，或者相机发生纯旋转的时候，基础矩阵的自由度下降，这就出现了所谓的退化（degenerate）。现实中的数据总包含一些噪声， 这时候如果继续使用八点法求解基础矩阵，基础矩阵多余出来的自由度将会主要由噪 声决定。为了能够避免退化现象造成的影响，通常会同时估计基础矩阵 F 和单应矩阵 H，选择重投影误差比较小的那个作为最终的运动估计矩阵。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>2D-2D的情况下，只知道图像坐标之间的对应关系</p>
<ul>
<li><p>特征点在平面上的时候，使用H恢复R,t</p>
</li>
<li><p>否则，使用E(相机内参已知，更方便，也更常用)或者F恢复R，t</p>
</li>
</ul>
<p>求得R，t之后</p>
<ul>
<li>利用三角化计算特征点的3D位置（深度）</li>
</ul>
<h3 id="4、实践：对极约束求解相机运动-pose-esti-2d2d"><a href="#4、实践：对极约束求解相机运动-pose-esti-2d2d" class="headerlink" title="4、实践：对极约束求解相机运动(pose_esti_2d2d)"></a>4、实践：对极约束求解相机运动(pose_esti_2d2d)</h3><p>如何通过 Essential 矩阵求解相机运动？</p>
<p>使用匹配好的特征点来计算 E,F 和 H，进而分解 E 得 到 R, t。整个程序使用 OpenCV 提供的算法进行求解。</p>
<blockquote>
<p>代码：slambook&#x2F;ch7&#x2F;pose_estimation_2d2d.cpp</p>
</blockquote>
<p>pose_estimation_2d2d函数提供了从特征点求解相机运动的部分，在函数中输出了 E,F 和 H 的数值，然后验证对极约束是否成立，以及 t ∧R 和 E 在非零数乘下等价的事实。调用此程序的输出结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">build/pose_estimation_2d2d 1.png 2.png</span><br><span class="line">-- Max dist : 95.000000</span><br><span class="line">-- Min dist : 4.000000</span><br><span class="line">一共找到了 79 组匹配点</span><br><span class="line">fundamental_matrix is</span><br><span class="line">[4.844484382466111e-06, 0.0001222601840188731, -0.01786737827487386;</span><br><span class="line">-0.0001174326832719333, 2.122888800459598e-05, -0.01775877156212593;</span><br><span class="line">0.01799658210895528, 0.008143605989020664, 1]</span><br><span class="line">essential_matrix is</span><br><span class="line">[-0.0203618550523477, -0.4007110038118445, -0.03324074249824097;</span><br><span class="line">0.3939270778216369, -0.03506401846698079, 0.5857110303721015;</span><br><span class="line">-0.006788487241438284, -0.5815434272915686, -0.01438258684486258]</span><br><span class="line">homography_matrix is</span><br><span class="line">[0.9497129583105288, -0.143556453147626, 31.20121878625771;</span><br><span class="line">0.04154536627445031, 0.9715568969832015, 5.306887618807696;</span><br><span class="line">-2.81813676978796e-05, 4.353702039810921e-05, 1]</span><br><span class="line">R is</span><br><span class="line">[0.9985961798781875, -0.05169917220143662, 0.01152671359827873;</span><br><span class="line">0.05139607508976055, 0.9983603445075083, 0.02520051547522442;</span><br><span class="line">-0.01281065954813571, -0.02457271064688495, 0.9996159607036126]</span><br><span class="line">t is</span><br><span class="line">[-0.8220841067933337;</span><br><span class="line">-0.03269742706405412;</span><br><span class="line">0.5684264241053522]</span><br><span class="line">​</span><br><span class="line">t^R=</span><br><span class="line">[0.02879601157010516, 0.5666909361828478, 0.04700950886436416;</span><br><span class="line">-0.5570970160413605, 0.0495880104673049, -0.8283204827837456;</span><br><span class="line">0.009600370724838804, 0.8224266019846683, 0.02034004937801349]</span><br><span class="line">epipolar constraint = [0.002528128704106625]</span><br><span class="line">epipolar constraint = [-0.001663727901710724]</span><br><span class="line">epipolar constraint = [-0.0008009088410884102</span><br></pre></td></tr></table></figure>

<p>可以看出，对极约束的满足精度约在 10−3 量级。OpenCV 使用三角化检测角点的深度是否为正，从而选出正确的解。 对极约束是从 x2 &#x3D; Rx1 + t 得到的。这里的 R, t 组成的变换矩阵，是第一个图到第二个图的坐标变换矩阵： x2 &#x3D; T21x1.</p>
<h4 id="4-1-讨论"><a href="#4-1-讨论" class="headerlink" title="4.1 讨论"></a>4.1 讨论</h4><p>从演示程序中可以看到，输出的 E 和 F 相差了相机内参矩阵。从 E,F 和 H 都可以分解出运动，不过 H 需要假设特征点位于平面上。 由于 E 本身具有尺度等价性，它分解得到的 t, R 也有一个尺度等价性。而 R ∈ SO(3) 自身具有约束，所以认为 t 具有一个尺度。换言之，在分解过程中，对 t 乘以任意非零常数，分解都是成立的。因此通常把 t 进行归一化，让它的长度等于 1。</p>
<p><strong>尺度不确定性</strong></p>
<p>对 t 长度的归一化，直接导致了单目视觉的尺度不确定性（Scale Ambiguity）。例如，程序中输出的 t 第一维约 0.822。这个 0.822 究竟是指 0.822 米呢，还是 0.822 厘米 呢，是没法确定的。因为对 t 乘以任意比例常数后，对极约束依然是成立的。换言之， 在单目 SLAM 中，对轨迹和地图同时缩放任意倍数，得到的图像依然是一样的。 在单目视觉中，对两张图像的 t 归一化，相当于固定了尺度。虽然不知道它的实际长度为多少，但以这时的 t 为单位 1，计算相机运动和特征点的 3D 位置。这被称为单目 SLAM 的初始化。在初始化之后，就可以用 3D-2D 来计算相机运动了。初始化之后的轨迹和地图的单位，就是初始化时固定的尺度。因此，单目 SLAM 有一步不可避免的初始化。初始化的两张图像必须有一定程度的平移，而后的轨迹和地图都将以此步的平移为单位。 除了对 t 进行归一化之外，另一种方法是令初始化时所有的特征点平均深度为 1，也 可以固定一个尺度。相比于令 t 长度为 1 的做法，把特征点深度归一化可以控制场景的规模大小，使计算在数值上更稳定些。</p>
<p><strong>初始化的纯旋转问题</strong></p>
<p>从 E 分解到 R, t 的过程中，如果相机发生的是纯旋转，导致 t 为零，那么，得到的 E 也将为零，这将导致无从求解 R。不过，此时可以依靠 H 求取旋转，但仅有旋转时，无法用三角测量估计特征点的空间位置，于是，另一个结论是，单目初始化不能只有纯旋转，必须要有一定程度的平移。如果没有平移，单目将无法初始化。在实践当中，如果初始化时平移太小，会使得位姿求解与三角化结果不稳定， 从而导致失败。相对的，如果把相机左右移动而不是原地旋转，就容易让单目 SLAM 初始化。</p>
<p><strong>多于八对点的情况</strong></p>
<p>当给定的点数多于八对时，可以计算一个最小二乘解。对于线性化后的对极约束，我们把左侧的系数矩阵记为 A： Ae &#x3D; 0</p>
<p>对于八点法，A 的大小为 8 × 9。如果给定的匹配点多于 8，该方程构成一个超定方程，即不一定存在 e 使得上式成立。因此，可以通过最小化一个二次型来求：</p>
<p>于是就求出了在最小二乘意义下的 E 矩阵。不过，当可能存在误匹配的情况时，会更倾向于使用随机采样一致性（Random Sample Concensus, RANSAC）来求，而不是最小二乘。RANSAC 是一种通用的做法，适用于很多带错误数据的情况，可以处理带有错误匹配的数据。</p>
<h3 id="5、三角测量（三角化）"><a href="#5、三角测量（三角化）" class="headerlink" title="5、三角测量（三角化）"></a>5、三角测量（三角化）</h3><p>使用对极几何约束估计了相机运动之后，下一步需要用相机的运动估计特征点的空间位置。在单目SLAM中，仅通过单张图像无法获得像素的深度信息，需要通过三角测量（Triangulation）（或三角化）的方法来估计地图点的深度。</p>
<p>三角测量是指，通过在两处观察同一个点的夹角，确定该点的距离。三角测量最早由高斯提出并应用于测量学中，它在天文学、地理学的测量中都有应用。例如可以通过不同季节观察到星星的角度，估计它离我们的距离。在SLAM中主要用三角化来估计像素点的距离。</p>
<img src="/2022/07/27/Course/SLAM/ch07_vo/2022-07-27-21-11-59-image.png" title alt width="347">

<p>考虑图像 I1 和 I2，以左图为参考，右图的变换矩阵为 T。相机光心 为 O1 和 O2。在 I1 中有特征点 p1，对应 I2 中有特征点 p2。理论上直线 O1p1 与 O2p2 在场景中会相交于一点 P，该点即是两个特征点所对应的地图点在三维场景中的位置。然而由于噪声的影响，这两条直线往往无法相交。因此可以通过最二小乘去求解。 按照对极几何中的定义，设 x1, x2 为两个特征点的归一化坐标，那么它们满足： s1x1 &#x3D; s2Rx2 + t.</p>
<p>已知 R, t，想要求解的是两个特征点的深度 s1, s2。这两个深度是可以分开求的，先算s2，那么先对上式两侧左乘一个 $ \hat{x_1} $得：</p>
<p>$$<br>s_1 \hat{x_1} x_1 &#x3D; 0 &#x3D; s_2 \hat{x_1} R x_2 + \hat{x_1} t<br>$$</p>
<p>该式左侧为零，右侧可看成 s2 的一个方程，可以根据它直接求得 s2。有了 s2，s1也可以求出。于是就得到了两个帧下的点的深度，确定了它们的空间坐标。由于噪声的存在，估得的 R, t不一定精确使方程为0，所以更常见的做法求最小二乘解而不是零解。</p>
<h3 id="6、实践：三角测量"><a href="#6、实践：三角测量" class="headerlink" title="6、实践：三角测量"></a>6、实践：三角测量</h3><h4 id="6-1-三角测量代码"><a href="#6-1-三角测量代码" class="headerlink" title="6.1 三角测量代码"></a>6.1 三角测量代码</h4><p>代码演示了对之前根据对极几何求解的相机位姿通过三角化求出特征点的空间位置。调用 OpenCV 提供的 triangulation 函数进行三角化。</p>
<blockquote>
<p>代码为：slambook&#x2F;ch7&#x2F;triangulation.cpp</p>
</blockquote>
<p>同时在 main 函数中增加三角测量部分，并验证重投影关系。</p>
<p>代码输出某特征点的信息：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">point in the first camera frame: [0.0844072, -0.0734976]</span><br><span class="line">point projected from 3D [0.0843702, -0.0743606], d=14.9895</span><br><span class="line">point in the second camera frame: [0.0431343, -0.0459876]</span><br><span class="line">point reprojected from second frame: [0.04312769812378599, -0.04515455276163744, 1]</span><br></pre></td></tr></table></figure>

<p>打印了每个空间点在两个相机坐标系下的投影坐标与像素坐标。这里对于这个特征点来说，通过两个图像下的一对像素坐标的三角化，能得到这个特征点的空间坐标，d为深度，利用这个空间坐标重投影能得到一个投影坐标，跟原始的像素坐标相比有一定的误差。由于误差的存在，它们会有一些微小的差异。误差的量级大约在小数点后第三位。可以看到，三角化特征点的距离大约为 15。但由于尺度不确定性，并不知道这里的 15 究竟是多少米。</p>
<h4 id="6-2-讨论"><a href="#6-2-讨论" class="headerlink" title="6.2 讨论"></a>6.2 讨论</h4><p>三角测量是由平移得到的，有平移才会有对极几何中的三角形，才谈的上三角测量。因此，纯旋转是无法使用三角测量的，因为对极约束将永远满足。在平移存在的情况下，还要关心三角测量的不确定性，这会引出一个三角测量的矛盾。</p>
<p><img src="https://pic2.zhimg.com/80/v2-0898591301902bce4c7348bc6ee1eb21_720w.jpg"></p>
<p>如图所示。当平移很小时，像素上的不确定性将导致较大的深度不确定性。也就是说，如果特征点运动一个像素 δx，使得视线角变化了一个角度 δθ，那么测量到深度值将有 δd 的变化。从几何关系可以看到，当 t 较大时，δd 将明显变小，这说明平移较大时， 在同样的相机分辨率下，三角化测量将更精确。对该过程的定量分析可以使用正弦定理得到，但这里先考虑定性分析。 因此，要增加三角化的精度，其一是提高特征点的提取精度，也就是提高图像分辨率 ——但这会导致图像变大，提高计算成本。另一方式是使平移量增大。但是，平移量增大会导致图像的外观发生明显的变化，比如箱子原先被挡住的侧面显示出来了，比如反射光发生变化了，等等。外观变化会使得特征提取与匹配变得困难。总而言之，增大平移，会导致匹配失效；而平移太小，则三角化精度不够——这就是三角化的矛盾。</p>
<p>拓展：定量地计算每个特征点的位置及不确定性。假设特征点服从高斯分布，并且对它不断地进行观测，在信息正确的情况下，就能够期望它的方差会不断减小乃至收敛。这就得到了一个滤波器，称为深度滤波器（Depth Filter）。</p>
<h3 id="7、3D-2D-PnP"><a href="#7、3D-2D-PnP" class="headerlink" title="7、3D-2D: PnP"></a>7、3D-2D: PnP</h3><p>PnP（Perspective-n-Point）是求解 3D 到 2D 点对运动的方法。它描述了当知道 n 个 3D 空间点以及它们的投影位置时，如何估计相机所在的位姿。前面的2D-2D 的对极几何方法需要八个或八个以上的点对（以八点法为例），且存在着初始化、纯旋转和尺度的问题。然而，如果两张图像中，其中一张特征点的 3D 位置已知，那么最少只需三个点对（需要至少一个额外点验证结果）就可以估计相机运动。特征点的 3D 位置可以由三角化，或者由RGB-D 相机的深度图确定。因此，在双目或 RGB-D 的视觉里程计中， 可以直接使用 PnP 估计相机运动。而在单目视觉里程计中，必须先进行初始化，然后才能使用 PnP。3D-2D 方法不需要使用对极约束，又可以在很少的匹配点中获得较好的运动估计，是最重要的一种姿态估计方法。 PnP 问题有很多种求解方法，例如用三对点估计位姿的P3P，直接线性变换（DLT）， EPnP（Efficient PnP），UPnP等等。此外，还能用非线性优化的方式，构建最小二乘问题并迭代求解，也就是万金油式的 Bundle Adjustment。</p>
<h4 id="7-1-直接线性变换"><a href="#7-1-直接线性变换" class="headerlink" title="7.1 直接线性变换"></a>7.1 直接线性变换</h4><p>考虑某个空间点 P，它的齐次坐标为 P &#x3D; (X, Y, Z, 1)T。在图像 I1 中，投影到特征点 x1 &#x3D; (u1, v1, 1)T（以归一化平面齐次坐标表示）。此时相机的位姿 R, t 是未知的。与单应矩阵的求解类似，定义增广矩阵 [R|t] 为一个 3 × 4 的矩阵，包含了旋转与平移信息。展开形式列写如下：</p>
<p><img src="https://pic1.zhimg.com/80/v2-3205b8283c3adb0362144b1337fad0ec_720w.jpg"></p>
<p>用最后一行把 s 消去，得到两个约束：</p>
<p><img src="https://pic4.zhimg.com/80/v2-4444754ad2323dcff172b629a972847f_720w.jpg"></p>
<p>定义 T 的行向量： t1 &#x3D; (t1, t2, t3, t4) T , t2 &#x3D; (t5, t6, t7, t8) T , t3 &#x3D; (t9, t10, t11, t12) T , 于是有：</p>
<p><img src="https://pic4.zhimg.com/80/v2-5e54e6b1e42fd79bb1bcf8b97bd316c3_720w.jpg"></p>
<p><img src="https://pic1.zhimg.com/80/v2-451fba6cae9d663a44c43e79896ee300_720w.jpg"></p>
<p>t 是待求的变量，可以看到每个特征点提供了两个关于 t 的线性约束。假设一共有 N 个特征点，可以列出线性方程组：</p>
<p><img src="https://pic4.zhimg.com/80/v2-aabfea4602718fb90bc349b26739246b_720w.jpg"></p>
<p>由于 t 一共有 12 维，因此最少通过六对匹配点，即可实现矩阵 T 的线性求解，这种方法称为直接线性变换（Direct Linear Transform，DLT）。当匹配点大于六对时，可以使用 SVD 等方法对超定方程求最小二乘解。 在 DLT 求解中，直接将 T 矩阵看成了 12 个未知数，忽略了它们之间的联系。因为旋转矩阵 R ∈ SO(3)，用 DLT 求出的解不一定满足该约束，它是一个一般矩阵。平移向量属于向量空间，对于旋转矩阵 R，必须针对 DLT 估计的 T 的左边寻找一个最好的旋转矩阵对它进行近似。这可以由 QR 分解完成， 相当于把结果从矩阵空间重新投影到 SE(3) 流形上，转换成旋转和平移两部分。 这里的 x1 使用了归一化平面坐标，去掉了内参矩阵 K 的影响 ——这是因为内参 K 在 SLAM 中通常假设为已知。如果内参未知，也能用 PnP 去估计 K, R, t 三个量。然而由于未知量的增多，效果会差一些。</p>
<h4 id="7-7-2-P3P"><a href="#7-7-2-P3P" class="headerlink" title="7.7.2 P3P"></a>7.7.2 P3P</h4><p>P3P仅使用三对匹配点，对数据要求较少，需要利用给定的三个点的几何关系。它的输入数据为三对 3D-2D 匹配点。记 3D 点为 A, B, C，2D 点为 a, b, c，其中小写字母代表的点为大写字母在相机成像平面上的投影，如图所示。</p>
<p><img src="https://pic3.zhimg.com/80/v2-9972bb08f1144f15b06f2e6b353f62d2_720w.jpg"></p>
<p>此外，P3P 还需要使用一对验证点，以从可能的解出选出正确的那一个（类似于对极几何情形）。记验证点对为 D − d，相机光心为 O。注意，预知的是 A, B, C 在世界坐标系中的坐标，而不是在相机坐标系中的坐标。一旦3D 点在相机坐标系下的坐标能够算出，就得到了 3D-3D 的对应点，把 PnP 问题转换为了 ICP 问题。三角形之间存在对应关系：</p>
<p><img src="https://pic4.zhimg.com/80/v2-ecc391b9ed5bebbe4eb9345a177e0cbb_720w.jpg"></p>
<p>利用余弦定理，有：</p>
<p><img src="https://pic4.zhimg.com/80/v2-b638fc48535642d88f81db269f2268ef_720w.jpg"></p>
<p>对上面三式全体除以</p>
<p><img src="https://pic4.zhimg.com/80/v2-ce4441b058fb614d11b7dd164d7aff83_720w.jpg"></p>
<p>并且记 x &#x3D; OA&#x2F;OC, y &#x3D; OB&#x2F;OC，得：</p>
<p><img src="https://pic4.zhimg.com/80/v2-5cf7666ccdd340d1729123af072083e3_720w.jpg"></p>
<p>记</p>
<p><img src="https://pic4.zhimg.com/80/v2-4eeb14bec1f659af1137b0f58634c7ef_720w.jpg"></p>
<p>有：</p>
<p><img src="https://pic4.zhimg.com/80/v2-a555dc908de15a281e52a8c290f99b5f_720w.jpg"></p>
<p>化为：</p>
<p><img src="https://pic4.zhimg.com/80/v2-3b1d9e30cb6560470f40304198e4145b_720w.jpg"></p>
<p>由于知道 2D 点的图像位置，三个余弦角 cos⟨a, b⟩, cos⟨b, c⟩, cos⟨a, c⟩ 是已知的。同时，</p>
<p><img src="https://pic1.zhimg.com/80/v2-171af7b397753d141348cee0bf65f744_720w.jpg"></p>
<p>可以通过 A, B, C 在世界坐标系下的坐标算出，变换到相机坐标系下之后，并不改变这个比值。该式中的 x, y 是未知的，随着相机移动会发生变化。因此，该方程组是关于 x, y 的一个二元二次方程（多项式方程）。解析地求解该方程组是一个复杂的过程，需要用吴消元法。类似于分解 E 的情况，该方程最多可能得到四个解，但可以用验证点来计算最可能的解，得到 A, B, C 在相机坐标系下的 3D 坐标。然后，根据 3D-3D 的点对，计算相机的运动 R, t。</p>
<p>从 P3P 的原理上可以看出，为了求解 PnP，利用了三角形相似性质，求解投影点 a, b, c 在相机坐标系下的 3D 坐标，最后把问题转换成一个 3D 到 3D 的位姿估计问题。</p>
<p>P3P 也存在着一些问题：</p>
<ol>
<li><p>P3P 只利用三个点的信息。当给定的配对点多于 3 组时，难以利用更多的信息。</p>
</li>
<li><p>如果 3D 点或 2D 点受噪声影响，或者存在误匹配，则算法失效。 所以后续人们还提出了许多别的方法，如 EPnP、UPnP 等。它们利用更多的信息，而且用迭代的方式对相机位姿进行优化，以尽可能地消除噪声的影响。在 SLAM 当中，通常的做法是先使用 P3P&#x2F;EPnP 等方法估计相机位姿，然后构建最小二乘优化问题对估计值进行调整（Bundle Adjustment）。</p>
</li>
</ol>
<h4 id="7-3-Bundle-Adjustment"><a href="#7-3-Bundle-Adjustment" class="headerlink" title="7.3 Bundle Adjustment"></a>7.3 Bundle Adjustment</h4><p>除了使用线性方法之外，可以把 PnP 问题构建成一个定义于李代数上的非线性最小二乘问题。前面说的线性方法，往往是先求相机位姿，再求空间点位置，而非线性优化则是把它们都看成优化变量，放在一起优化。这是一种非常通用的求解方式，可以用它对 PnP 或 ICP 给出的结果进行优化。在 PnP 中， 这个 Bundle Adjustment 问题，是一个最小化重投影误差（Reprojection error）的问题。</p>
<p>考虑 n 个三维空间点 P 和它们的投影 p，希望计算相机的位姿 R, t，它的李代数表示为 ξ。假设某空间点坐标为 Pi &#x3D; [Xi , Yi , Zi ]T，其投影的像素坐标为 ui &#x3D; [ui , vi ]T。 像素位置与空间点位置的关系如下：</p>
<p><img src="https://pic1.zhimg.com/80/v2-db49cbda15dfdb45aa13bdbc05a25300_720w.jpg"></p>
<p>写成矩阵形式是：</p>
<p><img src="https://pic4.zhimg.com/80/v2-e4b09b8de757e4711a5200021b14cedb_720w.jpg"></p>
<p>中间隐含着齐次坐标到非齐次的转换，否则按矩阵的乘法来说，维度是不对的。因为exp (ξ∧) Pi 结果是 4 × 1 的，而它左侧的 K 是 3 × 3 的，所以必须把 exp (ξ ∧) Pi 的前三维取出来，变成三维的非齐次坐标。 现在，由于相机位姿未知以及观测点的噪声，该等式存在一个误差。因此把误差求和，构建最小二乘问题，然后寻找最好的相机位姿，使它最小化：</p>
<p><img src="https://pic1.zhimg.com/80/v2-cbb547095bb296a8c5bc29dedac9dcbc_720w.jpg"></p>
<p>该问题的误差项，是将像素坐标（观测到的投影位置）与 3D 点按照当前估计的位姿进行投影得到的位置相比较得到的误差，所以称之为重投影误差。使用齐次坐标时，这个误差有 3 维。不过，由于u最后一维为 1，该维度的误差一直为零，因而更多时候使用非齐次坐标，于是误差就只有 2 维了。</p>
<p>如图所示，通过特征匹配，知道了 p1 和 p2 是同一个空间点 P 的投影，但是不知道相机的位姿。在初始值中，P 的投影 pˆ2 与实际的 p2 之间有一定的距离。于是调整相机的位姿，使得这个距离变小。不过，由于这个调整需要考虑很多个点，所以最后每个点的误差通常都不会精确为零。</p>
<p><img src="https://pic4.zhimg.com/80/v2-ea7c0b6605168af39435a0293a1ba593_720w.jpg"></p>
<p>使用李代数，可以构建无约束的优化问题， 很方便地通过 G-N, L-M 等优化算法进行求解。不过，在使用 G-N 和 L-M 之前，需要知道每个误差项关于优化变量的导数，也就是线性化： e(x + ∆x) ≈ e(x) + J∆x.</p>
<p>这里的 J 的形式是关键所在。固然可以使用数值导数，但如果能够推导解析形式时，会优先考虑解析导数。现在，当 e 为像素坐标误差 （2 维），x 为相机位姿（6 维）时，J 将是一个 2 × 6 的矩阵。</p>
<p>使用扰动模型来求李代数的导数：</p>
<p>首先，记变换到相机坐标系下的空间点坐标为 P′，并且将其前三维取出来： P′ &#x3D; (exp (ξ∧)P)1:3 &#x3D; [X′,Y′,Z′]T</p>
<p>相机投影模型相对于P′则为： su &#x3D; KP′</p>
<p>展开：</p>
<p><img src="https://pic4.zhimg.com/80/v2-cd81492504d08aef794c6f945431b7ff_720w.jpg"></p>
<p>利用第 3 行消去 s（实际上就是 P′ 的距离），得：</p>
<p><img src="https://pic4.zhimg.com/80/v2-335afb87ecd063637ff8d37ecdfa76c3_720w.jpg"></p>
<p>这与相机模型是一致的。当求误差时，可以把这里的 u, v 与实际的测量值比较，求差。定义了中间变量后对 ξ∧左乘扰动量δξ，然后考虑 e 的变化关于扰动量的导数。利用链式法则，可以列写如下：</p>
<p><img src="https://pic2.zhimg.com/80/v2-2e35e0a97d6d6ec308a8699ad8c0d811_720w.jpg"></p>
<p>这里的⊕指李代数上的左乘扰动。第一项是误差关于投影点的导数，得：</p>
<p><img src="https://pic4.zhimg.com/80/v2-d881c45382be3e926970d99804651467_720w.jpg"></p>
<p>第二项为变换后的点关于李代数的导数，得：</p>
<p><img src="https://pic1.zhimg.com/80/v2-e9cb51ceee2ddb4bf4bc533ffcedd620_720w.jpg"></p>
<p>而在 P′ 的定义中，取出了前三维，于是得：</p>
<p><img src="https://pic3.zhimg.com/80/v2-919e43e4ffda41feb389c785f8360a62_720w.jpg"></p>
<p>将这两项相乘，就得到了 2 × 6 的雅可比矩阵：</p>
<p><img src="https://pic2.zhimg.com/80/v2-e52d45f7873b9c22271ab08a88adcd91_720w.jpg"></p>
<p>这个雅可比矩阵描述了重投影误差关于相机位姿李代数的一阶变化关系。保留了前面的负号，因为这是由于误差是由观测值减预测值定义的。它当然也可反过来，定义成 “预测减观测”的形式。在这种情况下，只要去掉前面的负号即可。此外，如果 se(3) 的定义方式是旋转在前，平移在后时，只要把这个矩阵的前三列与后三列对调即可。</p>
<p>另一方面，除了优化位姿，还希望优化特征点的空间位置。因此，需要讨论 e 关于空间点 P 的导数。仍利用链式法则，有：</p>
<p><img src="https://pic2.zhimg.com/80/v2-746a59cffcabacf3cb112ac33c0bb93d_720w.jpg"></p>
<p>第二项，按照定义 P′ &#x3D; exp(ξ∧)P &#x3D; RP + t.</p>
<p>发现 P′ 对 P 求导后只剩下 R。于是:</p>
<p><img src="https://pic3.zhimg.com/80/v2-4ac5b04e6969c8b6487398f7137de80a_720w.jpg"></p>
<p>以上是观测相机方程关于相机位姿与特征点的两个导数矩阵。它们能够在优化过程中提供重要的梯度方向，指导优化的迭代。</p>
<h3 id="8、实践：求解-PnP"><a href="#8、实践：求解-PnP" class="headerlink" title="8、实践：求解 PnP"></a>8、实践：求解 PnP</h3><h4 id="8-1-使用-EPnP-求解位姿"><a href="#8-1-使用-EPnP-求解位姿" class="headerlink" title="8.1 使用 EPnP 求解位姿"></a>8.1 使用 EPnP 求解位姿</h4><p>首先用 OpenCV 提供的 EPnP 求 解 PnP 问题，然后通过 g2o 对结果进行优化。由于 PnP 需要使用 3D 点，为了避免初始化带来的麻烦，使用了 RGB-D 相机中的深度图（1_depth.png），作为特征点的 3D 位置。</p>
<blockquote>
<p>代码为: slambook&#x2F;ch7&#x2F;pose_estimation_3d2d.cpp</p>
</blockquote>
<p>在例程中，得到配对特征点后，在第一个图的深度图中寻找它们的深度，并求出空间位置。以此空间位置为 3D 点，再以第二个图像的像素位置为 2D 点，调用 EPnP 求解 PnP 问题。程序输出后可以看到，在有3D信息时，估计的 R 几乎是相同的，而 t 相差的较多。这是由于引入了新的深度信息所致。 不过，由于 Kinect 采集的深度图本身会有一些误差，所以这里的 3D 点也不是准确的。后面会希望把位姿 ξ 和所有三维特征点 P 同时优化。</p>
<h4 id="8-2-使用-BA-优化"><a href="#8-2-使用-BA-优化" class="headerlink" title="8.2 使用 BA 优化"></a>8.2 使用 BA 优化</h4><p>使用前一步的估计值作为初始值，把问题建模成一个最小二乘的图优化问题，如图所示。</p>
<p><img src="https://pic4.zhimg.com/80/v2-8c69ca2545fa0f93d05b284b32e9f217_720w.jpg"></p>
<p>在这个图优化中，节点和边的选择为：</p>
<ol>
<li>节点：第二个相机的位姿节点 ξ ∈ se(3)，以及所有特征点的空间位置 P ∈ R3。</li>
<li>边：每个 3D 点在第二个相机中的投影，以观测方程来描述： zj &#x3D; h(ξ, Pj ).</li>
</ol>
<p>由于第一个相机位姿固定为零，没有把它写到优化变量里。现在根据一组 3D 点和第二个图像中的 2D 投影，估计第二个相机的位姿。所以把第一个相机画成虚线，表明不希望考虑它。 g2o 提供了许多关于 BA 的节点和边，不必自己从头实现所有的计算。在 g2o&#x2F;types&#x2F;sba&#x2F;types_six_dof_expmap.h 中提供了李代数表达的节点和边。文件中有VertexSE3Expmap（李代数位姿）、VertexSBAPointXYZ（空间点位置） 和 EdgeProjectXYZ2UV（投影方程边）这三个类。</p>
<p>VertexSE3Expmap的类定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">G2O_TYPES_SBA_API</span> VertexSE3Expmap : <span class="keyword">public</span> BaseVertex&lt;<span class="number">6</span>, SE3Quat&gt;&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line"> EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line">​</span><br><span class="line"> <span class="built_in">VertexSE3Expmap</span>();</span><br><span class="line">​</span><br><span class="line"> <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::istream&amp; is)</span></span>;</span><br><span class="line">​</span><br><span class="line"> <span class="function"><span class="type">bool</span> <span class="title">write</span><span class="params">(std::ostream&amp; os)</span> <span class="type">const</span></span>;</span><br><span class="line">​</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">setToOriginImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> _estimate = <span class="built_in">SE3Quat</span>();</span><br><span class="line"> &#125;</span><br><span class="line">​</span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">oplusImpl</span><span class="params">(<span class="type">const</span> <span class="type">double</span>∗ update_)</span> </span>&#123;</span><br><span class="line"> <span class="function">Eigen::Map&lt;<span class="type">const</span> Vector6d&gt; <span class="title">update</span><span class="params">(update_)</span></span>;</span><br><span class="line"> <span class="built_in">setEstimate</span>( SE3Quat::<span class="built_in">exp</span>(update)∗<span class="built_in">estimate</span>());</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p>模板参数：</p>
<ol>
<li>第一个参数 6 表示它内部存储的优化变量维度，可以看到这是一个 6 维的李代数。</li>
<li>第二参数是优化变量的类型，这里使用了 g2o 定义的相机位姿：SE3Quat。 这个类内部使用了四元数加位移向量来存储位姿，但同时也支持李代数上的运算，例如对数映射（log 函数）和李代数上增量（update 函数）等操作。</li>
<li>空间点位置类的维度为 3，类型是 Eigen 的 Vector3D。另一方面，边 EdgeProjectXYZ2UV 连接了两个前面说的两个顶点，它的观测值为 2 维，由 Vector2D 表示，实际上就是空间点的像素坐标。它的误差计算函数表达了投影方程的误差计算方法，也就是前面提到的 z − h(ξ, P ) 的方式。</li>
</ol>
<p>EdgeProjectXYZ2UV 的 linearizeOplus 函数的实现用到了前面推导的雅可比矩阵：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EdgeProjectXYZ2UV::linearizeOplus</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> VertexSE3Expmap ∗ vj = <span class="built_in">static_cast</span>&lt;VertexSE3Expmap ∗&gt;(_vertices[<span class="number">1</span>]);</span><br><span class="line"> <span class="function">SE3Quat <span class="title">T</span><span class="params">(vj−&gt;estimate())</span></span>;</span><br><span class="line"> VertexSBAPointXYZ∗ vi = <span class="built_in">static_cast</span>&lt;VertexSBAPointXYZ∗&gt;(_vertices[<span class="number">0</span>]);</span><br><span class="line"> Vector3D xyz = vi−&gt;<span class="built_in">estimate</span>();</span><br><span class="line"> Vector3D xyz_trans = T.<span class="built_in">map</span>(xyz);</span><br><span class="line">​</span><br><span class="line"> <span class="type">double</span> x = xyz_trans[<span class="number">0</span>];</span><br><span class="line"> <span class="type">double</span> y = xyz_trans[<span class="number">1</span>];</span><br><span class="line"> <span class="type">double</span> z = xyz_trans[<span class="number">2</span>];</span><br><span class="line"> <span class="type">double</span> z_2 = z∗z;</span><br><span class="line">​</span><br><span class="line"> <span class="type">const</span> CameraParameters ∗ cam = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> CameraParameters ∗&gt;(<span class="built_in">parameter</span>(<span class="number">0</span>));</span><br><span class="line">​</span><br><span class="line"> Matrix&lt;<span class="type">double</span>,<span class="number">2</span>,<span class="number">3</span>,Eigen::ColMajor&gt; tmp;</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">0</span>,<span class="number">0</span>) = cam−&gt;focal_length;</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">0</span>,<span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">0</span>,<span class="number">2</span>) = −x/z∗cam−&gt;focal_length;</span><br><span class="line">​</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">1</span>,<span class="number">0</span>) = <span class="number">0</span>;</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">1</span>,<span class="number">1</span>) = cam−&gt;focal_length;</span><br><span class="line"> <span class="built_in">tmp</span>(<span class="number">1</span>,<span class="number">2</span>) = −y/z∗cam−&gt;focal_length;</span><br><span class="line">​</span><br><span class="line"> _jacobianOplusXi = −<span class="number">1.</span>/z ∗ tmp ∗ T.<span class="built_in">rotation</span>().<span class="built_in">toRotationMatrix</span>();</span><br><span class="line">​</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">0</span>) = x∗y/z_2 ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">1</span>) = −(<span class="number">1</span>+(x∗x/z_2)) ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">2</span>) = y/z ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">3</span>) = −<span class="number">1.</span>/z ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line"> _jacobianOplusXj(<span class="number">0</span>,<span class="number">5</span>) = x/z_2 ∗cam−&gt;focal_length;</span><br><span class="line">​</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">0</span>) = (<span class="number">1</span>+y∗y/z_2) ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">1</span>) = −x∗y/z_2 ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">2</span>) = −x/z ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">4</span>) = −<span class="number">1.</span>/z ∗cam−&gt;focal_length;</span><br><span class="line"> _jacobianOplusXj(<span class="number">1</span>,<span class="number">5</span>) = y/z_2 ∗cam−&gt;focal_length;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>它与公式是一致的。成员变量“*- jacobianOplusXi”是误差到空间点的导数，“*jacobianOplusXj”是误差到相机位姿的导数，以李代数的左乘扰动表达。稍有差别的是，g2o 的相机里用 f 统一描述 fx, fy，并且 李代数定义顺序不同（g2o 是旋转在前，平移在后），所以矩阵前三列和后三列与上面的定义是颠倒的。</p>
<p>们在上一个 PnP 例程的基础上，加上 g2o 提供的 Bundle Adjustment：</p>
<p>首先声明了 g2o 图优化，配置优化求解器和梯度下降方法，然后根据估计到的特征点，将位姿和空间点放到图中。最后调用优化函数进 行求解。</p>
<p>优化结果：迭代 11 轮后，LM 发现优化目标函数接近不变，于是停止了优化。输出了最后得到位姿变换矩阵 T，对比之前直接做 PnP 的结果，大约在小数点后第三位发生了一些变化。这主要是由于同时优化了特征点和相机位姿导致的。</p>
<p>Bundle Adjustment 是一种通用的做法。它可以不限于两个图像。可以放入多个图像匹配到的位姿和空间点进行迭代优化，甚至可以把整个 SLAM 过程放进来。那种做法规模较大，主要在后端使用。在前端，我们通常 考虑局部相机位姿和特征点的小型 Bundle Adjustment 问题，希望实时对它进行求解和优化。</p>
<h3 id="9、3D-3D-ICP"><a href="#9、3D-3D-ICP" class="headerlink" title="9、3D-3D: ICP"></a>9、3D-3D: ICP</h3><p>3D-3D的位姿估计问题。假设有一组配对好的3D点，</p>
<p>$$<br>P &#x3D; { p_1, …, p_n}  \quad P^{‘} &#x3D; { p_1^{‘}, …, p_n^{‘}}<br>$$</p>
<p>我们想要找到一个欧式变换R,t使得：</p>
<p>$$<br>\forall_i, p_i &#x3D; Rp_i^{‘} + t.<br>$$</p>
<p>这个问题可以用<strong>迭代最近点</strong>（Iterative Closest Point, ICP）求解。3D-3D位姿问题中，没有相机模型，也就是说，仅考虑两组3D点之间的变换时，跟相机并没有关系。在RGB-D SLAM中，可以用这种方式估计相机位姿。</p>
<p><strong>两种求解方式</strong>：1、线性代数的求解（SVD）2、非线性优化方式（类Bundle Adjustment）</p>
<h4 id="9-1-SVD方法"><a href="#9-1-SVD方法" class="headerlink" title="9.1 SVD方法"></a>9.1 SVD方法</h4><p>定义误差项：</p>
<p>$$<br>e_i &#x3D; p_i - (Rp_i^{‘} + t ).<br>$$</p>
<p>构建最小二乘问题，求误差平方和达到最小的R，t;</p>
<p>$$<br>\min_{R,t}J &#x3D; \frac{1}{2} \sum_{i&#x3D;1}^n || p_i - (Rp_i^{‘} + t)||_2^{2}<br>$$</p>
<p>下面推导求解方法，定义两组质心：</p>
<p>$$<br>p &#x3D; \frac{1}{n} \sum_{i&#x3D;1}^{n} (p_i) ,<br>\qquad<br>p^{‘} &#x3D; \frac{1}{n} \sum_{i&#x3D;1}^{n} (p^{‘}_i)<br>$$</p>
<p>注意，质心没有下标的。随后带入误差函数，如下处理：</p>
<p>$$<br>\frac{1}{2} \sum_{i&#x3D;1}^{n} || p_i - (Rp_i^{‘} + t )||^2 &#x3D;<br>\frac{1}{2} \sum_{i&#x3D;1}^{n} || p_i - Rp_i^{‘} -t -p +Rp^{‘} +p -Rp^{‘})||^2<br>\<br>\qquad \qquad \qquad \qquad \qquad<br>&#x3D; \frac{1}{2} \sum_{i&#x3D;1}^{n} || p_i -p - R(p_i^{‘} - p^{‘}) + (p - Rp^{‘} + t)||^2<br>\<br>\qquad \qquad \qquad \qquad \qquad \qquad<br>&#x3D; \frac{1}{2} \sum_{i&#x3D;1}^{n} || p_i -p - R(p_i^{‘} - p^{‘}) ||^2 </p>
<ul>
<li>||(p - Rp^{‘} + t)||^2 +<br>\ \qquad \qquad \qquad \qquad \qquad<br>2(p_i^{‘} - p^{‘} - R(p_i^{‘} - p^{‘}))^T (p-Rp^{‘}-t)<br>$$</li>
</ul>
<p>注意到交叉项部分中， $(p_i^{‘} - p^{‘} - R(p_i^{‘} - p^{‘}))$ 在求和之后为零的，因此优化目标函数可以简化为：</p>
<p>$$<br>\min_{R,t} J &#x3D; \frac{1}{2} \sum_{i&#x3D;1}^{n} || p_i -p - R(p_i^{‘} - p^{‘}) ||^2 </p>
<ul>
<li>||(p - Rp^{‘} + t)||^2<br>$$</li>
</ul>
<p>仔细观察左右两项，左边只和旋转矩阵R相关，右边既有R也有t，单是只跟质心相关，只要获取了R，令第二项为零，即可得到t。</p>
<p>因此分三个步骤：</p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-08-11-20-04-05-image.png"></p>
<p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-08-11-20-04-55-image.png"></p>
<h4 id="9-2-非线性优化方法"><a href="#9-2-非线性优化方法" class="headerlink" title="9.2 非线性优化方法"></a>9.2 非线性优化方法</h4><p><img src="/2022/07/27/Course/SLAM/ch07_vo/2022-08-11-20-05-20-image.png"></p>
<p>于是，在非线性优化中只需不断迭代，我们就能找到极小值。而且，可以证明 [6] ， ICP 问题存在唯一解或无穷多解的情况。<br>在唯一解的情况下，只要我们能找到极小值解，那么 这个极小值就是全局最优值——因此不会遇到局部极小而非全局最小的情况。<br>这也意味着 ICP 求解可以任意选定初始值。这是已经匹配点时求解 ICP 的一大好处。 需要说明的是，我们这里讲的 ICP ，<br>是指已经由图像特征给定了匹配的情况下，进行 位姿估计的问题。在匹配已知的情况下，这个最小二乘问题实际上具有解析解 [52, 53, 54] ，<br>所以并没有必要进行迭代优化。 ICP 的研究者们往往更加关心匹配未知的情况。不过，在 RGB-D SLAM 中，由于一个像素的深度数据可能测量不到，<br>所以我们可以混合着使用 PnP 和 ICP 优化：对于深度已知的特征点，用建模它们的 3D-3D 误差；对于深度未知的特征<br>点，则建模 3D-2D 的重投影误差。于是，可以将所有的误差放在同一个问题中考虑，使得 求解更加方便。</p>
<h3 id="10、实践：求解ICP"><a href="#10、实践：求解ICP" class="headerlink" title="10、实践：求解ICP"></a>10、实践：求解ICP</h3><h3 id="引用："><a href="#引用：" class="headerlink" title="引用："></a>引用：</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458042548">SLAM_OV 第七讲-视觉里程计-1 特征点法和特征提取和匹配实践 </a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/463933793">SLAM_OV 第七讲-视觉里程计-2 对极几何和对极约束、本质矩阵、基础矩阵</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/468597111">SLAM OV 第七讲-视觉里程计-3,4 单应矩阵和实践</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/471939664">SLAM OV 第七讲-视觉里程计-5,6 视觉里程计-三角测量和实践</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/474523188">SLAM OV 第七讲-视觉里程计-7,8 第七讲-视觉里程计-PnP和实践</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hltt3838/article/details/109465381">CDSN: 相机运动估计 三、 3D - 3D: ICP_贵在坚持，不忘初心的博客-CSDN博客</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/20/Course/SLAM/ch06_Ceres_g2o/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/20/Course/SLAM/ch06_Ceres_g2o/" class="post-title-link" itemprop="url">SLAM 第六讲 非线性优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-20 12:09:00" itemprop="dateCreated datePublished" datetime="2022-07-20T12:09:00+00:00">2022-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:39" itemprop="dateModified" datetime="2025-08-06T08:16:39+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1、状态估计问题"><a href="#1、状态估计问题" class="headerlink" title="1、状态估计问题"></a>1、状态估计问题</h2><h3 id="1-1-批量状态估计与最大后验估计"><a href="#1-1-批量状态估计与最大后验估计" class="headerlink" title="1.1 批量状态估计与最大后验估计"></a>1.1 批量状态估计与最大后验估计</h3><p>经典 SLAM 模型由一个运动方程和一个观测方程构成：</p>
<p>$$<br>x_k &#x3D; f (x_{k-1}, u_k) + w_k  \<br>z_{k,j} &#x3D; h(y_i, x_k) + v_{k,j}<br>$$</p>
<p>xk是相机的位姿变量，可以由Tk∈SE(3)表达。运动方程与输入的具体形式有关，在视觉SLAM中没有特殊性（和普通的机器人、车辆的情况一样）。观测方程则由针孔模型给定。假设在xk处对路标yj进行了一次观测，对应到图像上的像素位置z<em>k,j</em>，那么，观测方程可以表示成</p>
<p>$$<br>sz_{k,j} &#x3D; K(R_ky_j + t_k)<br>$$</p>
<p>其中K为相机内参，<em>s</em>为像素点的距离，也是(R<em>k</em>y<em>j</em> +t<em>k</em>)的第三个分量。如果使用变换矩阵Tk描述位姿，那么路标点yj必须以齐次坐标来描述，计算完成后要转换为非齐次坐标。</p>
<p>在运动和观测方程中，通常假设两个噪声项wk,<em>v</em>k,j满足零均值的高斯分布：</p>
<p>$$<br>w_k \sim N(0, R_k), v_k \sim N(0, Q_{k,j})<br>$$</p>
<p>其中N表示高斯分布，<strong>0</strong>表示零均值，Rk,Qk,j为协方差矩阵。在这些噪声的影响下，希望通过带噪声的数据z和u推断位姿x和地图y（以及它们的概率分布），这构成了一个状态估计问题。</p>
<p>处理这个状态估计问题的方法分成两种。</p>
<p>第一种：由于在SLAM过程中，这些数据是随时间逐渐过来的，所以在直观上，应该持有一个当前时刻的估计状态，然后用新的数据来更新它。这种方式称为增量（incremental）的方法，或者叫滤波器。在SLAM的早期研究，主要使用扩展卡尔曼滤波器（EKF）及其衍生方法来求解。</p>
<p>第二种：是把数据累加起来一并处理，这种方式称为批量（batch）的方法。例如，可以把0到<em>k</em>时刻所有的输入和观测数据都放在一起，求在这样的输入和观测下，如何估计整个0到<em>k</em>时刻的轨迹与地图？</p>
<p>增量方法仅关心当前时刻的状态估计xk，而对之前的状态则不多考虑；相对地，批量方法可以在更大的范围达到最优化，被认为优于传统的滤波器，成为当前视觉SLAM的主流方法。极端情况下，可以让机器人或无人机收集所有时刻的数据，再带回计算中心统一处理，这也正是SfM（Structure from Motion）的主流做法。这种极端情况不实时，不符合SLAM的运用场景。所以在SLAM中，实用的方法通常是一些折中的手段。比如，固定一些历史轨迹，仅对当前时刻附近的一些轨迹进行优化，这就是滑动窗口估计法。还有因子图增量平滑优化的方法，能够增量增加优化问题并进行动态调整，能够达到有滤波器的速度和图优化的精度。</p>
<p>先讨论批量方法，考虑从1到<em>N</em>的所有时刻，并假设有<em>M</em>个路标点。定义所有时刻的机器人位姿和路标点坐标为：</p>
<p>$$<br>x &#x3D; {x_1, …, x_N}, y&#x3D;{y_1, …, y_M}<br>$$</p>
<p>用不带下标的u表示所有时刻的输入，z表示所有时刻的观测数据。对机器人状态的估计，从概率学的观点来看，就是已知输入数据u和观测数据z的条件下，求状态x*,*y的条件概率分布：</p>
<p>$$<br>P(x,y|z,u)<br>$$</p>
<p>特别地，当不知道控制输入，只有一张张图像时，即只考虑观测方程带来的数据时，相当于估计<em>P</em>(x*,*y|z)的条件概率分布，此问题也称为Structure from Motion（SfM），即如何从许多图像中重建三维空间结构。</p>
<p>为了估计状态变量的条件分布，利用贝叶斯法则，有：</p>
<p>$$<br>P(x,y|z,u) &#x3D; \frac{P(z,u|x,y) P(x,y)}{P(z,u)} \infty<br>\underbrace{P(z,u|x,y)}<em>{似然} \underbrace{P(x,y)}</em>{先验}<br>$$</p>
<p>贝叶斯法则左侧称为后验概率，右侧的 <em>P</em>(z|x) 称为似然（Likehood），另一部分 <em>P</em>(x) 称为先验（Prior）。直接求后验分布是困难的，但是求一个状态最优估计，使得在该状态下后验概率最大化（Maximize a Posterior，MAP），则是可行的：</p>
<p>$$<br>(x, y)^*_{Map} &#x3D; argmax P (x,y| z,u) &#x3D; argmax P(z,u|x,y)P(x,y)<br>$$</p>
<p>贝叶斯法则的分母部分与待估计的状态x,y无关，因而可以忽略。贝叶斯法则说明，求解最大后验概率等价于最大化似然和先验的乘积。进一步，如果不知道机器人位姿或路标大概在什么地方，此时就没有了先验。那么，可以求解最大似然估计（Maximize Likelihood Estimation，MLE）：</p>
<p>$$<br>(x,y)^*_{MLE} &#x3D; argmax P(z,u| x,y)<br>$$</p>
<p>似然是指“在现在的位姿下，可能产生怎样的观测数据”。但是由于知道观测数据，所以最大似然估计可以理解成：“在什么样的状态下，最可能产生现在观测到的数据”。这就是最大似然估计的直观意义。</p>
<h3 id="1-2-最小二乘的引出"><a href="#1-2-最小二乘的引出" class="headerlink" title="1.2 最小二乘的引出"></a>1.2 最小二乘的引出</h3><p>如何求最大似然估计呢？在高斯分布的假设下，最大似然能够有较简单的形式。回顾观测模型，对于某一次观测：</p>
<p>$$<br>z_{k,j} &#x3D; h(y_i, x_k) + v(k,j)<br>$$</p>
<p>假设噪声项vk ∼ N (0,Qk,j)，观测数据的条件概率为：</p>
<p>$$<br>P(z_{j,k} | x_k, y_i) &#x3D; N( h(y_i, x_k), Q_{k,j})<br>$$</p>
<p>它依然是一个高斯分布。考虑单次观测的最大似然估计，可以使用最小化负对数来求一个高斯分布的最大似然。</p>
<p>高斯分布在负对数下有较好的数学形式。考虑任意高维高斯分布x ∼ N(µ,Σ)，它的概率密度函数展开形式为：</p>
<p>$$<br>P(x) &#x3D; \frac{1}{\sqrt[]{ (2\pi)^N det(\Sigma)}}<br>\exp \big( -\frac{1}{2}(x-\mu)^T \Sigma^{-1}(x-\mu) \big)<br>$$</p>
<p>对其取负对数，则变为：</p>
<p>$$<br>-\ln(P(x))&#x3D;  \frac{1}{2} \ln \big({ (2\pi)^N det(\Sigma)} \big)</p>
<ul>
<li>-\frac{1}{2}(x-\mu)^T \Sigma^{-1}(x-\mu)<br>$$</li>
</ul>
<p>因为对数函数是单调递增的，所以对原函数求最大化相当于对负对数求最小化。在最小化上式的x时，第一项与x无关，可以略去。于是，只要最小化右侧的二次型项，就得到了对状态的最大似然估计。代入SLAM的观测模型，相当于在求：</p>
<p>$$<br>b<br>$$</p>
<p>该式等价于最小化噪声项（即误差）的一个二次型。这个二次型称为马哈拉诺比斯距离（Mahalanobis distance），又叫马氏距离。它也可以看成是由(Qk,j)-1 加权之后的欧氏距离（二范数），这里(Qk,j)-1也叫做信息矩阵，即高斯分布协方差矩阵之逆。</p>
<p>现在考虑批量时刻的数据。通常假设各个时刻的输入和观测是相互独立的，这意味着各个输入之间是独立的，各个观测之间是独立的，并且输入和观测也是独立的。于是可以对联合分布进行因式分解：</p>
<p>$$<br>b<br>$$</p>
<p>这说明可以独立地处理各时刻的运动和观测。定义各次输入和观测数据与模型之间的误差：</p>
<p>$$<br>e_{u,k} &#x3D; x_k - f(x_{k-1},u_k) \<br>e_{z,j,k} &#x3D; z_{k,j} - h(x_k, y_i)<br>$$</p>
<p>那么，最小化所有时刻估计值与真实值之间的马氏距离，等价于求最大似然估计。负对数允许把乘积变成求和：</p>
<p>$$<br>\min J(x,y) &#x3D; \sum_{k} e_{u,k}^T R_{k}^{-1} e_{u,k} +<br>\sum_{k}\sum_{j} e_{z,k,j}^T R_{k,j}^{-1} e_{z,k,j}<br>$$</p>
<p>这样就得到了一个最小二乘问题（Least Square Problem），它的解等价于状态的最大似然估计。直观上看，由于噪声的存在，当我们把估计的轨迹与地图代入 SLAM 的运动、观测方程中时，它们并不会完美地成立。这时对状态的估计值进行微调，使得整体的误差下降一些。当然这个下降也有限度，它一般会到达一个极小值。这就是一个典型非线性优化的过程。</p>
<p><strong>SLAM 中的最小二乘问题具有一些特定的结构：</strong></p>
<p>• 整个问题的目标函数由许多个误差的（加权的）二次型组成。虽然总体的状态变量维数很高，但每个误差项都是简单的，仅与一两个状态变量有关。例如，运动误差只与$x_{k−1}, x_k$ 有关，观测误差只与$x_k,y_j$有关。这种关系会让整个问题有一种稀疏的矩阵形式，计算量大大减少。</p>
<p>• 如果使用李代数表示增量，则该问题是无约束的最小二乘问题。但如果用旋转矩阵&#x2F;变换矩阵描述位姿，则会引入旋转矩阵自身的约束，即需在问题中加入$R^TR &#x3D; I$且$det(R) &#x3D;1$的条件。额外的约束会使优化变得更困难。这体现了李代数的优势。</p>
<p>• 使用了二次型度量误差。误差的分布将影响此项在整个问题中的权重。例如，某次的观测非常准确，那么协方差矩阵就会“小”，而信息矩阵就会“大”，所以这个误差项会在整个问题中占有较高的权重。</p>
<h3 id="1-3-例子：批量状态估计"><a href="#1-3-例子：批量状态估计" class="headerlink" title="1.3 例子：批量状态估计"></a>1.3 例子：批量状态估计</h3><p>考虑一个离散时间系统：</p>
<p>$$<br>x_k &#x3D; x_{k-1} + u_k + w_k,  \quad  w_k \sim N(0, Q_k) \<br>z_k &#x3D; x_{k} + n_k,      \qquad\qquad     n_k \sim N(0, R_k)<br>$$</p>
<p>这可以表达一辆沿 <em>x</em> 轴前进或后退的汽车。第一个公式为运动方程，uk 为输入，wk 为噪声；第二个公式为观测方程，zk 为对汽车位置的测量。取时间 k &#x3D; 1,…,3，现希望根据已有的 v,y 进行状态估计。设初始状态 <em>x</em>0 已知，来推导批量（batch）状态的最大似然估计。</p>
<p>首先，令批量状态变量为$x &#x3D; [x_0,x_1,x_2,x_3]^T$，令批量观测为$z &#x3D; [z_1,z_2, z_3]^T$，定义$u &#x3D; [u_1,u_2,u_3]^T$。最大似然估计为：</p>
<p>$$<br>x^*_{map} &#x3D; \argmax P(x|u,z) &#x3D; \argmax P(u,z|x)\<br>\quad<br>&#x3D; \sum^{3}<em>{k&#x3D;1} (u_k| x</em>{k-1, x_k})<br>\sum^{3}_{k&#x3D;1} (z_k| )<br>$$</p>
<p>运动方程：</p>
<p>$$<br>P(u_k| x_{k-1}, x_k) &#x3D; N (x_k - x_{k-1}, Q_k)<br>$$</p>
<p>观测方程：</p>
<p>$$<br>P(z_k, x_k) &#x3D; N(x_k, R_k)<br>$$</p>
<p>构建误差变量：</p>
<p>$$<br>e_{u,k} &#x3D; x_k - x_{k-1} - u_k,  \quad<br>e_{z,k} &#x3D; z_k - x_k<br>$$</p>
<p>于是最小二乘的目标函数为</p>
<p>$$<br>\min \sum_{k&#x3D;1}^3 e_{u,k}^T Q_k^{-1} e_{u,k} +<br>\sum_{k&#x3D;1}^3 e_{z,k}^T R_{k}^{-1} e_{z,k}<br>$$</p>
<p>这个系统是线性系统，将它写成向量形式。定义向量$y &#x3D; [u,z]^T$，那么可以写出矩阵H，使得：</p>
<p>$$<br>y - Hx &#x3D; e \sim N(0, \Sigma)<br>$$</p>
<p>那么：</p>
<p>$$<br>H &#x3D; []</p>
<p>\<br>\Sigma &#x3D; diag(Q_1, Q_2, Q_3, R_1, R_2, R_3)<br>$$</p>
<p>整个问题可以写成：</p>
<p>$$<br>x_{map}^* &#x3D; \argmax e^T \Sigma^{-1}e.<br>$$</p>
<p>这个问题有唯一的解：</p>
<p>$$<br>x_{map}^* &#x3D; (H^T \Sigma^{-1} H)^{-1} H^T \Sigma^{-1}y<br>$$</p>
<h2 id="2、非线性最小二乘"><a href="#2、非线性最小二乘" class="headerlink" title="2、非线性最小二乘"></a>2、非线性最小二乘</h2><p>考虑一个最小二乘问题：</p>
<p>$$<br>\min_{x} F(x) &#x3D; \frac{1}{2} ||f(x)||^2_2<br>$$</p>
<p>其中，自变量$x\in R_n$，f是任意标量非线性函数f(x):Rn-&gt;R。注意这里的系数1&#x2F;2是无关紧要的。如何求解这样一个优化问题：如果f是个数学形式上很简单的函数，那么该问题可以用解析形式来求。令目标函数的导数为零，然后求解x的最优值，就求二元函数的极值一样：</p>
<p>$$<br>\frac{dF}{dx} &#x3D; 0<br>$$</p>
<p>解此方程，就得到了导数为零处的极值，可能是极大，极小或鞍点处的值。只要逐个比较函数值大小即可。如果 <em>f</em> 为简单的线性函数，那么这个问题就是简单的线性最小二乘问题，但是有些导函数形式复杂，使得该方程不容易求解。求解这个方程需要知道关于目标函数的全局性质，而通常这是不大可能的。对于不方便直接求解的最小二乘问题，可以用迭代的方式，从一个初始值出发，不断地更新当前的优化变量，使目标函数下降。具体步骤可列写如下：</p>
<ol>
<li>给定某个初始值x0。</li>
<li>对于第 <em>k</em> 次迭代，寻找一个增量 ∆x<em>k</em>，使得</li>
</ol>
<p>$$<br>|| f(x_k + \Delta x_k) ||^2_2<br>$$</p>
<p>达到极小值。</p>
<ol start="3">
<li><p>若 ∆xk 足够小，则停止。</p>
</li>
<li><p>否则，令x(k+1) &#x3D; xk + ∆xk，返回第 2 步。</p>
</li>
</ol>
<p>这让求解导函数为零的问题变成了一个不断寻找下降增量 ∆xk 的问题。由于可以对 f 进行线性化，增量的计算将简单很多。当函数下降直到增量非常小的时候，就认为算法收敛，目标函数达到了一个极小值。在这个过程中，问题在于如何找到每次迭代点的增量，而这是一个局部的问题，只需要关心 <em>f</em> 在迭代值处的局部性质而非全局性质。这类方法在最优化、机器学习等领域应用非常广泛。</p>
<p>下面是如何寻找这个增量 ∆xk的方法。</p>
<h3 id="2-1-一阶和二阶梯度法"><a href="#2-1-一阶和二阶梯度法" class="headerlink" title="2.1 一阶和二阶梯度法"></a>2.1 一阶和二阶梯度法</h3><p>考虑第 k 次迭代，假设在xk处，想要找到增量 ∆xk，最直观的方式是将目标函数在xk附近进行泰勒展开：</p>
<p>$$<br>F<br>$$</p>
<p>其中J(xk) 是 F(x)关于x的一阶导数（也叫梯度、雅可比矩阵﹝Jacobian﹞），H 则是二阶导数（海塞﹝Hessian﹞矩阵），它们都在xk 处取值。可以选择保留泰勒展开的一阶或二阶项，那么对应的求解方法则称为一阶梯度或二阶梯度法。如果保留一阶梯度，取增量为反向的梯度，即可保证函数下降：∆x∗&#x3D; −J(xk)</p>
<p>这只是个方向，通常还要再指定一个步长 λ。步长可以根据一定的条件来计算，在机器学习当中也有一些经验性质的方法。这种方法被称为最速下降法。它的直观意义是：只要沿着反向梯度方向前进，在一阶（线性）的近似下，目标函数必定会下降。</p>
<p>以上都是在第k次迭代时进行的，并不涉及其他的迭代信息。为了简化符号，省略下标k，并认为这些对任意一次迭代都成立。</p>
<p>选择保留二阶梯度信息，此时增量方程为：</p>
<p>$$<br>$$</p>
<p>右侧只含 ∆x的零次、一次和二次项。求右侧等式关于 ∆x的导数并令它为零，得到：</p>
<p>$$</p>
<p>$$<br>求解这个线性方程就得到了增量。此类方法又称为牛顿法。</p>
<p>一阶和二阶梯度法都十分直观，只要把函数在迭代点附近进行泰勒展开，并针对更新量做最小化即可。用一个一次或二次的函数近似原函数，然后用近似函数的最小值来估计原函数的极小值。只要原目标函数局部看起来像一次或二次函数，这类算法就是成立的。不过这两种方法也存在问题：最速下降法过于贪心，容易走出锯齿路线，反而增加了迭代次数。而牛顿法则需要计算目标函数的H矩阵，这在问题规模较大时非常困难，通常倾向于避免H的计算。所以引出了下面的一些方法。</p>
<h3 id="2-2-高斯牛顿法"><a href="#2-2-高斯牛顿法" class="headerlink" title="2.2 高斯牛顿法"></a>2.2 高斯牛顿法</h3><p>牛顿法是对目标函数 F(x) 进行一阶泰勒展开，而高斯牛顿法是对f(x)进行一阶泰勒展开：f (x + ∆x) ≈ f(x) + J(x)T∆x.</p>
<p>注：把 J(x) 写成列向量，那么它可以和 ∆x 进行内积，得到一个标量。</p>
<p>这里J(x)T为f(x)关于x的导数，为n×1的列向量。目标是寻找增量∆x，使得∥f(x+∆x)∥2达到最小。为了求 ∆x，需要解一个线性的最小二乘问题：</p>
<p>$$</p>
<p>F<br>$$</p>
<p>根据极值条件，将上述目标函数对 ∆x求导，并令导数为零。可以得到如下方程组：</p>
<p>$$<br>F<br>$$</p>
<p>这个方程是关于变量∆x的线性方程组，称它为增量方程，也可以称为高斯牛顿方程（GaussNewton equation）或者正规方程（Normal equation）。把左边的系数定义为H，右边定义为g，那么上式变为：H∆x &#x3D; g.</p>
<p>对比牛顿法可见，高斯牛顿法用JJT作为牛顿法中二阶Hessian矩阵的近似，从而省略了计算H的过程。求解增量方程是整个优化问题的核心所在。高斯牛顿法的算法步骤可以写成：</p>
<ol>
<li><p>给定初始值x0。</p>
</li>
<li><p>对于第 k 次迭代，求出当前的雅可比矩阵J(xk) 和误差f(xk)。</p>
</li>
<li><p>求解增量方程：H∆xk &#x3D; g。</p>
</li>
<li><p>若 ∆xk 足够小，则停止。否则，令x(k+1) &#x3D; xk+ ∆xk，返回第 2 步。</p>
</li>
</ol>
<p>从算法步骤中，主要还是增量的求解。只要能够顺利解出增量，就能保证目标函数能够正确地下降。</p>
<p>为了求解增量方程，需要求解H−1，这需要H矩阵可逆，但实际数据中计算得到的JJT只有半正定性。也就是说，在使用高斯牛顿法时，可能出现JJT为奇异矩阵或者病态（ill-condition）的情况，此时增量的稳定性较差，导致算法不收敛。直观地说，原函数在这个点的局部近似不像一个二次函数。假设H非奇异也非病态，如果求出来的步长∆x太大，也会导致采用的局部近似式：f (x + ∆x) ≈ f(x) + J(x)T∆x.不够准确，这样一来无法保证它的迭代收敛。</p>
<p>在非线性优化领域，相当多的算法都可以归结为高斯牛顿法的变种。这些算法都借助了高斯牛顿法的思想并且通过改进修正其缺点。例如一些线搜索方法 (line search method) 加入了一个步长α，在确定了∆x后进一步找到 α 使得 ∥f(x + α∆x)∥2 达到最小，而不是简单地令 α &#x3D; 1。</p>
<p>列文伯格—马夸尔特方法在一定程度上修正了这些问题，比高斯牛顿法更为鲁棒，但收敛速度会比高斯牛顿法更慢，被称为阻尼牛顿法（Damped Newton Method）。</p>
<h3 id="2-3-列文伯格—马夸尔特方法"><a href="#2-3-列文伯格—马夸尔特方法" class="headerlink" title="2.3 列文伯格—马夸尔特方法"></a>2.3 列文伯格—马夸尔特方法</h3><p>高斯牛顿法中采用的近似二阶泰勒展开只能在展开点附近有较好的近似效果，所以应该给∆x添加一个范围，称为信赖区域（Trust Region）。这个范围定义了在什么情况下二阶近似是有效的，这类方法也称为信赖区域方法（Trust Region Method）。在信赖区域里边，近似是有效的；出了这个区域，近似可能会出问题。</p>
<p>那么如何确定这个信赖区域的范围呢？一个比较好的方法是根据近似模型跟实际函数之间的差异来确定：如果差异小，说明近似效果好，扩大近似的范围；反之，如果差异大，就缩小近似的范围。我们定义一个指标 <em>ρ</em> 来刻画近似的好坏程度：</p>
<p>$$<br>F<br>$$</p>
<p><em>ρ</em> 的分子是实际函数下降的值，分母是近似模型下降的值。如果 <em>ρ</em> 接近于 1，则近似是好的。如果 <em>ρ</em> 太小，说明实际减小的值远少于近似减小的值，则认为近似比较差，需要缩小近似范围。反之，如果 <em>ρ</em> 比较大，则说明实际下降的比预计的更大，可以放大近似范围。</p>
<p>于是构建一个改良版的非线性优化框架，该框架会比高斯牛顿法有更好的效果：</p>
<ol>
<li>给定初始值 x0，以及初始优化半径 µ。</li>
<li>对于第 k 次迭代，在高斯牛顿法的基础上加上信赖区域，求解：</li>
</ol>
<p>$$<br>F<br>$$</p>
<ol>
<li>其中 µ 是信赖区域的半径，D 为系数矩阵。</li>
<li>计算 ρ。</li>
<li>若 ρ &gt; 3&#x2F;4，则设置 µ &#x3D; 2µ。</li>
<li>若 ρ &lt; 1&#x2F;4，则设置 µ &#x3D; 0.5µ。</li>
<li>如果 ρ 大于某阈值，则认为近似可行。令 xk+1 &#x3D; xk + ∆xk。</li>
<li>判断算法是否收敛。如不收敛则返回第 2 步，否则结束。</li>
</ol>
<p>这里近似范围扩大的倍数和阈值都是经验值，可以替换成别的数值。</p>
<p>$$<br>F<br>$$</p>
<p>这个式子中，把增量限定于一个半径为 µ 的球中，认为只在这个球内才是有效的。带上D之后，这个球可以看成一个椭球。在列文伯格提出的优化方法中，把D取成单位阵I，相当于直接把 ∆xk约束在一个球中。随后，马夸尔特提出将D取成非负数对角阵——实际中通常用JTJ 的对角元素平方根，使得在梯度小的维度上约束范围更大一些。</p>
<p>在列文伯格—马夸尔特优化中，需要求解这个子问题来获得梯度。</p>
<p>这个子问题是带不等式约束的优化问题，用拉格朗日乘子把约束项放到目标函数中，构成拉格朗日函数：</p>
<p>$$<br>F<br>$$</p>
<p>这里 <em>λ</em> 为拉格朗日乘子。类似于高斯牛顿法中的做法，令该拉格朗日函数关于∆x的导数为零，它的核心仍是计算增量的线性方程：</p>
<p>$$<br>F<br>$$</p>
<p>可以看到，增量方程相比于高斯牛顿法，多了一项 <em>λ</em>D<em>T</em>D。考虑它的简化形式，即D &#x3D; I，那么相当于求解：</p>
<p>(H + <em>λ</em>I)∆x<em>k</em> &#x3D; g*.*</p>
<p>当参数λ比较小时，H占主要地位，这说明二次近似模型在该范围内是比较好的，列文伯格—马夸尔特方法更接近于高斯牛顿法。另一方面，当λ比较大时，λI占据主要地位，列文伯格—马夸尔特方法更接近于一阶梯度下降法（即最速下降），这说明附近的二次近似不够好。列文伯格—马夸尔特方法的求解方式，可在一定程度上避免线性方程组的系数矩阵的非奇异和病态问题，提供更稳定、更准确的增量 ∆x。</p>
<p>在实际中，还存在许多其他的方式来求解增量，例如</p>
<p>[31] J. Nocedal and S. Wright, Numerical Optimization. Springer Science &amp; Business Media, 2006.</p>
<p>实际问题中，通常选择高斯牛顿法或列文伯格—马夸尔特方法其中之一作为梯度下降策略。当问题性质较好时，用高斯牛顿。如果问题接近病态，则用列文伯格—马夸尔特方法。</p>
<table>
<thead>
<tr>
<th>梯度下降法</th>
<th>场景</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>牛顿法</td>
<td></td>
<td></td>
</tr>
<tr>
<td>高斯-牛顿</td>
<td>问题质量较好</td>
<td></td>
</tr>
<tr>
<td>列文伯格-马夸尔特方法</td>
<td>问题接近病态？</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>专门介绍数值优化的书籍</p>
<p>[31] J. Nocedal and S. Wright, Numerical Optimization. Springer Science &amp; Business Media, 2006.</p>
<p>以高斯牛顿法和列文伯格—马夸尔特方法为代表的优化方法，在很多开源的优化库中都已经实现并提供给用户。最优化是处理许多实际问题的基本数学工具，不光在视觉 SLAM 中起着核心作用，在类似于深度学习等其他领域，它也是求解问题的核心方法之一（深度学习数据量很大，以一阶方法为主）。</p>
<p>无论是高斯牛顿法还是列文伯格—马夸尔特方法，在做最优化计算时，都需要提供变量的初始值。这个初始值不能随意设置。实际上非线性优化的所有迭代求解方案，都需要用户来提供一个良好的初始值。由于目标函数太复杂，导致在求解空间上的变化难以预测，对问题提供不同的初始值往往会导致不同的计算结果。这种情况是非线性优化的通病：大多数算法都容易陷入局部极小值。因此，无论是哪类科学问题，提供初始值都应该有科学依据，例如视觉 SLAM 问题中，会用 ICP、PnP 之类的算法提供优化初始值（视觉前端）。一个良好的初始值对最优化问题非常重要。</p>
<p>如何求解线性增量方程组呢？在视觉SLAM算法里，经常遇到∆x的维度很大，如果是要做大规模的视觉三维重建，就会经常发现这个维度可以轻易达到几十万甚至更高的级别。要对那么大个矩阵进行求逆是大多数处理器无法负担的，因此存在着许多针对线性方程组的数值求解方法。在不同的领域有不同的求解方式，但几乎没有一种方式是直接求系数矩阵的逆，会采用矩阵分解的方法来解线性方程，例如 QR、Cholesky 等分解方法。(工程数学)</p>
<p>视觉SLAM里这个矩阵往往有特定的稀疏形式，这为实时求解优化问题提供了可能性。利用稀疏形式的消元、分解，最后再进行求解增量，会让求解的效率大大提高。在很多开源的优化库上，比如GTSAM，维度为一万多的变量在一般的PC上就可以在几秒甚至更短的时间内被求解出来，其原因也是用了更加高级的数学工具（因子图增量平滑优化）。视觉SLAM算法现在能够实时地实现，多亏了系数矩阵是稀疏的，如果矩阵是稠密的，优化这类视觉SLAM算法不会被学界广泛采纳了。</p>
<h2 id="3-实践：曲线拟合问题"><a href="#3-实践：曲线拟合问题" class="headerlink" title="3 实践：曲线拟合问题"></a>3 实践：曲线拟合问题</h2><h3 id="3-1手写高斯牛顿法"><a href="#3-1手写高斯牛顿法" class="headerlink" title="3.1手写高斯牛顿法"></a>3.1手写高斯牛顿法</h3><p>考虑一条满足以下方程的曲线：</p>
<p>$$<br>y &#x3D; \exp (ax^2 + bx + c) + w<br>$$</p>
<p>其中 <em>a,b,c</em> 为曲线的参数，<em>w</em> 为高斯噪声，满足 <em>w</em> ∼ (0*,σ*2)。假设有 <em>N</em> 个关于 <em>x,y</em> 的观测数据点，根据这些数据点求出曲线的参数。那么，可以求解下面的最小二乘问题来估计曲线参数：</p>
<p>$$<br>\min_{a,b,c} 1&#x2F;2 \sum_{i&#x3D;1}^N<br>|| y_i - \exp( ax_i^2 + bx_i +c ) || ^2<br>$$</p>
<p>在这个问题中，待估计的变量是 <em>a,b,c</em>，而不是 <em>x</em>。程序里先根据模型生成 <em>x,y</em> 的真值，然后在真值中添加高斯分布的噪声。随后，使用高斯牛顿法来从带噪声的数据（x，y）拟合参数模型。定义误差为:</p>
<p>$$<br>e_i &#x3D; y_i - \exp(ax_i^2 + bx_i + c)<br>$$</p>
<p>那么可以求出每个误差项对于状态变量的导数：</p>
<p>$$<br>\frac{\partial e_i} {\partial a} &#x3D; -x_i^2 \exp(ax_i^2 + bx_i + c)\<br>\frac{\partial e_i} {\partial b} &#x3D; -x_i \exp(ax_i^2 + bx_i + c)\<br>\frac{\partial e_i} {\partial c} &#x3D; - \exp(ax_i^2 + bx_i + c) \<br>$$</p>
<p>于是</p>
<p>$$<br>J_i &#x3D; [\frac{\partial e_i}{\partial a}, \frac{\partial e_i}{\partial b}, \frac{\partial e_i}{\partial c}]<br>$$</p>
<p>高斯牛顿法的增量方程为：</p>
<p>$$<br>\big( \sum_{i&#x3D;1}{100} J_i(\sigma^2)^{-1} J_i^T \big)<br>\Delta x_k &#x3D;<br>\sum_{i&#x3D;1}^{100} -  J_i(\sigma^2)^-1 e_i</p>
<p>$$</p>
<p>也可以选择把所有的J<em>i</em> 排成一列，将这个方程写成矩阵形式，它的含义与求和形式是一致的。下面的代码演示了这个过程是如何进行的：&gt; slambook2&#x2F;ch6&#x2F;gaussNewton.cpp</p>
<p>在这个例子中演示了如何对一个简单的拟合问题进行迭代优化。该程序输出每一步迭代的目标函数值和更新量，如下：</p>
<p>整个问题的目标函数在迭代 9 次之后趋近收敛，更新量趋近于零。最终估计的值与真值接近，函数图像如下：</p>
<p>蓝色点为100个数据点，黑色线为理论模型，红色线为拟合的模型。</p>
<h3 id="3-2使用-Ceres-进行曲线拟合"><a href="#3-2使用-Ceres-进行曲线拟合" class="headerlink" title="3.2使用 Ceres 进行曲线拟合"></a>3.2使用 Ceres 进行曲线拟合</h3><p>Google Ceres 是一个广泛使用的最小二乘问题求解库。在 Ceres 中，只需按照一定步骤定义待解的优化问题，然后交给求解器计算即可。Ceres 求解的最小二乘问题最一般的形式如下（带边界的核函数最小二乘）：</p>
<p>$$<br>\min_{x} 1&#x2F;2 \sum_{j} p_i (|| f_i (x_{i_1}, …, x_{i_n}) ||^2)<br>\<br>s.t. \qquad l_j \leq x_j \leq u_j.</p>
<p>$$</p>
<p>在这个问题中，<em>x</em>1*,<em>··· <em>,xn</em> 为优化变量，又称参数块（Parameter blocks），<em>fi</em> 称为代价函数（Cost function），也称为残差块（Residual blocks），在 SLAM 中也可理解为误差项。<em>lj</em> 和 <em>uj</em> 为第 <em>j</em> 个优化变量的上限和下限。在最简单的情况下，取 <em>lj</em> &#x3D; −∞</em>,uj* &#x3D; ∞（不限制优化变量的边界）。此时，目标函数由许多平方项经过一个<strong>核函数</strong> ρ(·) 之后求和组成。取 <em>ρ</em> 为恒等函数，那么目标函数即为许多项的平方和，就得到了无约束的最小二乘问题。为了让 Ceres 求解这个问题，需要做以下几件事：</p>
<ol>
<li>定义每个参数块。参数块通常为向量，但是在SLAM里也可以定义成四元数、李代数这种特殊的结构。如果是向量，那么需要为每个参数块分配一个 double 数组，来存储变量的值。</li>
<li>然后定义残差块的计算方式。残差块通常关联若干个参数块，对它们进行一些自定义的计算，然后返回残差值。Ceres 对它们求平方和之后，作为目标函数的值。</li>
<li>残差块往往也需要定义雅可比的计算方式。在 Ceres 中，可以使用自动求导功能，也可以手动指定雅可比的计算过程。如果要使用自动求导，那么残差块需要按照特定的写法来书写：残差的计算过程是一个带模板的括号运算符。</li>
<li>最后，把所有的参数块和残差块加入 Ceres 定义的 Problem 对象中，调用 Solve 函数求解即可。求解之前，可以传入一些配置信息，例如迭代次数、终止条件等，也可以使用默认的配置。</li>
</ol>
<h4 id="安装-Ceres"><a href="#安装-Ceres" class="headerlink" title="安装 Ceres"></a>安装 Ceres</h4><p>Ceres 的 github 地址为：<a target="_blank" rel="noopener" href="https://github.com/ceres-solver/ceres-solver">ceres-solver&#x2F;ceres-solver</a>，</p>
<p>安装依赖项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt−get install liblapack−dev libsuitesparse−dev libcxsparse3 \</span><br><span class="line">         libgflags−dev libgoogle−glog−dev libgtest−dev  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt install liblapack-dev libsuitesparse-dev libcxsparse3.1.4 \</span><br><span class="line">        libgflags-dev libgoogle-glog-dev libgtest-dev </span><br></pre></td></tr></table></figure>

<p>然后进入 Ceres 库目录下，使用 cmake 编译并安装。安装完成后，在&#x2F;usr&#x2F;local&#x2F;include&#x2F;ceres 下找到 Ceres 的头文件，并在&#x2F;usr&#x2F;local&#x2F;lib&#x2F;下找到名为 libceres.a 的库文件。有了这些文件，就可以使用 Ceres 进行优化计算了。</p>
<h4 id="使用-Ceres-拟合曲线"><a href="#使用-Ceres-拟合曲线" class="headerlink" title="使用 Ceres 拟合曲线"></a>使用 Ceres 拟合曲线</h4><p>下面的代码演示了如何使用 Ceres 求解同样的问题：slambook&#x2F;ch6&#x2F;ceresCurveFitting.cpp</p>
<p>利用 OpenCV 的噪声生成器生成了 100 个带高斯噪声的数据，随后利用 Ceres 进行拟合。这里Ceres用法有如下几项：</p>
<ol>
<li>定义残差块的类。方法是书写一个类（或结构体），并在类中定义带模板参数的 () 运算符，这样该类就成为了一个拟函数（Functor），或者叫仿函数。这种定义方式使得 Ceres 可以像调用函数一样，对该类的某个对象（比如 a）调用 a<double>() 方法。Ceres 会把雅可比矩阵作为类型参数传入此函数，从而实现自动求导的功能。</double></li>
<li>程序中的 double abc[3] 即为参数块，而对于残差块，对每一个数据构造 CURVE_FIT-TING_COST 对象，然后调用 AddResidualBlock 将误差项添加到目标函数中。由于优化需要梯度，有若干种选择：（1）使用 Ceres 的自动求导（Auto Diff）；（2）使用数值求导（Numeric Diff）；（3）自行推导解析的导数形式，提供给 Ceres。</li>
<li>自动求导需要指定误差项和优化变量的维度。这里的误差是标量，维度为 1；优化的是 <em>a,b,c</em> 三个量，维度为 3。于是，在自动求导类 AutoDiffCostFunction 的模板参数中设定变量维度为 1、3。</li>
<li>设定好问题后，调用 Solve 函数进行求解。可以在options里配置优化选项。例如，可以选择使用 Line Search 还是 Trust Region、迭代次数、步长，等等。可以查看 Options 的定义，看看有哪些优化方法可选，一般默认的配置已经可用于很广泛的问题了。</li>
</ol>
<p>最终的优化值和手写的基本相同，但运行速度上 Ceres 要相对慢一些。</p>
<p>Ceres的优点是提供了自动求导工具，不必去计算很麻烦的雅可比矩阵。Ceres的自动求导是通过模板元实现的，在编译时期就可以完成自动求导工作，不过仍然是数值导数。此外，Ceres的优化过程配置也很丰富，使其适合很广泛的最小二乘优化问题，包括 SLAM 之外的各种问题。</p>
<p>注：自动求导也是用数值导数实现的。</p>
<ul>
<li><input checked disabled type="checkbox"> 代码实现</li>
</ul>
<h3 id="3-3使用-g2o-进行曲线拟合"><a href="#3-3使用-g2o-进行曲线拟合" class="headerlink" title="3.3使用 g2o 进行曲线拟合"></a>3.3使用 g2o 进行曲线拟合</h3><p>g2o（General Graphic Optimization，G2O）是在SLAM领域广为使用的优化库。它是一个基于<strong>图优化</strong>的库。图优化是一种将非线性优化与图论结合起来的理论。</p>
<p><strong>图优化理论简介</strong></p>
<p>前面介绍了非线性最小二乘的求解方式。它们是由很多个误差项之和组成的。然而，仅有一组优化变量和许多个误差项，并不清楚它们之间的关联。比如，某个优化变量xj存在于多少个误差项中呢？能保证对它的优化是有意义的吗？进一步，希望能够直观地看到该优化问题长什么样。于是，就引出了图优化。</p>
<p>图优化，是把优化问题表现成图（Graph）的一种方式。这里的图是图论意义上的图。一个图由若干个顶点（Vertex），以及连接着这些顶点的边（Edge）组成。进而，用顶点表示优化变量，用边表示误差项。于是，对任意一个上述形式的非线性最小二乘问题，可以构建与之对应的一个图。可以简单地称它为图，也可以用概率图里的定义，称之为贝叶斯图或因子图。</p>
<p>如下图：</p>
<p><img src="/2022/07/20/Course/SLAM/ch06_Ceres_g2o/2022-08-01-20-20-00-image.png"></p>
<p>用三角形表示相机位姿节点，用圆形表示路标点，它们构成了图优化的顶点；同时，实线表示相机的运动模型，虚线表示观测模型，它们构成了图优化的边。最基本的图优化是用图模型来表达一个非线性最小二乘的优化问题，可以利用图模型的某些性质做更好的优化。</p>
<p>g2o 是一个通用的图优化库，可以在g2o里求解任何能够表示为图优化的最小二乘问题，包括<strong>曲线拟合问题</strong>。</p>
<h4 id="g2o-的编译与安装"><a href="#g2o-的编译与安装" class="headerlink" title="g2o 的编译与安装"></a>g2o 的编译与安装</h4><p>安装依赖：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt−get install qt5−qmake qt5−default libqglviewer−dev−qt5 libsuitesparse−dev libcxsparse3 libcholmod3</span><br></pre></td></tr></table></figure>

<p>从GitHub下载并cmake安装：<a target="_blank" rel="noopener" href="https://github.com/RainerKuemmerle/g2o">https://github.com/RainerKuemmerle/g2o</a></p>
<p>安装完成后， g2o 的头文件将位于&#x2F;usr&#x2F;local&#x2F;g2o 下，库文件位于&#x2F;usr&#x2F;local&#x2F;lib&#x2F;下</p>
<p><strong>使用 g2o 拟合曲线</strong></p>
<p>首先要将曲线拟合问题抽象成图优化。这个过程中，节点为优化变量， 边为误差项。</p>
<p>在曲线拟合问题中，整个问题只有一个顶点：曲线模型的参数 a, b, c；而各个带噪声的数据点， 构成了一个个误差项，也就是图优化的边。这里的边是一元边（Unary Edge），即只连接一个顶点。事实上，图优化中一条边可以连接一个、两个或多个顶点，这主要反映每个误差与多少个优化变量有关。</p>
<p>主要步骤：</p>
<ol>
<li>定义顶点和边的类型。</li>
<li>构建图。</li>
<li>选择优化算法。</li>
<li>调用g2o进行优化，返回结果。</li>
</ol>
<p>程序：slambook&#x2F;ch6&#x2F;g2oCurveFitting.cpp</p>
<p>在这个程序中，从g2o派生出了用于曲线拟合的图优化顶点和边：CurveFittingVertex 和 CurveFittingEdge，这实质上扩展了g2o的使用方式。这两个类分别派生于BaseVertex和BaseUnaryEdge类。在派生类中，重写了重要的虚函数：</p>
<ol>
<li>顶点的更新函数：oplusImpl。优化过程最重要的是增量∆x的计算，而该函数处理的是 xk+1 &#x3D; xk + ∆x 的过程。在曲线拟合过程中，由于优化变量（曲线参数）本身位于向量空间中，这个更新计算就是简单的加法。但是当优化变量不在向量空间中时，比如x是相机位姿，它本身不一定有加法运算。这时就需要重新定义增量如何加到现有的估计上的行为了。</li>
<li>顶点的重置函数：setToOriginImpl。即把估计值置零即可。</li>
<li>边的误差计算函数：computeError。该函数需要取出边所连接的顶点的当前估计值，根据曲线模型，与它的观测值进行比较。这和最小二乘问题中的误差模型是一致的。</li>
<li>边的雅可比计算函数：linearizeOplus。这个函数里计算了每条边相对于顶点的雅可比。</li>
<li>存盘和读盘函数：read、write。</li>
</ol>
<p>定义了顶点和边之后，在main函数里声明了一个图模型，然后按照生成的噪声数据，往图模型中添加顶点和边，最后调用优化函数进行优化。g2o会给出优化的结果。</p>
<p>    第一版书代码Debug：</p>
<p><a target="_blank" rel="noopener" href="https://www.codeleading.com/article/14861493981/">《视觉SLAM十四讲》 g2o实践代码报错解决方法（第六讲为例） - 代码先锋网</a></p>
<h2 id="4-小结"><a href="#4-小结" class="headerlink" title="4 小结"></a>4 小结</h2><p>非线性优化问题：<u>由许多个误差项平方和组成的最小二乘问题</u>。讨论了两种主要的梯度下降方式：高斯牛顿法和列文伯格 —马夸尔特方法。在实践部分中，分别使用了手写高斯牛顿法、Ceres 和 g2o 两种优化库求解同一个 曲线拟合问题，发现结果相似。 特别地，<u>如果用g2o来拟合曲线，必须先把问题转换为图优化，定义新的顶点和边。</u>相比之下，Ceres 定义误差项求曲线拟合问题则自然了很多，因为它本身即是一个优化库。然而，在 SLAM 中更多的问题是，一个带有许多个相机位姿和许多个空间点的优化问题如何求解。特别地，当相机位姿以李代数表示时，误差项关于相机位姿的导数如何计算。g2o提供了大量现成的顶点和边，非常便于相机位姿估计问题。而在 Ceres 中， 不得不自己实现每一个Cost Function，有一些不便。</p>
<p>Ceres 库提供了基于模板元的自动求导和运行时的数值求导，而 g2o 只提供了运行时数值求导这一种方式。但是对于大多数问题，如果能够推导出雅可比矩阵的解析形式并告诉优化库，就可以避免数值求导中的诸多问题。</p>
<blockquote>
<p>非线性拟合（曲线拟合）</p>
</blockquote>
<table>
<thead>
<tr>
<th>非线性优化<br>梯度下降法</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>高斯牛顿法</td>
<td></td>
</tr>
<tr>
<td>列文伯格-马夸尔特法</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>工具库</th>
<th>特性</th>
<th>求导</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>Ceres</td>
<td>-</td>
<td>（自动求导）基于模板元的自动求导和运行时的数值求导</td>
<td></td>
</tr>
<tr>
<td>G2o</td>
<td>提供了大量现成的顶点和边，非常便于相机位姿估计问题</td>
<td>运行时数值求导这一种方式</td>
<td>必须先把问题转换为图优化，定义新的顶点和边</td>
</tr>
</tbody></table>
<h2 id="习题"><a href="#习题" class="headerlink" title="习题"></a>习题</h2><ol>
<li>证明线性方程 Ax &#x3D; b 当系数矩阵 A 超定时，最小二乘解为 x &#x3D; (ATA) −1ATb。</li>
<li>调研最速下降法、牛顿法、高斯牛顿法和列文伯格—马夸尔特方法各有什么优缺点。</li>
<li>为什么高斯牛顿法的增量方程系数矩阵可能不正定？不正定有什么几何含义？为什么在这种情况下解就不稳定了？</li>
<li>DogLeg 是什么？它与高斯牛顿法和列文伯格—马夸尔特方法有何异同？</li>
<li>阅读 Ceres 的教学材料（<a href="https://link.zhihu.com/?target=http://ceres-solver.org/tutorial.html">http://ceres-solver.org/tutorial.html</a>）以更好地掌握其用法。</li>
<li>阅读 g2o 自带的文档 。</li>
<li>更改曲线拟合实验中的曲线模型，并用 Ceres 和 g2o 进行优化实验。</li>
</ol>
<h2 id="笔记总结"><a href="#笔记总结" class="headerlink" title="笔记总结"></a>笔记总结</h2><h3 id="笔记总结（1）—非线性优化原理"><a href="#笔记总结（1）—非线性优化原理" class="headerlink" title="笔记总结（1）—非线性优化原理"></a>笔记总结（1）—非线性优化原理</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/462463343">https://zhuanlan.zhihu.com/p/462463343</a></p>
<h3 id="笔记总结（2）—非线性优化应用"><a href="#笔记总结（2）—非线性优化应用" class="headerlink" title="笔记总结（2）—非线性优化应用"></a>笔记总结（2）—非线性优化应用</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/462932847">https://zhuanlan.zhihu.com/p/462932847</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/448550039">视觉SLAM十四讲学习笔记-第六讲-非线性优化的状态估计问题</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/450299798">视觉SLAM十四讲学习笔记-第六讲-非线性优化的非线性最小二乘问题</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/455852322">视觉SLAM十四讲学习笔记-第六讲-非线性优化的实践-高斯牛顿法和曲线拟合</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/462463343"> 笔记总结（1）—非线性优化原理</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/462932847"> 笔记总结（2）—非线性优化应用</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/12/Sub_Language/CPlus/Cplus_TCP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/12/Sub_Language/CPlus/Cplus_TCP/" class="post-title-link" itemprop="url">C++ 网络编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-12 12:00:00" itemprop="dateCreated datePublished" datetime="2022-07-12T12:00:00+00:00">2022-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:40" itemprop="dateModified" datetime="2025-08-06T08:16:40+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>outlook:</p>
<p>[TOC]</p>
<h1 id="数据转换"><a href="#数据转换" class="headerlink" title="数据转换"></a>数据转换</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/PuttyTree/article/details/7825709">C++: byte和int的相互转化_PuttyTree的博客-CSDN博客_c++ byte转int</a></p>
<h1 id="C-sockt"><a href="#C-sockt" class="headerlink" title="C++ sockt"></a>C++ sockt</h1><h2 id="recv"><a href="#recv" class="headerlink" title="recv"></a>recv</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> bufLen = <span class="number">256</span>;</span><br><span class="line"><span class="type">char</span> buffer[bufLen];</span><br><span class="line"><span class="type">int</span> resultLen = <span class="built_in">recv</span>(sclient, buffer, bufLen, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="FIX-01-“undefined-reference-to-imp-WSAStartup’”"><a href="#FIX-01-“undefined-reference-to-imp-WSAStartup’”" class="headerlink" title="FIX-01 “undefined reference to __imp_WSAStartup’”"></a>FIX-01 “undefined reference to __imp_WSAStartup’”</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--# VS task.xml配置修改：--&gt;</span></span><br><span class="line">  &quot;args&quot;: [</span><br><span class="line">     &quot;C:/Program Files (x86)/Windows Kits/10/Lib/10.0.19041.0/um/x64/WS2_32.Lib&quot;,</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<h1 id="Windows-网络编程"><a href="#Windows-网络编程" class="headerlink" title="Windows 网络编程"></a>Windows 网络编程</h1><p>阻塞模式开发（执行I&#x2F;O操作时，线程被阻塞调用）</p>
<p>非阻塞模式开发（执行I&#x2F;O操作时，立即返回，但是要处理返回错误的问题）</p>
<p>套接字Select模型（常见的I&#x2F;O模型）</p>
<h2 id="UDP-Send-Recv-Text"><a href="#UDP-Send-Recv-Text" class="headerlink" title="UDP (Send&#x2F;Recv Text)"></a>UDP (Send&#x2F;Recv Text)</h2><h3 id="Sever"><a href="#Sever" class="headerlink" title="Sever"></a>Sever</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsd; </span><br><span class="line">    SOCKET  s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>,<span class="number">2</span>), &amp;wsd) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;WSA Start UP faild&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// socket creat</span></span><br><span class="line">    s = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (s == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;socket() failed &quot;</span> &lt;&lt; <span class="built_in">WSAGetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// socket bind</span></span><br><span class="line">    SOCKADDR_IN  servAddr;</span><br><span class="line">    servAddr.sin_family = AF_INET;</span><br><span class="line">    servAddr.sin_port = <span class="built_in">htons</span>((<span class="type">short</span>) <span class="number">5000</span>);        <span class="comment">// PORT</span></span><br><span class="line">    servAddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);   <span class="comment">// IP</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(s, (SOCKADDR*)&amp;servAddr, <span class="built_in">sizeof</span>(servAddr)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;bind() failed &quot;</span> &lt;&lt; <span class="built_in">WSAGetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(s);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recv</span></span><br><span class="line">    <span class="type">int</span> BUF_SIZE = <span class="number">64</span>;</span><br><span class="line">    <span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="comment">// recv</span></span><br><span class="line">    SOCKADDR_IN clientAddr;</span><br><span class="line">    <span class="type">int</span> nClientLen = <span class="built_in">sizeof</span>(clientAddr);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">recvfrom</span>(s, buf, BUF_SIZE, <span class="number">0</span>, (SOCKADDR*)&amp;clientAddr, &amp;nClientLen) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;recefrom() failed &quot;</span> &lt;&lt; <span class="built_in">WSAGetLastError</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(s);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; clientAddr.sin_addr.s_addr &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;recv : &quot;</span> &lt;&lt; buf &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">constructBody</span><span class="params">(string args[<span class="number">2</span>], string file[<span class="number">2</span>])</span></span>;</span><br><span class="line"><span class="function">string <span class="title">readFile</span><span class="params">(string fileName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 5000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HOST <span class="string">&quot;localhost&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RECEIVER <span class="string">&quot;receive_data&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMPNAME <span class="string">&quot;compname&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROGRAM <span class="string">&quot;program&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILENAME <span class="string">&quot;file&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOUNDARY <span class="string">&quot;--------FVIAlihiu&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DUMMY_DATA <span class="string">&quot;-todo&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DUMMY_FILE <span class="string">&quot;dummy.txt&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief Windows SOcket 网络开发</span></span><br><span class="line"><span class="comment">///     ref : http://9v.lt/blog/sending-multipart-post-requests-c/</span></span><br><span class="line"><span class="comment">/// @return</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SOCKET dataSock;</span><br><span class="line">    WSADATA wasData;</span><br><span class="line">    <span class="type">int</span> error = <span class="built_in">WSAStartup</span>(<span class="number">0x0202</span>, &amp;wasData);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// dataSock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span></span><br><span class="line">    dataSock = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (dataSock == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN target;</span><br><span class="line">    target.sin_family = AF_INET;</span><br><span class="line">    target.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">    target.sin_addr.s_addr = <span class="built_in">inet_addr</span>(IP);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(dataSock, (SOCKADDR*)&amp;target, <span class="built_in">sizeof</span>(target));</span><br><span class="line"></span><br><span class="line">    string programNames[<span class="number">1</span>][<span class="number">2</span>] = &#123;&#123;<span class="string">&quot;KULVERTOP&quot;</span>, <span class="string">&quot;Chrome&quot;</span>&#125;&#125;;</span><br><span class="line">    string file[<span class="number">2</span>] = &#123;FILENAME, <span class="string">&quot;Default.txt&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="built_in">sizeof</span>( programNames)/<span class="built_in">sizeof</span>( programNames[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; a; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Send data for &quot;</span> &lt;&lt; programNames[i][<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">        string body = <span class="built_in">constructBody</span>(programNames[i], file);</span><br><span class="line">        <span class="type">char</span> header[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// cout &lt;&lt; header</span></span><br><span class="line">        <span class="built_in">sprintf</span>(header, <span class="string">&quot;POST %s HTTP1.1 \r\n&quot;</span></span><br><span class="line">                        <span class="string">&quot;Host: %s\r\n&quot;</span></span><br><span class="line">                        <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">                        <span class="string">&quot;Content-Type: multipart/from-data; boundary=%s\r\n&quot;</span></span><br><span class="line">                        <span class="string">&quot;Accept-Charset: utf-8\r\n\r\n&quot;</span>,</span><br><span class="line">                RECEIVER, IP, <span class="built_in">strlen</span>(body.<span class="built_in">c_str</span>()), BOUNDARY);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; header &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// int p = send(dataSock, header, strlen(header), 0);</span></span><br><span class="line">        <span class="comment">// int k = send(dataSock, body.c_str(), strlen(body.c_str()), 0);</span></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">64</span>] = <span class="string">&quot;My UDP&quot;</span>;</span><br><span class="line">        <span class="comment">// int t = send(dataSock, buf, strlen(buf), 0);</span></span><br><span class="line">        <span class="type">int</span> t = <span class="built_in">send</span>(dataSock, buf, <span class="number">64</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(dataSock);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">readFile</span><span class="params">(string file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string fileContents;</span><br><span class="line">    <span class="function">ifstream <span class="title">tmp</span><span class="params">(file.c_str())</span></span>;</span><br><span class="line">    <span class="built_in">getline</span>(tmp, fileContents);</span><br><span class="line">    tmp.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fileContents;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">constructBody</span><span class="params">(string args[<span class="number">2</span>], string file[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string body;</span><br><span class="line">    string CRLF = <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// first we add the args</span></span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;--&quot;</span> + <span class="built_in">string</span>(BOUNDARY) + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;Content-Disposition: from-data; name=\&quot;&quot;</span> + <span class="built_in">string</span>(COMPNAME) + <span class="string">&quot;\&quot;&quot;</span> + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(args[<span class="number">0</span>] + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;--&quot;</span> + <span class="built_in">string</span>(BOUNDARY) + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;Content-Disposition: from-data; name=\&quot;&quot;</span> + <span class="built_in">string</span>(PROGRAM) + <span class="string">&quot;\&quot;&quot;</span> + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(args[<span class="number">1</span>] + CRLF);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now we add the file</span></span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;--&quot;</span> + <span class="built_in">string</span>(BOUNDARY) + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;Content-Disposition: from-data; name=\&quot;&quot;</span> + <span class="built_in">string</span>(FILENAME) + <span class="string">&quot;\&quot;; filename=\&quot;&quot;</span> + <span class="built_in">string</span>(DUMMY_FILE) + <span class="string">&quot;\&quot;&quot;</span> + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;Content-Type:text/plain&quot;</span> + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(<span class="string">&quot;--&quot;</span> + <span class="built_in">string</span>(BOUNDARY) + <span class="string">&quot;--&quot;</span> + CRLF);</span><br><span class="line">    body.<span class="built_in">append</span>(CRLF);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="demo-Socket文件传输"><a href="#demo-Socket文件传输" class="headerlink" title="demo::Socket文件传输"></a>demo::Socket文件传输</h1><table>
<thead>
<tr>
<th></th>
<th>Client</th>
<th>Server</th>
</tr>
</thead>
<tbody><tr>
<td>Method-1</td>
<td>发送4字节（的文件长度）+文件的内容String</td>
<td>接受对应格式的文件</td>
</tr>
<tr>
<td>Method-2</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h1 id="LINUX网络编程"><a href="#LINUX网络编程" class="headerlink" title="LINUX网络编程"></a>LINUX网络编程</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_48243698/article/details/123510416">c++网络编程基础知识总结_你最特别17的博客-CSDN博客_网络口c++</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cppblog.com/markqian86/archive/2020/04/24/217259.html">EPOLLIN , EPOLLOUT , EPOLLPRI, EPOLLERR 和 EPOLLHUP事件</a></p>
<p>poll()函数<a target="_blank" rel="noopener" href="http://www.cppblog.com/myjfm/archive/2011/10/26/159093.aspx">ref</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POLLIN:                有普通数据或者优先数据可读</span><br><span class="line">POLLRDNORM:    有普通数据可读</span><br><span class="line">POLLRDBAND:    有优先数据可读</span><br><span class="line">POLLPRI:              有紧急数据可读</span><br><span class="line">POLLOUT:            有普通数据可写</span><br><span class="line">POLLWRNORM:   有普通数据可写</span><br><span class="line">POLLWRBAND:    有紧急数据可写</span><br><span class="line">POLLERR:            有错误发生</span><br><span class="line">POLLHUP:            有描述符挂起事件发生</span><br><span class="line">POLLNVAL:          描述符非法</span><br></pre></td></tr></table></figure>

<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//client Linux </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;this is client&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="type">int</span> client = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(client == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot; socket err &quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serverAddr;</span><br><span class="line">    serverAddr.sin_family = AF_INET;</span><br><span class="line">    serverAddr.sin_port = <span class="built_in">htons</span>(<span class="number">7637</span>);</span><br><span class="line">    serverAddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">connect</span>(client, (<span class="keyword">struct</span> sockaddr_in*) &amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;connect err&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;connect ....&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">255</span>];</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cin &gt;&gt; data;</span><br><span class="line">        <span class="built_in">send</span>(client, data, <span class="built_in">strlen</span>(data), <span class="number">0</span>);   </span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(data, <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(data, <span class="string">&quot;EXIT&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;client disconnect ...&quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span> ,<span class="built_in">sizeof</span>(buf));</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">recv</span>(client, buf, <span class="built_in">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">        buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; buf &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(client);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server linux </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;this is server&quot;</span> &lt;&lt;endl;</span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;socker err &quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> addr;</span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(<span class="number">7637</span>);</span><br><span class="line">    addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*) &amp;addr,<span class="built_in">sizeof</span>(addr)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;bind err&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd , <span class="number">5</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt;<span class="string">&quot;listen err&quot;</span> &lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> conn;</span><br><span class="line">    <span class="type">char</span> clientIP[INET_ADDRSTRLEN] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> clientAddr;</span><br><span class="line">    <span class="type">socklen_t</span> clinetAddrLen = <span class="built_in">sizeof</span>(clientAddr);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;listen ....&quot;</span> &lt;&lt;endl;</span><br><span class="line">        conn = <span class="built_in">accept</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;clientAddr, &amp;clinetAddrLen);</span><br><span class="line">        <span class="keyword">if</span>(conn &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt;<span class="string">&quot;conn accept err &quot;</span> &lt;&lt;endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inet_ntop</span>(AF_INET, &amp;clientAddr.sin_addr, clientIP, INET_ADDRSTRLEN);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot; connect &quot;</span> &lt;&lt; clientIP &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">ntohs</span>(clientAddr.sin_port) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memset</span>(buf, <span class="number">0</span> , <span class="built_in">sizeof</span>(buf));</span><br><span class="line">            <span class="type">int</span> len = <span class="built_in">recv</span>(conn, buf, <span class="built_in">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">            buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(buf,<span class="string">&quot;exit&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(buf,<span class="string">&quot;EXIT&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;disconnect &quot;</span> &lt;&lt; clientIP &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt;<span class="built_in">ntohs</span>(clientAddr.sin_port) &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cout &lt;&lt; buf &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">send</span>(conn, buf, len,<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(conn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Kiris_king/article/details/128096893">C++ socket demo_andyleung520的博客-CSDN博客_c++ socket demo</a></p>
<h1 id="C-Http"><a href="#C-Http" class="headerlink" title="C++ Http"></a>C++ Http</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Blejixiang/article/details/127830555">C++ 发送HTTP请求_BUG·搬运工的博客-CSDN博客_c++ http请求</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HTTPRequest.hpp&quot;</span> <span class="comment">//相关源码在文章末尾</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意：URI地址必须以 http:// 开头，否则不符合头文件校验规则</span></span><br><span class="line">string uri = <span class="string">&quot;http://en.xxx.com/api-ctl/client/health/&quot;</span>;</span><br><span class="line">string method = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">string arguments = <span class="built_in">string_To_UTF8</span>((<span class="type">char</span>*)encryptStr.<span class="built_in">c_str</span>());</span><br><span class="line"><span class="keyword">auto</span> protocol = http::InternetProtocol::V4;</span><br><span class="line">http::Request req&#123; uri, protocol &#125;;</span><br><span class="line"></span><br><span class="line">json responseJson;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> response = req.<span class="built_in">send</span>(method, arguments, &#123;</span><br><span class="line">    &#123;<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;runscope/0.1&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;*/*&quot;</span>&#125;</span><br><span class="line">        &#125;, std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>));</span><br><span class="line">    responseJson = json::<span class="built_in">parse</span>(string&#123; response.body.<span class="built_in">begin</span>(), response.body.<span class="built_in">end</span>() &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">catch</span> (exception&amp; e) &#123;</span><br><span class="line">    <span class="comment">//捕获请求失败异常，处理逻辑自行添加</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HTTPRequest-hpp"><a href="#HTTPRequest-hpp" class="headerlink" title="HTTPRequest.hpp"></a>HTTPRequest.hpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  HTTPRequest</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HTTPREQUEST_HPP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HTTPREQUEST_HPP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;system_error&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">pragma</span> push_macro(<span class="string">&quot;WIN32_LEAN_AND_MEAN&quot;</span>)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">pragma</span> push_macro(<span class="string">&quot;NOMINMAX&quot;</span>)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">ifndef</span> WIN32_LEAN_AND_MEAN</span></span><br><span class="line"><span class="meta">#    <span class="keyword">define</span> WIN32_LEAN_AND_MEAN</span></span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span> <span class="comment">// WIN32_LEAN_AND_MEAN</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">ifndef</span> NOMINMAX</span></span><br><span class="line"><span class="meta">#    <span class="keyword">define</span> NOMINMAX</span></span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span> <span class="comment">// NOMINMAX</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">if</span> _WIN32_WINNT &lt; _WIN32_WINNT_WINXP</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">char</span> *_strdup(<span class="type">const</span> <span class="type">char</span> *strSource);</span><br><span class="line"><span class="meta">#    <span class="keyword">define</span> strdup _strdup</span></span><br><span class="line"><span class="meta">#    <span class="keyword">include</span> <span class="string">&lt;wspiapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span> <span class="comment">// _WIN32_WINNT &lt; _WIN32_WINNT_WINXP</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">pragma</span> pop_macro(<span class="string">&quot;WIN32_LEAN_AND_MEAN&quot;</span>)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">pragma</span> pop_macro(<span class="string">&quot;NOMINMAX&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> http</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">RequestError</span> <span class="keyword">final</span>: <span class="keyword">public</span> std::logic_error</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">using</span> std::logic_error::logic_error;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ResponseError</span> <span class="keyword">final</span>: <span class="keyword">public</span> std::runtime_error</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">using</span> std::runtime_error::runtime_error;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">InternetProtocol</span>: std::<span class="type">uint8_t</span></span><br><span class="line">    &#123;</span><br><span class="line">        V4,</span><br><span class="line">        V6</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Uri</span> <span class="keyword">final</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::string scheme;</span><br><span class="line">        std::string user;</span><br><span class="line">        std::string password;</span><br><span class="line">        std::string host;</span><br><span class="line">        std::string port;</span><br><span class="line">        std::string path;</span><br><span class="line">        std::string query;</span><br><span class="line">        std::string fragment;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">HttpVersion</span> <span class="keyword">final</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint16_t</span> major;</span><br><span class="line">        <span class="type">uint16_t</span> minor;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Status</span> <span class="keyword">final</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// RFC 7231, 6. Response Status Codes</span></span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">Code</span>: std::<span class="type">uint16_t</span></span><br><span class="line">        &#123;</span><br><span class="line">            Continue = <span class="number">100</span>,</span><br><span class="line">            SwitchingProtocol = <span class="number">101</span>,</span><br><span class="line">            Processing = <span class="number">102</span>,</span><br><span class="line">            EarlyHints = <span class="number">103</span>,</span><br><span class="line"></span><br><span class="line">            Ok = <span class="number">200</span>,</span><br><span class="line">            Created = <span class="number">201</span>,</span><br><span class="line">            Accepted = <span class="number">202</span>,</span><br><span class="line">            NonAuthoritativeInformation = <span class="number">203</span>,</span><br><span class="line">            NoContent = <span class="number">204</span>,</span><br><span class="line">            ResetContent = <span class="number">205</span>,</span><br><span class="line">            PartialContent = <span class="number">206</span>,</span><br><span class="line">            MultiStatus = <span class="number">207</span>,</span><br><span class="line">            AlreadyReported = <span class="number">208</span>,</span><br><span class="line">            ImUsed = <span class="number">226</span>,</span><br><span class="line"></span><br><span class="line">            MultipleChoice = <span class="number">300</span>,</span><br><span class="line">            MovedPermanently = <span class="number">301</span>,</span><br><span class="line">            Found = <span class="number">302</span>,</span><br><span class="line">            SeeOther = <span class="number">303</span>,</span><br><span class="line">            NotModified = <span class="number">304</span>,</span><br><span class="line">            UseProxy = <span class="number">305</span>,</span><br><span class="line">            TemporaryRedirect = <span class="number">307</span>,</span><br><span class="line">            PermanentRedirect = <span class="number">308</span>,</span><br><span class="line"></span><br><span class="line">            BadRequest = <span class="number">400</span>,</span><br><span class="line">            Unauthorized = <span class="number">401</span>,</span><br><span class="line">            PaymentRequired = <span class="number">402</span>,</span><br><span class="line">            Forbidden = <span class="number">403</span>,</span><br><span class="line">            NotFound = <span class="number">404</span>,</span><br><span class="line">            MethodNotAllowed = <span class="number">405</span>,</span><br><span class="line">            NotAcceptable = <span class="number">406</span>,</span><br><span class="line">            ProxyAuthenticationRequired = <span class="number">407</span>,</span><br><span class="line">            RequestTimeout = <span class="number">408</span>,</span><br><span class="line">            Conflict = <span class="number">409</span>,</span><br><span class="line">            Gone = <span class="number">410</span>,</span><br><span class="line">            LengthRequired = <span class="number">411</span>,</span><br><span class="line">            PreconditionFailed = <span class="number">412</span>,</span><br><span class="line">            PayloadTooLarge = <span class="number">413</span>,</span><br><span class="line">            UriTooLong = <span class="number">414</span>,</span><br><span class="line">            UnsupportedMediaType = <span class="number">415</span>,</span><br><span class="line">            RangeNotSatisfiable = <span class="number">416</span>,</span><br><span class="line">            ExpectationFailed = <span class="number">417</span>,</span><br><span class="line">            MisdirectedRequest = <span class="number">421</span>,</span><br><span class="line">            UnprocessableEntity = <span class="number">422</span>,</span><br><span class="line">            Locked = <span class="number">423</span>,</span><br><span class="line">            FailedDependency = <span class="number">424</span>,</span><br><span class="line">            TooEarly = <span class="number">425</span>,</span><br><span class="line">            UpgradeRequired = <span class="number">426</span>,</span><br><span class="line">            PreconditionRequired = <span class="number">428</span>,</span><br><span class="line">            TooManyRequests = <span class="number">429</span>,</span><br><span class="line">            RequestHeaderFieldsTooLarge = <span class="number">431</span>,</span><br><span class="line">            UnavailableForLegalReasons = <span class="number">451</span>,</span><br><span class="line"></span><br><span class="line">            InternalServerError = <span class="number">500</span>,</span><br><span class="line">            NotImplemented = <span class="number">501</span>,</span><br><span class="line">            BadGateway = <span class="number">502</span>,</span><br><span class="line">            ServiceUnavailable = <span class="number">503</span>,</span><br><span class="line">            GatewayTimeout = <span class="number">504</span>,</span><br><span class="line">            HttpVersionNotSupported = <span class="number">505</span>,</span><br><span class="line">            VariantAlsoNegotiates = <span class="number">506</span>,</span><br><span class="line">            InsufficientStorage = <span class="number">507</span>,</span><br><span class="line">            LoopDetected = <span class="number">508</span>,</span><br><span class="line">            NotExtended = <span class="number">510</span>,</span><br><span class="line">            NetworkAuthenticationRequired = <span class="number">511</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        HttpVersion httpVersion;</span><br><span class="line">        std::<span class="type">uint16_t</span> code;</span><br><span class="line">        std::string reason;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> HeaderField = std::pair&lt;std::string, std::string&gt;;</span><br><span class="line">    <span class="keyword">using</span> HeaderFields = std::vector&lt;HeaderField&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Response</span> <span class="keyword">final</span></span><br><span class="line">    &#123;</span><br><span class="line">        Status status;</span><br><span class="line">        HeaderFields headerFields;</span><br><span class="line">        std::vector&lt;std::<span class="type">uint8_t</span>&gt; body;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">namespace</span> detail</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">WinSock</span> <span class="keyword">final</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">WinSock</span>()</span><br><span class="line">            &#123;</span><br><span class="line">                WSADATA wsaData;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> error = <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">                <span class="keyword">if</span> (error != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;error, std::<span class="built_in">system_category</span>(), <span class="string">&quot;WSAStartup failed&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">LOBYTE</span>(wsaData.wVersion) != <span class="number">2</span> || <span class="built_in">HIBYTE</span>(wsaData.wVersion) != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">WSACleanup</span>();</span><br><span class="line">                    <span class="keyword">throw</span> std::runtime_error&#123;<span class="string">&quot;Invalid WinSock version&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                started = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ~<span class="built_in">WinSock</span>()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (started) <span class="built_in">WSACleanup</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">WinSock</span>(WinSock&amp;&amp; other) <span class="keyword">noexcept</span>:</span><br><span class="line">                started&#123;other.started&#125;</span><br><span class="line">            &#123;</span><br><span class="line">                other.started = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            WinSock&amp; <span class="keyword">operator</span>=(WinSock&amp;&amp; other) <span class="keyword">noexcept</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (&amp;other == <span class="keyword">this</span>) <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">if</span> (started) <span class="built_in">WSACleanup</span>();</span><br><span class="line">                started = other.started;</span><br><span class="line">                other.started = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">bool</span> started = <span class="literal">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">getLastError</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">WSAGetLastError</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="keyword">return</span> errno;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">int</span> <span class="title">getAddressFamily</span><span class="params">(<span class="type">const</span> InternetProtocol internetProtocol)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (internetProtocol == InternetProtocol::V4) ? AF_INET :</span><br><span class="line">                (internetProtocol == InternetProtocol::V6) ? AF_INET6 :</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Unsupported protocol&quot;</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Socket</span> <span class="keyword">final</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">            <span class="keyword">using</span> Type = SOCKET;</span><br><span class="line">            <span class="type">static</span> <span class="keyword">constexpr</span> Type invalid = INVALID_SOCKET;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="keyword">using</span> Type = <span class="type">int</span>;</span><br><span class="line">            <span class="type">static</span> <span class="keyword">constexpr</span> Type invalid = <span class="number">-1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">explicit</span> <span class="title">Socket</span><span class="params">(<span class="type">const</span> InternetProtocol internetProtocol)</span>:</span></span><br><span class="line"><span class="function">                endpoint&#123;</span><span class="built_in">socket</span>(<span class="built_in">getAddressFamily</span>(internetProtocol), SOCK_STREAM, IPPROTO_TCP)&#125;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (endpoint == invalid)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">getLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to create socket&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                ULONG mode = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">ioctlsocket</span>(endpoint, FIONBIO, &amp;mode) != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">close</span>();</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to get socket flags&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> flags = <span class="built_in">fcntl</span>(endpoint, F_GETFL);</span><br><span class="line">                <span class="keyword">if</span> (flags == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">close</span>();</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to get socket flags&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">fcntl</span>(endpoint, F_SETFL, flags | O_NONBLOCK) == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">close</span>();</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to set socket flags&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __APPLE__</span></span><br><span class="line">                <span class="type">const</span> <span class="type">int</span> value = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(endpoint, SOL_SOCKET, SO_NOSIGPIPE, &amp;value, <span class="built_in">sizeof</span>(value)) == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">close</span>();</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to set socket option&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// __APPLE__</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ~<span class="built_in">Socket</span>()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (endpoint != invalid) <span class="built_in">close</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Socket</span>(Socket&amp;&amp; other) <span class="keyword">noexcept</span>:</span><br><span class="line">                endpoint&#123;other.endpoint&#125;</span><br><span class="line">            &#123;</span><br><span class="line">                other.endpoint = invalid;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Socket&amp; <span class="keyword">operator</span>=(Socket&amp;&amp; other) <span class="keyword">noexcept</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (&amp;other == <span class="keyword">this</span>) <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">if</span> (endpoint != invalid) <span class="built_in">close</span>();</span><br><span class="line">                endpoint = other.endpoint;</span><br><span class="line">                other.endpoint = invalid;</span><br><span class="line">                <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr* address, <span class="type">const</span> <span class="type">socklen_t</span> addressSize, <span class="type">const</span> std::<span class="type">int64_t</span> timeout)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">connect</span>(endpoint, address, addressSize);</span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; <span class="built_in">WSAGetLastError</span>() == WSAEINTR)</span><br><span class="line">                    result = ::<span class="built_in">connect</span>(endpoint, address, addressSize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">WSAGetLastError</span>() == WSAEWOULDBLOCK)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">select</span>(SelectType::write, timeout);</span><br><span class="line"></span><br><span class="line">                        <span class="type">char</span> socketErrorPointer[<span class="built_in">sizeof</span>(<span class="type">int</span>)];</span><br><span class="line">                        <span class="type">socklen_t</span> optionLength = <span class="built_in">sizeof</span>(socketErrorPointer);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(endpoint, SOL_SOCKET, SO_ERROR, socketErrorPointer, &amp;optionLength) == <span class="number">-1</span>)</span><br><span class="line">                            <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to get socket option&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                        <span class="type">int</span> socketError;</span><br><span class="line">                        std::<span class="built_in">memcpy</span>(&amp;socketError, socketErrorPointer, <span class="built_in">sizeof</span>(socketErrorPointer));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (socketError != <span class="number">0</span>)</span><br><span class="line">                            <span class="keyword">throw</span> std::system_error&#123;socketError, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to connect&quot;</span>&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to connect&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">connect</span>(endpoint, address, addressSize);</span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                    result = ::<span class="built_in">connect</span>(endpoint, address, addressSize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">select</span>(SelectType::write, timeout);</span><br><span class="line"></span><br><span class="line">                        <span class="type">int</span> socketError;</span><br><span class="line">                        <span class="type">socklen_t</span> optionLength = <span class="built_in">sizeof</span>(socketError);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">getsockopt</span>(endpoint, SOL_SOCKET, SO_ERROR, &amp;socketError, &amp;optionLength) == <span class="number">-1</span>)</span><br><span class="line">                            <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to get socket option&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (socketError != <span class="number">0</span>)</span><br><span class="line">                            <span class="keyword">throw</span> std::system_error&#123;socketError, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to connect&quot;</span>&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to connect&quot;</span>&#125;;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">std::<span class="type">size_t</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* buffer, <span class="type">const</span> std::<span class="type">size_t</span> length, <span class="type">const</span> std::<span class="type">int64_t</span> timeout)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="built_in">select</span>(SelectType::write, timeout);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">send</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                     <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(length), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; <span class="built_in">WSAGetLastError</span>() == WSAEINTR)</span><br><span class="line">                    result = ::<span class="built_in">send</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                    <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(length), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to send data&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">send</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                     length, noSignal);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                    result = ::<span class="built_in">send</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                    length, noSignal);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to send data&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">std::<span class="type">size_t</span> <span class="title">recv</span><span class="params">(<span class="type">void</span>* buffer, <span class="type">const</span> std::<span class="type">size_t</span> length, <span class="type">const</span> std::<span class="type">int64_t</span> timeout)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="built_in">select</span>(SelectType::read, timeout);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">recv</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                     <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(length), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; <span class="built_in">WSAGetLastError</span>() == WSAEINTR)</span><br><span class="line">                    result = ::<span class="built_in">recv</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                    <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(length), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to read data&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                <span class="keyword">auto</span> result = ::<span class="built_in">recv</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                     length, noSignal);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (result == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                    result = ::<span class="built_in">recv</span>(endpoint, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(buffer),</span><br><span class="line">                                    length, noSignal);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to read data&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;std::<span class="type">size_t</span>&gt;(result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="keyword">enum class</span> <span class="title class_">SelectType</span></span><br><span class="line">            &#123;</span><br><span class="line">                read,</span><br><span class="line">                write</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">select</span><span class="params">(<span class="type">const</span> SelectType type, <span class="type">const</span> std::<span class="type">int64_t</span> timeout)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                fd_set descriptorSet;</span><br><span class="line">                <span class="built_in">FD_ZERO</span>(&amp;descriptorSet);</span><br><span class="line">                <span class="built_in">FD_SET</span>(endpoint, &amp;descriptorSet);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                TIMEVAL selectTimeout&#123;</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;LONG&gt;(timeout / <span class="number">1000</span>),</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;LONG&gt;((timeout % <span class="number">1000</span>) * <span class="number">1000</span>)</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">auto</span> count = ::<span class="built_in">select</span>(<span class="number">0</span>,</span><br><span class="line">                                      (type == SelectType::read) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                      (type == SelectType::write) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                      <span class="literal">nullptr</span>,</span><br><span class="line">                                      (timeout &gt;= <span class="number">0</span>) ? &amp;selectTimeout : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (count == <span class="number">-1</span> &amp;&amp; <span class="built_in">WSAGetLastError</span>() == WSAEINTR)</span><br><span class="line">                    count = ::<span class="built_in">select</span>(<span class="number">0</span>,</span><br><span class="line">                                     (type == SelectType::read) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                     (type == SelectType::write) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                     <span class="literal">nullptr</span>,</span><br><span class="line">                                     (timeout &gt;= <span class="number">0</span>) ? &amp;selectTimeout : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">WSAGetLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to select socket&quot;</span>&#125;;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Request timed out&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                timeval selectTimeout&#123;</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;<span class="type">time_t</span>&gt;(timeout / <span class="number">1000</span>),</span><br><span class="line">                    <span class="built_in">static_cast</span>&lt;<span class="type">suseconds_t</span>&gt;((timeout % <span class="number">1000</span>) * <span class="number">1000</span>)</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">auto</span> count = ::<span class="built_in">select</span>(endpoint + <span class="number">1</span>,</span><br><span class="line">                                      (type == SelectType::read) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                      (type == SelectType::write) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                      <span class="literal">nullptr</span>,</span><br><span class="line">                                      (timeout &gt;= <span class="number">0</span>) ? &amp;selectTimeout : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (count == <span class="number">-1</span> &amp;&amp; errno == EINTR)</span><br><span class="line">                    count = ::<span class="built_in">select</span>(endpoint + <span class="number">1</span>,</span><br><span class="line">                                     (type == SelectType::read) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                     (type == SelectType::write) ? &amp;descriptorSet : <span class="literal">nullptr</span>,</span><br><span class="line">                                     <span class="literal">nullptr</span>,</span><br><span class="line">                                     (timeout &gt;= <span class="number">0</span>) ? &amp;selectTimeout : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (count == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">throw</span> std::system_error&#123;errno, std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to select socket&quot;</span>&#125;;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Request timed out&quot;</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">                <span class="built_in">closesocket</span>(endpoint);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                ::<span class="built_in">close</span>(endpoint);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__unix__) &amp;&amp; !defined(__APPLE__) &amp;&amp; !defined(__CYGWIN__)</span></span><br><span class="line">            <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int</span> noSignal = MSG_NOSIGNAL;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">int</span> noSignal = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(__unix__) &amp;&amp; !defined(__APPLE__)</span></span></span><br><span class="line"></span><br><span class="line">            Type endpoint = invalid;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2.3. WhiteSpace</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isWhiteSpaceChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c == <span class="number">0x20</span> || c == <span class="number">0x09</span>; <span class="comment">// space or tab</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 5234, Appendix B.1. Core Rules</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isDigitChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c &gt;= <span class="number">0x30</span> &amp;&amp; c &lt;= <span class="number">0x39</span>; <span class="comment">// 0 - 9</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 5234, Appendix B.1. Core Rules</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isAlphaChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">                (c &gt;= <span class="number">0x61</span> &amp;&amp; c &lt;= <span class="number">0x7A</span>) || <span class="comment">// a - z</span></span><br><span class="line">                (c &gt;= <span class="number">0x41</span> &amp;&amp; c &lt;= <span class="number">0x5A</span>); <span class="comment">// A - Z</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2.6. Field Value Components</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isTokenChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c == <span class="number">0x21</span> || <span class="comment">// !</span></span><br><span class="line">                c == <span class="number">0x23</span> || <span class="comment">// #</span></span><br><span class="line">                c == <span class="number">0x24</span> || <span class="comment">// $</span></span><br><span class="line">                c == <span class="number">0x25</span> || <span class="comment">// %</span></span><br><span class="line">                c == <span class="number">0x26</span> || <span class="comment">// &amp;</span></span><br><span class="line">                c == <span class="number">0x27</span> || <span class="comment">// &#x27;</span></span><br><span class="line">                c == <span class="number">0x2A</span> || <span class="comment">// *</span></span><br><span class="line">                c == <span class="number">0x2B</span> || <span class="comment">// +</span></span><br><span class="line">                c == <span class="number">0x2D</span> || <span class="comment">// -</span></span><br><span class="line">                c == <span class="number">0x2E</span> || <span class="comment">// .</span></span><br><span class="line">                c == <span class="number">0x5E</span> || <span class="comment">// ^</span></span><br><span class="line">                c == <span class="number">0x5F</span> || <span class="comment">// _</span></span><br><span class="line">                c == <span class="number">0x60</span> || <span class="comment">// `</span></span><br><span class="line">                c == <span class="number">0x7C</span> || <span class="comment">// |</span></span><br><span class="line">                c == <span class="number">0x7E</span> || <span class="comment">// ~</span></span><br><span class="line">                <span class="built_in">isDigitChar</span>(c) ||</span><br><span class="line">                <span class="built_in">isAlphaChar</span>(c);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 5234, Appendix B.1. Core Rules</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isVisibleChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c &gt;= <span class="number">0x21</span> &amp;&amp; c &lt;= <span class="number">0x7E</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, Appendix B. Collected ABNF</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> C&gt;</span><br><span class="line">        <span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isObsoleteTextChar</span><span class="params">(<span class="type">const</span> C c)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(c) &gt;= <span class="number">0x80</span> &amp;&amp;</span><br><span class="line">                <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(c) &lt;= <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">Iterator <span class="title">skipWhiteSpaces</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">for</span> (i = begin; i != end; ++i)</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">isWhiteSpaceChar</span>(*i))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 5234, Appendix B.1. Core Rules</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> C, <span class="keyword">typename</span> std::enable_if&lt;std::is_unsigned&lt;T&gt;::value&gt;::type* = <span class="literal">nullptr</span>&gt;</span><br><span class="line">        <span class="keyword">constexpr</span> T <span class="built_in">digitToUint</span>(<span class="type">const</span> C c)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// DIGIT</span></span><br><span class="line">            <span class="built_in">return</span> (c &gt;= <span class="number">0x30</span> &amp;&amp; c &lt;= <span class="number">0x39</span>) ? <span class="built_in">static_cast</span>&lt;T&gt;(c - <span class="number">0x30</span>) : <span class="comment">// 0 - 9</span></span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid digit&quot;</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 5234, Appendix B.1. Core Rules</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> C, <span class="keyword">typename</span> std::enable_if&lt;std::is_unsigned&lt;T&gt;::value&gt;::type* = <span class="literal">nullptr</span>&gt;</span><br><span class="line">        <span class="keyword">constexpr</span> T <span class="built_in">hexDigitToUint</span>(<span class="type">const</span> C c)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// HEXDIG</span></span><br><span class="line">            <span class="built_in">return</span> (c &gt;= <span class="number">0x30</span> &amp;&amp; c &lt;= <span class="number">0x39</span>) ? <span class="built_in">static_cast</span>&lt;T&gt;(c - <span class="number">0x30</span>) : <span class="comment">// 0 - 9</span></span><br><span class="line">                (c &gt;= <span class="number">0x41</span> &amp;&amp; c &lt;= <span class="number">0x46</span>) ? <span class="built_in">static_cast</span>&lt;T&gt;(c - <span class="number">0x41</span>) + <span class="built_in">T</span>(<span class="number">10</span>) : <span class="comment">// A - Z</span></span><br><span class="line">                (c &gt;= <span class="number">0x61</span> &amp;&amp; c &lt;= <span class="number">0x66</span>) ? <span class="built_in">static_cast</span>&lt;T&gt;(c - <span class="number">0x61</span>) + <span class="built_in">T</span>(<span class="number">10</span>) : <span class="comment">// a - z, some services send lower-case hex digits</span></span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid hex digit&quot;</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 3986, 3. Syntax Components</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">Uri <span class="title">parseUri</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Uri result;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.1. Scheme</span></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">if</span> (i == end || !<span class="built_in">isAlphaChar</span>(*begin))</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid scheme&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            result.scheme.<span class="built_in">push_back</span>(*i++);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (; i != end &amp;&amp; (<span class="built_in">isAlphaChar</span>(*i) || <span class="built_in">isDigitChar</span>(*i) || *i == <span class="string">&#x27;+&#x27;</span> || *i == <span class="string">&#x27;-&#x27;</span> || *i == <span class="string">&#x27;.&#x27;</span>); ++i)</span><br><span class="line">                result.scheme.<span class="built_in">push_back</span>(*i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid scheme&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid scheme&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid scheme&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.2. Authority</span></span><br><span class="line">            std::string authority = std::<span class="built_in">string</span>(i, end);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.5. Fragment</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> fragmentPosition = authority.<span class="built_in">find</span>(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (fragmentPosition != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                result.fragment = authority.<span class="built_in">substr</span>(fragmentPosition + <span class="number">1</span>);</span><br><span class="line">                authority.<span class="built_in">resize</span>(fragmentPosition); <span class="comment">// remove the fragment part</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.4. Query</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> queryPosition = authority.<span class="built_in">find</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (queryPosition != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                result.query = authority.<span class="built_in">substr</span>(queryPosition + <span class="number">1</span>);</span><br><span class="line">                authority.<span class="built_in">resize</span>(queryPosition); <span class="comment">// remove the query part</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.3. Path</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> pathPosition = authority.<span class="built_in">find</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pathPosition != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// RFC 3986, 3.3. Path</span></span><br><span class="line">                result.path = authority.<span class="built_in">substr</span>(pathPosition);</span><br><span class="line">                authority.<span class="built_in">resize</span>(pathPosition);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                result.path = <span class="string">&quot;/&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.2.1. User Information</span></span><br><span class="line">            std::string userinfo;</span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> hostPosition = authority.<span class="built_in">find</span>(<span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (hostPosition != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                userinfo = authority.<span class="built_in">substr</span>(<span class="number">0</span>, hostPosition);</span><br><span class="line"></span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> passwordPosition = userinfo.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (passwordPosition != std::string::npos)</span><br><span class="line">                &#123;</span><br><span class="line">                    result.user = userinfo.<span class="built_in">substr</span>(<span class="number">0</span>, passwordPosition);</span><br><span class="line">                    result.password = userinfo.<span class="built_in">substr</span>(passwordPosition + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    result.user = userinfo;</span><br><span class="line"></span><br><span class="line">                result.host = authority.<span class="built_in">substr</span>(hostPosition + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                result.host = authority;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 3986, 3.2.2. Host</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> portPosition = result.host.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (portPosition != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// RFC 3986, 3.2.3. Port</span></span><br><span class="line">                result.port = result.host.<span class="built_in">substr</span>(portPosition + <span class="number">1</span>);</span><br><span class="line">                result.host.<span class="built_in">resize</span>(portPosition);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 2.6. Protocol Versioning</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, HttpVersion&gt; <span class="title">parseHttpVersion</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;H&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;P&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> majorVersion = <span class="built_in">digitToUint</span>&lt;std::<span class="type">uint16_t</span>&gt;(*i++);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid HTTP version&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> minorVersion = <span class="built_in">digitToUint</span>&lt;std::<span class="type">uint16_t</span>&gt;(*i++);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, HttpVersion&#123;majorVersion, minorVersion&#125;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.1.2. Status Line</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, std::<span class="type">uint16_t</span>&gt; <span class="title">parseStatusCode</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::<span class="type">uint16_t</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">while</span> (i != end &amp;&amp; <span class="built_in">isDigitChar</span>(*i))</span><br><span class="line">                result = <span class="built_in">static_cast</span>&lt;std::<span class="type">uint16_t</span>&gt;(result * <span class="number">10U</span>) + <span class="built_in">digitToUint</span>&lt;std::<span class="type">uint16_t</span>&gt;(*i++);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (std::<span class="built_in">distance</span>(begin, i) != <span class="number">3</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid status code&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, result&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.1.2. Status Line</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, std::string&gt; <span class="title">parseReasonPhrase</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::string result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">for</span> (; i != end &amp;&amp; (<span class="built_in">isWhiteSpaceChar</span>(*i) || <span class="built_in">isVisibleChar</span>(*i) || <span class="built_in">isObsoleteTextChar</span>(*i)); ++i)</span><br><span class="line">                result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(*i));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, std::<span class="built_in">move</span>(result)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2.6. Field Value Components</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, std::string&gt; <span class="title">parseToken</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::string result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">for</span> (; i != end &amp;&amp; <span class="built_in">isTokenChar</span>(*i); ++i)</span><br><span class="line">                result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(*i));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.<span class="built_in">empty</span>())</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid token&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, std::<span class="built_in">move</span>(result)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2. Header Fields</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, std::string&gt; <span class="title">parseFieldValue</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::string result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line">            <span class="keyword">for</span> (; i != end &amp;&amp; (<span class="built_in">isWhiteSpaceChar</span>(*i) || <span class="built_in">isVisibleChar</span>(*i) || <span class="built_in">isObsoleteTextChar</span>(*i)); ++i)</span><br><span class="line">                result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">char</span>&gt;(*i));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// trim white spaces</span></span><br><span class="line">            result.<span class="built_in">erase</span>(std::<span class="built_in">find_if</span>(result.<span class="built_in">rbegin</span>(), result.<span class="built_in">rend</span>(), [](<span class="type">const</span> <span class="type">char</span> c) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> !<span class="built_in">isWhiteSpaceChar</span>(c);</span><br><span class="line">            &#125;).<span class="built_in">base</span>(), result.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, std::<span class="built_in">move</span>(result)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2. Header Fields</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, std::string&gt; <span class="title">parseFieldContent</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::string result;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> i = begin;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> fieldValueResult = <span class="built_in">parseFieldValue</span>(i, end);</span><br><span class="line">                i = fieldValueResult.first;</span><br><span class="line">                result += fieldValueResult.second;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Handle obsolete fold as per RFC 7230, 3.2.4. Field Parsing</span></span><br><span class="line">                <span class="comment">// Obsolete folding is known as linear white space (LWS) in RFC 2616, 2.2 Basic Rules</span></span><br><span class="line">                <span class="keyword">auto</span> obsoleteFoldIterator = i;</span><br><span class="line">                <span class="keyword">if</span> (obsoleteFoldIterator == end || *obsoleteFoldIterator++ != <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (obsoleteFoldIterator == end || *obsoleteFoldIterator++ != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (obsoleteFoldIterator == end || !<span class="built_in">isWhiteSpaceChar</span>(*obsoleteFoldIterator++))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                result.<span class="built_in">push_back</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                i = obsoleteFoldIterator;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, std::<span class="built_in">move</span>(result)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2. Header Fields</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, HeaderField&gt; <span class="title">parseHeaderField</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">auto</span> tokenResult = <span class="built_in">parseToken</span>(begin, end);</span><br><span class="line">            <span class="keyword">auto</span> i = tokenResult.first;</span><br><span class="line">            <span class="keyword">auto</span> fieldName = std::<span class="built_in">move</span>(tokenResult.second);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid header&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            i = <span class="built_in">skipWhiteSpaces</span>(i, end);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> valueResult = <span class="built_in">parseFieldContent</span>(i, end);</span><br><span class="line">            i = valueResult.first;</span><br><span class="line">            <span class="keyword">auto</span> fieldValue = std::<span class="built_in">move</span>(valueResult.second);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid header&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid header&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, &#123;std::<span class="built_in">move</span>(fieldName), std::<span class="built_in">move</span>(fieldValue)&#125;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.1.2. Status Line</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::pair&lt;Iterator, Status&gt; <span class="title">parseStatusLine</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> httpVersionResult = <span class="built_in">parseHttpVersion</span>(begin, end);</span><br><span class="line">            <span class="keyword">auto</span> i = httpVersionResult.first;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid status line&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> statusCodeResult = <span class="built_in">parseStatusCode</span>(i, end);</span><br><span class="line">            i = statusCodeResult.first;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid status line&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> reasonPhraseResult = <span class="built_in">parseReasonPhrase</span>(i, end);</span><br><span class="line">            i = reasonPhraseResult.first;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid status line&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == end || *i++ != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid status line&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;i, Status&#123;</span><br><span class="line">                httpVersionResult.second,</span><br><span class="line">                statusCodeResult.second,</span><br><span class="line">                std::<span class="built_in">move</span>(reasonPhraseResult.second)</span><br><span class="line">            &#125;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 4.1. Chunked Transfer Coding</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">class</span> <span class="title class_">Iterator</span>, <span class="keyword">typename</span> std::enable_if&lt;std::is_unsigned&lt;T&gt;::value&gt;::type* = <span class="literal">nullptr</span>&gt;</span><br><span class="line">        T <span class="built_in">stringToUint</span>(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span><br><span class="line">        &#123;</span><br><span class="line">            T result = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = begin; i != end; ++i)</span><br><span class="line">                result = <span class="built_in">T</span>(<span class="number">10U</span>) * result + <span class="built_in">digitToUint</span>&lt;T&gt;(*i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">class</span> <span class="title class_">Iterator</span>, <span class="keyword">typename</span> std::enable_if&lt;std::is_unsigned&lt;T&gt;::value&gt;::type* = <span class="literal">nullptr</span>&gt;</span><br><span class="line">        T <span class="built_in">hexStringToUint</span>(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span><br><span class="line">        &#123;</span><br><span class="line">            T result = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = begin; i != end; ++i)</span><br><span class="line">                result = <span class="built_in">T</span>(<span class="number">16U</span>) * result + <span class="built_in">hexDigitToUint</span>&lt;T&gt;(*i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.1.1. Request Line</span></span><br><span class="line">        <span class="function"><span class="keyword">inline</span> std::string <span class="title">encodeRequestLine</span><span class="params">(<span class="type">const</span> std::string&amp; method, <span class="type">const</span> std::string&amp; target)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> method + <span class="string">&quot; &quot;</span> + target + <span class="string">&quot; HTTP/1.1\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 7230, 3.2. Header Fields</span></span><br><span class="line">        <span class="function"><span class="keyword">inline</span> std::string <span class="title">encodeHeaderFields</span><span class="params">(<span class="type">const</span> HeaderFields&amp; headerFields)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            std::string result;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; headerField : headerFields)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (headerField.first.<span class="built_in">empty</span>())</span><br><span class="line">                    <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid header field name&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> c : headerField.first)</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">isTokenChar</span>(c))</span><br><span class="line">                        <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid header field name&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> c : headerField.second)</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">isWhiteSpaceChar</span>(c) &amp;&amp; !<span class="built_in">isVisibleChar</span>(c) &amp;&amp; !<span class="built_in">isObsoleteTextChar</span>(c))</span><br><span class="line">                        <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Invalid header field value&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                result += headerField.first + <span class="string">&quot;: &quot;</span> + headerField.second + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// RFC 4648, 4. Base 64 Encoding</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="function">std::string <span class="title">encodeBase64</span><span class="params">(<span class="type">const</span> Iterator begin, <span class="type">const</span> Iterator end)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">constexpr</span> std::array&lt;<span class="type">char</span>, 64&gt; chars&#123;</span><br><span class="line">                <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            std::string result;</span><br><span class="line">            std::<span class="type">size_t</span> c = <span class="number">0</span>;</span><br><span class="line">            std::array&lt;std::<span class="type">uint8_t</span>, 3&gt; charArray;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = begin; i != end; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                charArray[c++] = <span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;(*i);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;((charArray[<span class="number">0</span>] &amp; <span class="number">0xFC</span>) &gt;&gt; <span class="number">2</span>)];</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;(((charArray[<span class="number">0</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">4</span>) + ((charArray[<span class="number">1</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>))];</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;(((charArray[<span class="number">1</span>] &amp; <span class="number">0x0F</span>) &lt;&lt; <span class="number">2</span>) + ((charArray[<span class="number">2</span>] &amp; <span class="number">0xC0</span>) &gt;&gt; <span class="number">6</span>))];</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;(charArray[<span class="number">2</span>] &amp; <span class="number">0x3f</span>)];</span><br><span class="line">                    c = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c)</span><br><span class="line">            &#123;</span><br><span class="line">                result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;((charArray[<span class="number">0</span>] &amp; <span class="number">0xFC</span>) &gt;&gt; <span class="number">2</span>)];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">1</span>)</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;((charArray[<span class="number">0</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">4</span>)];</span><br><span class="line">                <span class="keyword">else</span> <span class="comment">// c == 2</span></span><br><span class="line">                &#123;</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;(((charArray[<span class="number">0</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">4</span>) + ((charArray[<span class="number">1</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>))];</span><br><span class="line">                    result += chars[<span class="built_in">static_cast</span>&lt;std::<span class="type">uint8_t</span>&gt;((charArray[<span class="number">1</span>] &amp; <span class="number">0x0F</span>) &lt;&lt; <span class="number">2</span>)];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (++c &lt; <span class="number">4</span>) result += <span class="string">&#x27;=&#x27;</span>; <span class="comment">// padding</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">inline</span> std::vector&lt;std::<span class="type">uint8_t</span>&gt; <span class="title">encodeHtml</span><span class="params">(<span class="type">const</span> Uri&amp; uri,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="type">const</span> std::string&amp; method,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; body,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    HeaderFields headerFields)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (uri.scheme != <span class="string">&quot;http&quot;</span>)</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Only HTTP scheme is supported&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 7230, 5.3. Request Target</span></span><br><span class="line">            <span class="type">const</span> std::string requestTarget = uri.path + (uri.query.<span class="built_in">empty</span>() ? <span class="string">&quot;&quot;</span>  : <span class="string">&#x27;?&#x27;</span> + uri.query);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 7230, 5.4. Host</span></span><br><span class="line">            headerFields.<span class="built_in">push_back</span>(&#123;<span class="string">&quot;Host&quot;</span>, uri.host&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 7230, 3.3.2. Content-Length</span></span><br><span class="line">            headerFields.<span class="built_in">push_back</span>(&#123;<span class="string">&quot;Content-Length&quot;</span>, std::<span class="built_in">to_string</span>(body.<span class="built_in">size</span>())&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// RFC 7617, 2. The &#x27;Basic&#x27; Authentication Scheme</span></span><br><span class="line">            <span class="keyword">if</span> (!uri.user.<span class="built_in">empty</span>() || !uri.password.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                std::string userinfo = uri.user + <span class="string">&#x27;:&#x27;</span> + uri.password;</span><br><span class="line">                headerFields.<span class="built_in">push_back</span>(&#123;<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Basic &quot;</span> + <span class="built_in">encodeBase64</span>(userinfo.<span class="built_in">begin</span>(), userinfo.<span class="built_in">end</span>())&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> headerData = <span class="built_in">encodeRequestLine</span>(method, requestTarget) +</span><br><span class="line">                <span class="built_in">encodeHeaderFields</span>(headerFields) +</span><br><span class="line">                <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">result</span><span class="params">(headerData.begin(), headerData.end())</span></span>;</span><br><span class="line">            result.<span class="built_in">insert</span>(result.<span class="built_in">end</span>(), body.<span class="built_in">begin</span>(), body.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Request</span> <span class="keyword">final</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Request</span><span class="params">(<span class="type">const</span> std::string&amp; uriString,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">const</span> InternetProtocol protocol = InternetProtocol::V4)</span>:</span></span><br><span class="line"><span class="function">            internetProtocol&#123;</span>protocol&#125;,</span><br><span class="line">            uri&#123;<span class="built_in">parseUri</span>(uriString.<span class="built_in">begin</span>(), uriString.<span class="built_in">end</span>())&#125;</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Response <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; method = <span class="string">&quot;GET&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::string&amp; body = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> HeaderFields&amp; headerFields = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::chrono::milliseconds timeout = std::chrono::milliseconds&#123;<span class="number">-1</span>&#125;)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">send</span>(method,</span><br><span class="line">                        std::<span class="built_in">vector</span>&lt;<span class="type">uint8_t</span>&gt;(body.<span class="built_in">begin</span>(), body.<span class="built_in">end</span>()),</span><br><span class="line">                        headerFields,</span><br><span class="line">                        timeout);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Response <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; method,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; body,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> HeaderFields&amp; headerFields = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::chrono::milliseconds timeout = std::chrono::milliseconds&#123;<span class="number">-1</span>&#125;)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> stopTime = std::chrono::steady_clock::<span class="built_in">now</span>() + timeout;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uri.scheme != <span class="string">&quot;http&quot;</span>)</span><br><span class="line">                <span class="keyword">throw</span> RequestError&#123;<span class="string">&quot;Only HTTP scheme is supported&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">            addrinfo hints = &#123;&#125;;</span><br><span class="line">            hints.ai_family = <span class="built_in">getAddressFamily</span>(internetProtocol);</span><br><span class="line">            hints.ai_socktype = SOCK_STREAM;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* port = uri.port.<span class="built_in">empty</span>() ? <span class="string">&quot;80&quot;</span> : uri.port.<span class="built_in">c_str</span>();</span><br><span class="line"></span><br><span class="line">            addrinfo* info;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">getaddrinfo</span>(uri.host.<span class="built_in">c_str</span>(), port, &amp;hints, &amp;info) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> std::system_error&#123;<span class="built_in">getLastError</span>(), std::<span class="built_in">system_category</span>(), <span class="string">&quot;Failed to get address info of &quot;</span> + uri.host&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> std::unique_ptr&lt;addrinfo, <span class="keyword">decltype</span>(&amp;freeaddrinfo)&gt; addressInfo&#123;info, freeaddrinfo&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> requestData = <span class="built_in">encodeHtml</span>(uri, method, body, headerFields);</span><br><span class="line"></span><br><span class="line">            Socket socket&#123;internetProtocol&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> getRemainingMilliseconds = [](<span class="type">const</span> std::chrono::steady_clock::time_point time) <span class="keyword">noexcept</span> -&gt; std::<span class="type">int64_t</span> &#123;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> now = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> remainingTime = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(time - now);</span><br><span class="line">                <span class="keyword">return</span> (remainingTime.<span class="built_in">count</span>() &gt; <span class="number">0</span>) ? remainingTime.<span class="built_in">count</span>() : <span class="number">0</span>;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// take the first address from the list</span></span><br><span class="line">            socket.<span class="built_in">connect</span>(addressInfo-&gt;ai_addr, <span class="built_in">static_cast</span>&lt;<span class="type">socklen_t</span>&gt;(addressInfo-&gt;ai_addrlen),</span><br><span class="line">                           (timeout.<span class="built_in">count</span>() &gt;= <span class="number">0</span>) ? <span class="built_in">getRemainingMilliseconds</span>(stopTime) : <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> remaining = requestData.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">auto</span> sendData = requestData.<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// send the request</span></span><br><span class="line">            <span class="keyword">while</span> (remaining &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> size = socket.<span class="built_in">send</span>(sendData, remaining,</span><br><span class="line">                                              (timeout.<span class="built_in">count</span>() &gt;= <span class="number">0</span>) ? <span class="built_in">getRemainingMilliseconds</span>(stopTime) : <span class="number">-1</span>);</span><br><span class="line">                remaining -= size;</span><br><span class="line">                sendData += size;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            std::array&lt;std::<span class="type">uint8_t</span>, 4096&gt; tempBuffer;</span><br><span class="line">            <span class="keyword">constexpr</span> std::array&lt;std::<span class="type">uint8_t</span>, 2&gt; crlf = &#123;<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>&#125;;</span><br><span class="line">            <span class="keyword">constexpr</span> std::array&lt;std::<span class="type">uint8_t</span>, 4&gt; headerEnd = &#123;<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>&#125;;</span><br><span class="line">            Response response;</span><br><span class="line">            std::vector&lt;std::<span class="type">uint8_t</span>&gt; responseData;</span><br><span class="line">            <span class="type">bool</span> parsingBody = <span class="literal">false</span>;</span><br><span class="line">            <span class="type">bool</span> contentLengthReceived = <span class="literal">false</span>;</span><br><span class="line">            std::<span class="type">size_t</span> contentLength = <span class="number">0U</span>;</span><br><span class="line">            <span class="type">bool</span> chunkedResponse = <span class="literal">false</span>;</span><br><span class="line">            std::<span class="type">size_t</span> expectedChunkSize = <span class="number">0U</span>;</span><br><span class="line">            <span class="type">bool</span> removeCrlfAfterChunk = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// read the response</span></span><br><span class="line">            <span class="keyword">for</span> (;;)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> <span class="keyword">auto</span> size = socket.<span class="built_in">recv</span>(tempBuffer.<span class="built_in">data</span>(), tempBuffer.<span class="built_in">size</span>(),</span><br><span class="line">                                              (timeout.<span class="built_in">count</span>() &gt;= <span class="number">0</span>) ? <span class="built_in">getRemainingMilliseconds</span>(stopTime) : <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">if</span> (size == <span class="number">0</span>) <span class="comment">// disconnected</span></span><br><span class="line">                    <span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">                responseData.<span class="built_in">insert</span>(responseData.<span class="built_in">end</span>(), tempBuffer.<span class="built_in">begin</span>(), tempBuffer.<span class="built_in">begin</span>() + size);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!parsingBody)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// RFC 7230, 3. Message Format</span></span><br><span class="line">                    <span class="comment">// Empty line indicates the end of the header section (RFC 7230, 2.1. Client/Server Messaging)</span></span><br><span class="line">                    <span class="type">const</span> <span class="keyword">auto</span> endIterator = std::<span class="built_in">search</span>(responseData.<span class="built_in">cbegin</span>(), responseData.<span class="built_in">cend</span>(),</span><br><span class="line">                                                         headerEnd.<span class="built_in">cbegin</span>(), headerEnd.<span class="built_in">cend</span>());</span><br><span class="line">                    <span class="keyword">if</span> (endIterator == responseData.<span class="built_in">cend</span>()) <span class="keyword">break</span>; <span class="comment">// two consecutive CRLFs not found</span></span><br><span class="line"></span><br><span class="line">                    <span class="type">const</span> <span class="keyword">auto</span> headerBeginIterator = responseData.<span class="built_in">cbegin</span>();</span><br><span class="line">                    <span class="type">const</span> <span class="keyword">auto</span> headerEndIterator = endIterator + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">auto</span> statusLineResult = <span class="built_in">parseStatusLine</span>(headerBeginIterator, headerEndIterator);</span><br><span class="line">                    <span class="keyword">auto</span> i = statusLineResult.first;</span><br><span class="line"></span><br><span class="line">                    response.status = std::<span class="built_in">move</span>(statusLineResult.second);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (;;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">auto</span> headerFieldResult = <span class="built_in">parseHeaderField</span>(i, headerEndIterator);</span><br><span class="line">                        i = headerFieldResult.first;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">auto</span> fieldName = std::<span class="built_in">move</span>(headerFieldResult.second.first);</span><br><span class="line">                        <span class="type">const</span> <span class="keyword">auto</span> toLower = [](<span class="type">const</span> <span class="type">char</span> c) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">                            <span class="built_in">return</span> (c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>) ? c - (<span class="string">&#x27;A&#x27;</span> - <span class="string">&#x27;a&#x27;</span>) : c;</span><br><span class="line">                        &#125;;</span><br><span class="line">                        std::<span class="built_in">transform</span>(fieldName.<span class="built_in">begin</span>(), fieldName.<span class="built_in">end</span>(), fieldName.<span class="built_in">begin</span>(), toLower);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">auto</span> fieldValue = std::<span class="built_in">move</span>(headerFieldResult.second.second);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fieldName == <span class="string">&quot;transfer-encoding&quot;</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// RFC 7230, 3.3.1. Transfer-Encoding</span></span><br><span class="line">                            <span class="keyword">if</span> (fieldValue == <span class="string">&quot;chunked&quot;</span>)</span><br><span class="line">                                chunkedResponse = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Unsupported transfer encoding: &quot;</span> + fieldValue&#125;;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (fieldName == <span class="string">&quot;content-length&quot;</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// RFC 7230, 3.3.2. Content-Length</span></span><br><span class="line">                            contentLength = <span class="built_in">stringToUint</span>&lt;std::<span class="type">size_t</span>&gt;(fieldValue.<span class="built_in">cbegin</span>(), fieldValue.<span class="built_in">cend</span>());</span><br><span class="line">                            contentLengthReceived = <span class="literal">true</span>;</span><br><span class="line">                            response.body.<span class="built_in">reserve</span>(contentLength);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        response.headerFields.<span class="built_in">push_back</span>(&#123;std::<span class="built_in">move</span>(fieldName), std::<span class="built_in">move</span>(fieldValue)&#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (i == headerEndIterator)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    responseData.<span class="built_in">erase</span>(responseData.<span class="built_in">cbegin</span>(), headerEndIterator + <span class="number">2</span>);</span><br><span class="line">                    parsingBody = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (parsingBody)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Content-Length must be ignored if Transfer-Encoding is received (RFC 7230, 3.2. Content-Length)</span></span><br><span class="line">                    <span class="keyword">if</span> (chunkedResponse)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// RFC 7230, 4.1. Chunked Transfer Coding</span></span><br><span class="line">                        <span class="keyword">for</span> (;;)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (expectedChunkSize &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="type">const</span> <span class="keyword">auto</span> toWrite = (std::min)(expectedChunkSize, responseData.<span class="built_in">size</span>());</span><br><span class="line">                                response.body.<span class="built_in">insert</span>(response.body.<span class="built_in">end</span>(), responseData.<span class="built_in">begin</span>(),</span><br><span class="line">                                                     responseData.<span class="built_in">begin</span>() + <span class="built_in">static_cast</span>&lt;std::<span class="type">ptrdiff_t</span>&gt;(toWrite));</span><br><span class="line">                                responseData.<span class="built_in">erase</span>(responseData.<span class="built_in">begin</span>(),</span><br><span class="line">                                                   responseData.<span class="built_in">begin</span>() + <span class="built_in">static_cast</span>&lt;std::<span class="type">ptrdiff_t</span>&gt;(toWrite));</span><br><span class="line">                                expectedChunkSize -= toWrite;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (expectedChunkSize == <span class="number">0</span>) removeCrlfAfterChunk = <span class="literal">true</span>;</span><br><span class="line">                                <span class="keyword">if</span> (responseData.<span class="built_in">empty</span>()) <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (removeCrlfAfterChunk)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (responseData.<span class="built_in">size</span>() &lt; <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> (!std::<span class="built_in">equal</span>(crlf.<span class="built_in">begin</span>(), crlf.<span class="built_in">end</span>(), responseData.<span class="built_in">begin</span>()))</span><br><span class="line">                                        <span class="keyword">throw</span> ResponseError&#123;<span class="string">&quot;Invalid chunk&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">                                    removeCrlfAfterChunk = <span class="literal">false</span>;</span><br><span class="line">                                    responseData.<span class="built_in">erase</span>(responseData.<span class="built_in">begin</span>(), responseData.<span class="built_in">begin</span>() + <span class="number">2</span>);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="type">const</span> <span class="keyword">auto</span> i = std::<span class="built_in">search</span>(responseData.<span class="built_in">begin</span>(), responseData.<span class="built_in">end</span>(),</span><br><span class="line">                                                           crlf.<span class="built_in">begin</span>(), crlf.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (i == responseData.<span class="built_in">end</span>()) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                                expectedChunkSize = detail::<span class="built_in">hexStringToUint</span>&lt;std::<span class="type">size_t</span>&gt;(responseData.<span class="built_in">begin</span>(), i);</span><br><span class="line">                                responseData.<span class="built_in">erase</span>(responseData.<span class="built_in">begin</span>(), i + <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (expectedChunkSize == <span class="number">0</span>)</span><br><span class="line">                                    <span class="keyword">return</span> response;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        response.body.<span class="built_in">insert</span>(response.body.<span class="built_in">end</span>(), responseData.<span class="built_in">begin</span>(), responseData.<span class="built_in">end</span>());</span><br><span class="line">                        responseData.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// got the whole content</span></span><br><span class="line">                        <span class="keyword">if</span> (contentLengthReceived &amp;&amp; response.body.<span class="built_in">size</span>() &gt;= contentLength)</span><br><span class="line">                            <span class="keyword">return</span> response;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_WIN32) || defined(__CYGWIN__)</span></span><br><span class="line">        WinSock winSock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// defined(_WIN32) || defined(__CYGWIN__)</span></span></span><br><span class="line">        InternetProtocol internetProtocol;</span><br><span class="line">        Uri uri;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// HTTPREQUEST_HPP</span></span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wsgxg/p/14744678.html">网络编程（Win&#x2F;Linux）：理解select函数并实现IO复用服务器端 - 戈小戈 - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/giantpoplar/article/details/47658929">Socket通信——C++服务器端和Java客户端_xcy6666的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014080185/article/details/78680901">C++和java通过Socket批量发送和接收文件（C++客户端发送，java服务端接收）_wengtengfan的博客-CSDN博客_socket 批量发送</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/iteyer/3236621">java 发送字节流图片，c++接收二进制流_51CTO博客_c++读取二进制文件</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014080185/article/details/78680901">C++和java通过Socket批量发送和接收文件（C++客户端发送，java服务端接收）_wengtengfan的博客-CSDN博客_socket 批量发送</a></p>
<p><a target="_blank" rel="noopener" href="https://m.2cto.com/kf/201609/548246.html">Java客户端上传图片（文件）到c++服务器 - c++语言程序开发技术文章_c++编程 - 红黑联盟</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/katiejyoung/file-transfer-system/blob/master/FTClient.java">https://github.com/katiejyoung/file-transfer-system/blob/master/FTClient.java</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/katiejyoung/file-transfer-system/blob/master/ftserver.c">file-transfer-system&#x2F;ftserver.c at master · katiejyoung&#x2F;file-transfer-system · GitHub</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/giantpoplar/article/details/47658929">Socket通信——C++服务器端和Java客户端_xcy6666的博客-CSDN博客</a></p>
<hr>
<p>java:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_49862595/article/details/127453708">Java实现socket通信详解(UDP&#x2F;TCP)c&#x2F;s模式_寒风凋零的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_57099067/article/details/124258729">使用Java完成Socket通信_牛言牛语的博客-CSDN博客_java socket通信</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/11/Sub_Language/CPlus/CPlus_JSON/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/11/Sub_Language/CPlus/CPlus_JSON/" class="post-title-link" itemprop="url">C++ JSON</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-11 12:00:09" itemprop="dateCreated datePublished" datetime="2022-07-11T12:00:09+00:00">2022-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:40" itemprop="dateModified" datetime="2025-08-06T08:16:40+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>目录</p>
<p>[TOC]</p>
<h2 id="安装（Windows）"><a href="#安装（Windows）" class="headerlink" title="安装（Windows）"></a>安装（Windows）</h2><p>1、下载 : <a target="_blank" rel="noopener" href="https://codeload.github.com/open-source-parsers/jsoncpp/zip/refs/tags/1.9.3">https://codeload.github.com/open-source-parsers/jsoncpp/zip/refs/tags/1.9.3</a></p>
<p>2、VSCode 打开项目，直接Cmake编译项目</p>
<p>3、得到libjsoncpp.a文件</p>
<p>4、新建项目就可以使用json了</p>
<h2 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h2><h3 id="VS-项目配置g"><a href="#VS-项目配置g" class="headerlink" title="VS 项目配置g++"></a>VS 项目配置g++</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;label&quot;</span>: <span class="string">&quot;build demo_json&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">    <span class="string">&quot;command&quot;</span>: <span class="string">&quot;g++&quot;</span>,</span><br><span class="line">    <span class="string">&quot;args&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;-g&quot;</span>, </span><br><span class="line">        <span class="string">&quot;$&#123;workspaceFolder&#125;/demo_json.cpp&quot;</span>,</span><br><span class="line">        <span class="comment">// &quot;-I&quot;, &quot;D:/Tools/cplus_relate/eigen-3.4.0/Eigen/&quot;,</span></span><br><span class="line">        <span class="string">&quot;-I&quot;</span>, <span class="string">&quot;$&#123;workspaceFolder&#125;/include/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-L&quot;</span>, <span class="string">&quot;$&#123;workspaceFolder&#125;/libs/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;jsoncpp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;main.exe&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">    <span class="string">&quot;group&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;build&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isDefault&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;dependsOn&quot;</span>:[</span><br><span class="line">        <span class="string">&quot;clear&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="CMake-配置"><a href="#CMake-配置" class="headerlink" title="CMake 配置"></a>CMake 配置</h3><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="type">int</span> <span class="title">ReadJson</span><span class="params">(<span class="type">const</span> std::string &amp; strValue)</span> </span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">     Json::Reader reader;</span><br><span class="line">     Json::Value value;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (reader.<span class="built_in">parse</span>(strValue, value))</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="comment">//解析json中的对象</span></span><br><span class="line">         string out = value[<span class="string">&quot;name&quot;</span>].<span class="built_in">asString</span>();</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;name : &quot;</span>   &lt;&lt; out &lt;&lt; endl;</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;number : &quot;</span> &lt;&lt; value[<span class="string">&quot;number&quot;</span>].<span class="built_in">asInt</span>() &lt;&lt; endl;</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;value : &quot;</span>  &lt;&lt; value[<span class="string">&quot;value&quot;</span>].<span class="built_in">asBool</span>() &lt;&lt; endl;</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;no such num : &quot;</span> &lt;&lt; value[<span class="string">&quot;haha&quot;</span>].<span class="built_in">asInt</span>() &lt;&lt; endl;</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;no such str : &quot;</span> &lt;&lt; value[<span class="string">&quot;hehe&quot;</span>].<span class="built_in">asString</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//解析数组对象</span></span><br><span class="line">         <span class="type">const</span> Json::Value arrayNum = value[<span class="string">&quot;arrnum&quot;</span>];</span><br><span class="line">         <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; arrayNum.<span class="built_in">size</span>(); i++)</span><br><span class="line">         &#123;</span><br><span class="line">             cout &lt;&lt; <span class="string">&quot;arrnum[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;] = &quot;</span> &lt;&lt; arrayNum[i];</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//解析对象数组对象</span></span><br><span class="line">         Json::Value arrayObj = value[<span class="string">&quot;array&quot;</span>];</span><br><span class="line">         cout &lt;&lt; <span class="string">&quot;array size = &quot;</span> &lt;&lt; arrayObj.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">         <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; arrayObj.<span class="built_in">size</span>(); i++)</span><br><span class="line">         &#123;</span><br><span class="line">             cout &lt;&lt; arrayObj[i];</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//从对象数组中找到想要的对象</span></span><br><span class="line">         <span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; arrayObj.<span class="built_in">size</span>(); i++)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">if</span> (arrayObj[i].<span class="built_in">isMember</span>(<span class="string">&quot;string&quot;</span>)) </span><br><span class="line">             &#123;</span><br><span class="line">                 out = arrayObj[i][<span class="string">&quot;string&quot;</span>].<span class="built_in">asString</span>();</span><br><span class="line">                 std::cout &lt;&lt; <span class="string">&quot;string : &quot;</span> &lt;&lt; out &lt;&lt; std::endl;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function">std::string <span class="title">writeJson</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">     Json::Value root;</span><br><span class="line">     Json::Value arrayObj;</span><br><span class="line">     Json::Value item;</span><br><span class="line">     Json::Value iNum;</span><br><span class="line"></span><br><span class="line">     item[<span class="string">&quot;string&quot;</span>]    = <span class="string">&quot;this is a string&quot;</span>;</span><br><span class="line">     item[<span class="string">&quot;number&quot;</span>]    = <span class="number">999</span>;</span><br><span class="line">     item[<span class="string">&quot;aaaaaa&quot;</span>]    = <span class="string">&quot;bbbbbb&quot;</span>;</span><br><span class="line">     arrayObj.<span class="built_in">append</span>(item);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//直接对jsoncpp对象以数字索引作为下标进行赋值，则自动作为数组</span></span><br><span class="line">     iNum[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">     iNum[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">     iNum[<span class="number">3</span>] = <span class="number">3</span>;</span><br><span class="line">     iNum[<span class="number">4</span>] = <span class="number">4</span>;</span><br><span class="line">     iNum[<span class="number">5</span>] = <span class="number">5</span>;</span><br><span class="line">     iNum[<span class="number">6</span>] = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//增加对象数组</span></span><br><span class="line">     root[<span class="string">&quot;array&quot;</span>]    = arrayObj;</span><br><span class="line">     <span class="comment">//增加字符串</span></span><br><span class="line">     root[<span class="string">&quot;name&quot;</span>]    = <span class="string">&quot;json&quot;</span>;</span><br><span class="line">     <span class="comment">//增加数字</span></span><br><span class="line">     root[<span class="string">&quot;number&quot;</span>]    = <span class="number">666</span>;</span><br><span class="line">     <span class="comment">//增加布尔变量</span></span><br><span class="line">     root[<span class="string">&quot;value&quot;</span>]    = <span class="literal">true</span>;</span><br><span class="line">     <span class="comment">//增加数字数组</span></span><br><span class="line">     root[<span class="string">&quot;arrnum&quot;</span>]    = iNum;</span><br><span class="line"></span><br><span class="line">     root.<span class="built_in">toStyledString</span>();</span><br><span class="line">     string out = root.<span class="built_in">toStyledString</span>();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> out;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// ref:: http://t.zoukankan.com/fengbohello-p-4066254.html</span></span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40203552/article/details/109523051">VScode 配置 svn_LDG1998的博客-CSDN博客_vscode配置svn</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/10/Sub_Language/CPlus/Language-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/10/Sub_Language/CPlus/Language-C/" class="post-title-link" itemprop="url">C/C++ Doc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-10 12:00:01" itemprop="dateCreated datePublished" datetime="2022-07-10T12:00:01+00:00">2022-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:40" itemprop="dateModified" datetime="2025-08-06T08:16:40+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/" itemprop="url" rel="index"><span itemprop="name">dev</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dev/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="memccpy"><a href="#memccpy" class="headerlink" title="memccpy"></a>memccpy</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">memccpy</span><span class="params">(<span class="type">void</span> * <span class="keyword">restrict</span> dest, <span class="type">const</span> <span class="type">void</span> * <span class="keyword">restrict</span> src, <span class="type">int</span> c, <span class="type">size_t</span> count)</span>;</span><br><span class="line"></span><br><span class="line">dest  -    pointer to the object to copy to</span><br><span class="line">src      -    pointer to the object to copy from</span><br><span class="line">c      -    terminating character, converted to <span class="type">unsigned</span> <span class="type">char</span> at first</span><br><span class="line">count -    number of characters to copy</span><br></pre></td></tr></table></figure>

<p>这里容易出现理解偏差的是参数 c，“terminating character, converted to unsigned char at first” 也就是参数会转化为unsigned char 也就是需要传入的是单个字符，当检测到传入的src 中字符与”c”匹配时，停止copy，退出.</p>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/string/byte/memccpy">https://en.cppreference.com/w/c/string/byte/memccpy</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/08/Course/SLAM/ch05_camera/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/08/Course/SLAM/ch05_camera/" class="post-title-link" itemprop="url">SLAM 第五讲 相机模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-08 12:00:00" itemprop="dateCreated datePublished" datetime="2022-07-08T12:00:00+00:00">2022-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:39" itemprop="dateModified" datetime="2025-08-06T08:16:39+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>1.理解针孔相机的模型、内参与径向畸变参数。</p>
<p>2.理解一个空间点如何投影到相机成像平面。</p>
<p>3.掌握 OpenCV 的图像存储与表达方式。</p>
<p>4.学会基本的摄像头标定方法。</p>
<p>在以相机为主的视觉SLAM中，观测主要是指相机成像的过程。</p>
<p>三维世界中的一个物体反射或发出的光线，穿过相机光心后，投影在相机的成像平面上。相机的感光器件接收到光线后，产生测量值，就得到了像素，形成了我们见到的照片。</p>
<h2 id="1、相机模型"><a href="#1、相机模型" class="headerlink" title="1、相机模型"></a>1、相机模型</h2><p>相机将三维世界中的坐标点（单位为米）映射到二维图像平面（单位为像素）的过程能够用一个几何模型进行描述，称为针孔模型，它描述了一束光线通过针孔之后，在针孔背面投影成像的关系。同时，由于相机镜头上的透镜的存在，使得光线投影到成像平面的过程中会产生畸变。因此，我们使用针孔和畸变两个模型来描述整个投影过程。这两个模型能够把外部的三维点投影到相机内部成像平面，构成相机的内参数（Intrinsics）。</p>
<h3 id="1-1-针孔相机模型"><a href="#1-1-针孔相机模型" class="headerlink" title="1.1 针孔相机模型"></a>1.1 针孔相机模型</h3><p>初中物理的蜡烛投影实验：在一个暗箱的前方放着一支点燃的蜡烛，蜡烛的光透过暗箱上的一个小孔投影在暗箱的后方平面上，并在这个平面上形成一个倒立的蜡烛图像。小孔模型能够把三维世界中的蜡烛投影到一个二维成像平面。同理，可以用这个简单的模型来解释相机的成像过程。对这个简单的针孔模型进行几何建模。设 O − x − y − z 为相机坐标系，z 轴指向相机前方，x 向右，y 向下。O为摄像机的光心，也是针孔模型中的针孔。现实世界的空间点P，经过小孔O投影之后，落在物理成像平面 O′ − x′ − y′ 上，成像点为 P′。设 P 的坐标为 [X,Y,Z]T，P′ 为 [X′,Y′,Z′]T，设物理成像平面到小孔的距离为f（焦距）。那么，根据三角形相似关系，有：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-01-56-image.png" title alt data-align="center">

<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-00-50-image.png"></p>
<p>其中负号表示成的像是倒立的。不过，实际相机得到的图像并不是倒像，可以等价地把成像平面对称地放到相机前方，和三维空间点一起放在摄像机坐标系的同一侧，如图所示。</p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-01-08-image.png"></p>
<p>把公式中的负号去掉，X′,Y′ 放到等式左侧，整理得：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-02-30-image.png" title alt data-align="center">

<p>这描述了点 P和它的像之间的空间关系。不过，在相机中最终获得的是一个个的像素，这还需要在成像平面上对像进行采样和量化。为了描述传感器将感受到的光线转换成图像像素的过程，设在物理成像平面上固定着一个像素平面 o − u − v，在像素平面有P′的像素坐标：[u,v]T。</p>
<p>像素坐标系通常的定义方式是：原点o′位于图像的左上角，u 轴向右与 x 轴平行，v 轴向下与 y 轴平行。像素坐标系与成像平面之间，相差了一个缩放和一个原点的平移。设像素坐标在 u 轴上缩放了 α 倍，在 v 上缩放了 β 倍。同时，原点平移了 [cx,cy]T。那么，P′ 的坐标与像素坐标[u,v]T 的关系为：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-02-57-image.png" title alt data-align="center">

<p>代入式</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-03-50-image.png" title alt data-align="center">

<p>把 αf 合并成 fx，把 βf 合并成 fy，得：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-03-45-image.png" title alt data-align="center">

<p>其中，f 的单位为米，α,β 的单位为像素&#x2F;米，所以 fx,fy 和 cx,cy 的单位为像素。写成矩阵形式：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-03-38-image.png" title alt data-align="center">

<p>K矩阵称为相机的内参数矩阵（Camera Intrinsics）。通常相机的内参在出厂之后是固定的，不会在使用过程中发生变化。但有时需要自己确定相机的内参，也就是所谓的标定。</p>
<p>（单目棋盘格张正友标定法[25]Z. Zhang, “Flexible camera calibration by viewing a plane from unknown orientations,” in Computer Vision, 1999. The Proceedings of the Seventh IEEE International Conference on, vol. 1, pp. 666–673, Ieee, 1999.）</p>
<p>前面内参公式中的P是在相机坐标系下的坐标。由于相机在运动，所以P是相机的世界坐标（记为Pw）根据相机的当前位姿变换到相机坐标系下的结果。相机的位姿由它的旋转矩阵R和平移向量t来描述。那么有：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-03-32-image.png" title alt data-align="center">

<p>后一个式子隐含了一次齐次坐标到非齐次坐标的转换。它描述了P的世界坐标到像素坐标的投影关系。相机的位姿R,t称为相机的外参数（Camera Extrinsics） 。 相比于不变的内参，外参会随着相机运动发生改变，同时也是 SLAM 中待估计的目标，代表着机器人的轨迹。 式子表明，可以把一个世界坐标点先转换到相机坐标系，再除掉它最后一维（Z）的数值（即该点距离相机成像平面的深度），这相当于把最后一维进行归一化处理，得到点 P 在相机归一化平面上的投影：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-03-26-image.png" title alt data-align="center">

<p>归一化坐标可看成相机前方z&#x3D;1处的平面上的一个点，这个 z &#x3D; 1 平面也称为归一化平面。归一化坐标再左乘内参就得到了像素坐标，所以可以把像素坐标 [u,v]T 看成对归一化平面上的点进行量化测量的结果。从这个模型中可以看出，对相机坐标同时乘以任意非零常数，归一化坐标都是一样的，这说明点的深度在投影过程中被丢失了，所以单目视觉中没法得到像素点的深度值。</p>
<p>**注：**1. 相机输出的图像并不是倒像，但相机自身会翻转这张图像，所以实际得到的是正像，也就是对称的成像平面上的像。尽管从物理原理来说，小孔成像应该是倒像。</p>
<p>2.在机器人或自动驾驶车辆中，外参也可以解释成相机坐标系到机器人本体坐标系之间的变换。</p>
<h3 id="1-2-畸变"><a href="#1-2-畸变" class="headerlink" title="1.2 畸变"></a>1.2 畸变</h3><p>为了获得好的成像效果，在相机的前方加了透镜。透镜的加入对成像过程中光线的传播会产生新的影响：一是透镜自身的形状对光线传播的影响，引起的畸变（Distortion，也叫失真）称为径向畸变。在针孔模型中，一条直线投影到像素平面上还是一条直线。可是，在实际拍摄的照片中，摄像机的透镜往往使得真实环境中的一条直线在图片中变成了曲线 。越靠近图像的边缘，这种现象越明显。由于实际加工制作的透镜往往是中心对称的，这使得不规则的畸变通常径向对称。它们主要分为两大类：桶形畸变和枕形畸变。</p>
<p>桶形畸变是由于图像放大率随着与光轴之间的距离增加而减小，而枕形畸变则恰好相反。在这两种畸变中，穿过图像中心和光轴有交点的直线还能保持形状不变。</p>
<p>二是在机械组装过程中，透镜和成像平面不可能完全平行，这也会使得光线穿过透镜投影到成像面时的位置发生变化，这引入切向畸变。</p>
<p>用数学形式对两者进行描述。省略具体过程，</p>
<p>对于相机坐标系中的一点P，能够通过 5 个畸变系数找到这个点在像素平面上的正确位置：</p>
<ol>
<li>将三维空间点投影到归一化图像平面。设它的归一化坐标为 [x,y]T。</li>
<li>对归一化平面上的点计算径向畸变和切向畸变。</li>
<li>将畸变后的点通过内参数矩阵投影到像素平面，得到该点在图像上的正确位置。</li>
</ol>
<p>在实际应用中，可以灵活选择纠正模型，比如只选择 k1,p1,p2 这 3 项等。</p>
<p>实际的图像系统中，学者们提出了很多其他的模型，比如相机的仿射模型和透视模型等，同时也存在很多其他类型的畸变。视觉 SLAM 中一般都使用普通的摄像头，针孔模型及径向畸变和切向畸变模型已经足够。 当一个图像去畸变之后，我们就可以直接用针孔模型建立投影关系，不用考虑畸变了。</p>
<p>小结单目相机的成像过程：</p>
<ol>
<li>首先，世界坐标系下有一个固定的点 P，世界坐标为Pw。</li>
<li>由于相机在运动，它的运动由 R,t 或变换矩阵T∈SE(3) 描述。P 的相机坐标为 P˜c &#x3D;RPw + t。</li>
<li>这时的 P˜c 的分量为 X,Y,Z，把它们投影到归一化平面 Z &#x3D; 1 上，得到 P 的归一化坐标：Pc &#x3D; [X&#x2F;Z,Y &#x2F;Z,1]T 。</li>
<li>有畸变时，根据畸变参数计算Pc 发生畸变后的坐标。</li>
<li>最后，P 的归一化坐标经过内参后，对应到它的像素坐标：Puv &#x3D; KPc。 一共有四种坐标：世界坐标、相机坐标、归一化坐标和像素坐标。</li>
</ol>
<h3 id="1-3-双目相机模型"><a href="#1-3-双目相机模型" class="headerlink" title="1.3 双目相机模型"></a>1.3 双目相机模型</h3><p>对于单目相机而言，仅根据一个像素，我们无法确定这个空间点的具体位置。这是因为，从相机光心到归一化平面连线上的所有点，都可以投影至该像素上（相当于没有了Z轴维度）。只有当P的深度确定时（比如通过双目或 RGB-D 相机），我们才能确切地知道它的空间位置。如图所示。</p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-05-19-image.png"></p>
<p>测量像素距离（或深度）的方式有很多种，比如人眼可以根据左右眼看到的景物差异（视差）来判断物体离我们的距离。双目相机的原理一样：通过同步采集左右相机的图像，计算图像间视差，来估计每一个像素的深度。</p>
<p>双目相机一般由左眼相机和右眼相机两个水平放置的相机组成。在左右双目相机中，我们可以把两个相机都看作针孔相机。它们是水平放置的，意味着两个相机的光圈中心都位于 <em>x</em> 轴上。两者之间的距离称为双目相机的基线（Baseline，记作 <em>b</em>），是双目相机的重要参数。</p>
<p>考虑一个空间点 <em>P</em>，它在左眼相机和右眼相机各成一像，记作 <em>PL,PR</em>。由于相机基线的存在，这两个成像位置是不同的。理想情况下，由于左右相机只在 <em>x</em> 轴上有位移，因此 <em>P</em> 的像也只在 <em>x</em> 轴（对应图像的u轴）上有差异。记它的左侧坐标为 <em>uL</em>，右侧坐标为 <em>uR</em>，几何关系如图所示。</p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-05-08-image.png"></p>
<p>根据 △<em>PPLPR</em> 和 △<em>POLOR</em> 的相似关系，整理得：</p>
<img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-12-05-40-image.png" title alt data-align="center">

<p>双目相机的成像模型：<em>OL,OR</em> 为左右光圈中心，方框为成像平面，<em>f</em> 为焦距。<em>uL</em> 和 <em>uR</em> 为成像平面的坐标。注意，按照图中坐标定义，<em>uR</em> 应该是负数，所以图中标出的距离为 −<em>uR</em>。</p>
<p>其中 <em>d</em> 定义为左右图的横坐标之差，称为视差（Disparity）。根据视差，我们可以估计一个像素与相机之间的距离。视差与距离成反比：视差越大，距离越近。同时，由于视差最小为一个像素，于是双目的深度存在一个理论上的最大值，由 <em>fb</em> 确定。可以看到，当基线越长时，双目能测到的最大距离就会越远。类似人眼在看非常远的物体时（如很远的飞机），通常不能准确判断它的距离。</p>
<p>视差 <em>d</em> 的计算比较困难，需要确切地知道左眼图像某个像素出现在右眼图像的哪一个位置（即对应关系）。当想计算每个像素的深度时，其计算量与精度都将成为问题，而且只有在图像纹理变化丰富的地方才能计算视差。由于计算量的原因，双目深度估计仍需要使用 GPU 或FPGA 来实时计算。</p>
<h3 id="1-4-RGB-D相机模型"><a href="#1-4-RGB-D相机模型" class="headerlink" title="1.4 RGB-D相机模型"></a>1.4 RGB-D相机模型</h3><p>RGB-D 相机是主动测量每个像素的深度。目前的 RGB-D 相机按原理可分为两大类：</p>
<ol>
<li>红外结构光（Structured Light）： Kinect 1 代、Project Tango 1 代、Intel RealSense 等。</li>
<li>通过飞行时间法（Time-of-flight，ToF）：Kinect 2 代和一些现有的 ToF 传感器等。</li>
</ol>
<p>无论是哪种类型，RGB-D 相机都需要向探测目标发射一束光线（通常是红外光）。在结构光原理中，相机根据返回的结构光图案，计算物体与自身之间的距离。而在 ToF 原理中，相机向目标发射脉冲光，然后根据发送到返回之间的光束飞行时间，确定物体与自身之间的距离。ToF原理的相机和激光雷达十分相似，只不过激光雷达是通过逐点扫描来获取这个物体的距离，而ToF相机则可以获得整个图像的像素深度。</p>
<p>在测量深度之后，RGB-D 相机通常按照生产时的相机摆放位置，自己完成深度与彩色图像素之间的配对，输出一一对应的彩色图和深度图。可以在同一个图像位置，读取到色彩信息和距离信息，计算像素的 3D 相机坐标，生成点云（Point Cloud）。对 RGB-D 数据，既可以在图像层面进行处理，也可在点云层面处理。</p>
<p>RGB-D 相机能够实时地测量每个像素点的距离。但用红外光进行深度值测量的 RGB-D 相机，容易受到日光或其他传感器发射的红外光干扰，因此不能在室外使用。在没有调制的情况下，同时使用多个 RGB-D 相机时也会相互干扰。对于透射材质的物体，因为接收不到反射光，所以无法测量这些点的位置。</p>
<h2 id="2、图像"><a href="#2、图像" class="headerlink" title="2、图像"></a>2、图像</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 现实世界</span><br><span class="line">e=&gt;end: 照片</span><br><span class="line">op1=&gt;operation: 相机-拍照|past</span><br><span class="line"></span><br><span class="line">st(right)-&gt;op1(right)-&gt;e</span><br></pre></td></tr></table></figure>

<p>相机把三维世界中的信息转换成了一张由像素组成的照片，存储在计算机中，作为后续处理的数据来源。在数学中，图像可以用一个矩阵来描述；而在计算机中，它们占据一段连续的磁盘或内存空间，可以用二维数组来表示。</p>
<p>最简单的图像——灰度图：每个像素位置 (<em>x,y</em>) 对应一个灰度值 <em>I</em>，一张宽度为 <em>w</em>、高度为 <em>h</em> 的图像，数学上可以记为一个函数：</p>
<p>$$<br>I(x,y) : R^2 \to R<br>$$</p>
<p>其中 (<em>x,y</em>) 是像素的坐标。然而，计算机并不能表达实数空间，所以需要对下标和图像读数在某个范围内进行量化（类似于模拟到数字的概念）。在常见的灰度图中，用 0~255 的整数（一个 unsigned char或1 个字节）来表达图像的灰度读数。那么，一张宽度为 640 像素、高度为 480 像素分辨率的灰度图就可以表示为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> image[<span class="number">480</span>][<span class="number">640</span>] <span class="comment">//二维数组表达图像</span></span><br></pre></td></tr></table></figure>

<p>在程序中，图像以二维数组形式存储。它的第一个下标是指数组的行，而第二个下标则是列。在图像中，数组的行数对应图像的高度，而列数对应图像的宽度。</p>
<p>当访问某一个像素时，需要指明它所处的坐标。像素坐标系原点位于图像的左上角，<em>X</em> 轴向右，<em>Y</em> 轴向下（也就是u,v* 坐标）。如果还有第三个轴—<em>Z</em> 轴，根据右手法则，<em>Z</em> 轴向前。这种定义方式是与相机坐标系一致的。图像的宽度或列数，对应着 <em>X</em> 轴；而图像的行数或高度，则对应着它的 <em>Y</em> 轴。</p>
<p>根据这种定义方式，访问一个位于 <em>x,y</em> 处的像素，那么在程序中应该是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> pixel = image[y][x];  <span class="comment">//访问图像像素</span></span><br></pre></td></tr></table></figure>

<p>它对应着灰度值 <em>I</em>(<em>x,y</em>) 的读数。</p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-15-21-46-image.png"></p>
<p>在 RGB-D 相机的深度图中，记录了各个像素与相机之间的距离。这个距离通常是以毫米为单位，而 RGB-D 相机的量程通常在十几米左右，超过了 255。这时会采用 16 位整数（unsigned short）来记录深度图的信息，也就是位于 0~65535 的值。换算成米的话，最大可以表示 65 米，足够 RGB-D 相机使用。</p>
<p>彩色图像的表示则需要通道（channel）的概念。在计算机中，用红色、绿色和蓝色这三种颜色的组合来表达任意一种色彩。于是对于每一个像素，就要记录其 R、G、B 三个数值，每一个数值就称为一个通道。最常见的彩色图像有三个通道，每个通道都由 8 位整数表示。在这种规定下，一个像素占据 24 位空间。通道的数量、顺序都是可以自由定义的。在 OpenCV 的彩色图像中，通道的默认顺序是 B、G、R。也就是说，当得到一个 24 位的像素时，前 8 位表示蓝色数值，中间 8 位为绿色，最后 8 位为红色。如果还想表达图像的透明度，就使用 R、G、B、A 四个通道。</p>
<h2 id="3-实践：计算机中的图像-OpenCV"><a href="#3-实践：计算机中的图像-OpenCV" class="headerlink" title="3 实践：计算机中的图像(OpenCV)"></a>3 实践：计算机中的图像(OpenCV)</h2><h3 id="3-1-OpenCV-的基础使用方法"><a href="#3-1-OpenCV-的基础使用方法" class="headerlink" title="3.1 OpenCV 的基础使用方法"></a>3.1 OpenCV 的基础使用方法</h3><p>OpenCV提供了大量的开源图像算法，是计算机视觉中使用极广的图像处理算法库。</p>
<p>在Ubuntu下，有两种安装方式：</p>
<ol>
<li>从源代码安装，指从OpenCV网站下载所有的OpenCV源代码，并在机器上编译安装，以便使用。好处是可以选择的版本比较丰富，而且能看到源代码，不过需要编译。还可以调整一些编译选项，匹配编程环境（例如，需不需要GPU加速等），还可以使用一些额外的功能。 源代码安装OpenCV 目前维护了两个主要版本，分为 OpenCV2.4系列和 OpenCV3系列。</li>
<li>只安装库文件，指通过Ubuntu来安装由Ubuntu社区人员已经编译好的库文件，这样无须编译。</li>
</ol>
<p>源代码安装，安装依赖项：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt−get install build−essential libgtk2.0−dev libvtk5−dev libjpeg−dev libtiff4−dev libjasper−dev libopenexr−dev libtbb−dev</span><br></pre></td></tr></table></figure>

<p>OpenCV 的依赖项很多，缺少某些编译项会影响它的部分功能，但可能不会用上。OpenCV 会在 cmake 阶段检查依赖项是否会安装，并调整自己的功能。如果电脑上有GPU并且安装了相关依赖项，OpenCV也会把GPU加速打开。</p>
<p>安装：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmake ..</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>安装后，OpenCV 默认存储在&#x2F;usr&#x2F;local 目录下</p>
<h3 id="操作-OpenCV-图像"><a href="#操作-OpenCV-图像" class="headerlink" title="操作 OpenCV 图像"></a><strong>操作 OpenCV 图像</strong></h3><blockquote>
<p>slambook&#x2F;ch5&#x2F;imageBasics&#x2F;imageBasics.cpp</p>
</blockquote>
<p>在该例程中操作有：图像读取、显示、像素遍历、复制、赋值等。编译该程序时，需要在CMakeLists.txt中添加 OpenCV的头文件，然后把程序链接到库文件上，还使用了C++11标准（如 nullptr 和 chrono）。</p>
<p>编译运行：</p>
<p>报错：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMakeFiles/joinMap.dir/joinMap.cpp.o：在函数‘fmt::v7::detail::compile_parse_context&lt;char, fmt::v7::detail::error_handler&gt;::char_type const* fmt::v7::detail::parse_format_specs&lt;Eigen::Transpose&lt;Eigen::Matrix&lt;double, 4, 1, 0, 4, 1&gt; &gt;, fmt::v7::detail::compile_parse_context&lt;char, fmt::v7::detail::error_handler&gt; &gt;(fmt::v7::detail::compile_parse_context&lt;char, fmt::v7::detail::error_handler&gt;&amp;)’中：</span><br><span class="line">joinMap.cpp:(.text._ZN3fmt2v76detail18parse_format_specsIN5Eigen9TransposeINS3_6MatrixIdLi4ELi1ELi0ELi4ELi1EEEEENS1_21compile_parse_contextIcNS1_13error_handlerEEEEEPKNT0_9char_typeERSB_[_ZN3fmt2v76detail18parse_format_specsIN5Eigen9TransposeINS3_6MatrixIdLi4ELi1ELi0ELi4ELi1EEEEENS1_21compile_parse_contextIcNS1_13error_handlerEEEEEPKNT0_9char_typeERSB_]+0x247)：对‘fmt::v7::detail::error_handler::on_error(char const*)’未定义的引用</span><br></pre></td></tr></table></figure>

<p>需要将之前安装的fmt库链接joinMap.cpp，rgbd文件夹中的cmakelists如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Sophus REQUIRED)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;Sophus_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(Pangolin REQUIRED)</span><br><span class="line"><span class="keyword">find_package</span>(FMT REQUIRED)</span><br><span class="line"><span class="keyword">add_executable</span>(joinMap joinMap.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(joinMap fmt::fmt <span class="variable">$&#123;OpenCV_LIBS&#125;</span> <span class="variable">$&#123;Pangolin_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>

<p>在图像中，鼠标点击图像中的每个点都能在左下角得到UV坐标值和RGB三通道值。</p>
<p>函数解析如下：</p>
<ol>
<li>cv::imread：函数读取图像，并把图像和基本信息显示出来。</li>
<li>OpenCV 提供了迭代器，可以通过迭代器遍历图像的像素。cv::Mat::data 提供了指向图像数据开头的指针，可以直接通过该指针自行计算偏移量，然后得到像素的实际内存位置。</li>
<li>复制图像中直接赋值是浅拷贝，并不会拷贝数据，而clone方法是深拷贝，会拷贝数据，这在图像存取中会经常用到。</li>
<li>在编程过程中碰到图像的旋转、插值等操作，自行查阅函数对应的文档，以了解它们的原理与使用方式。</li>
</ol>
<p>注：1. cv::Mat 亦是矩阵类，除了表示图像之外，我们也可以用它来存储位姿等矩阵数据，但一般还是使用eigen，更快一些。</p>
<ol>
<li>cmake默认编译的是debug模式，如果使用release模式会快很多。</li>
</ol>
<h3 id="3-2-图像去畸变"><a href="#3-2-图像去畸变" class="headerlink" title="3.2 图像去畸变"></a>3.2 图像去畸变</h3><p>OpenCV 提供了去畸变函数 cv::Undistort()，这个例程从公式出发计算了畸变前后的图像坐标（代码中有内参数据）。</p>
<blockquote>
<p>slambook&#x2F;ch5&#x2F;imageBasics&#x2F;undistortImage.cpp</p>
</blockquote>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-16-34-20-image.png"></p>
<p>可以看到去畸变前后图像差别还是蛮大的。</p>
<h2 id="4-实践：3D-视觉"><a href="#4-实践：3D-视觉" class="headerlink" title="4 实践：3D 视觉"></a>4 实践：3D 视觉</h2><h3 id="4-1-双目视觉-slam2"><a href="#4-1-双目视觉-slam2" class="headerlink" title="4.1 双目视觉(slam2)"></a>4.1 双目视觉(slam2)</h3><p>在stereo文件夹中，有左右目的图像和对应代码。其中代码计算图像对应的视差图，然后再计算各像素在相机坐标系下的坐标，它们共同构成点云。</p>
<blockquote>
<p>slambook&#x2F;ch5&#x2F;stereoVision&#x2F;stereoVision.cpp</p>
</blockquote>
<p>运行如下：（下面的第二个图片是视差图）</p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-19-58-47-image.png"></p>
<p><img src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-19-59-04-image.png"></p>
<p>例程中调用了OpenCV实现的SGBM算法（Semi-global Batch Matching）[26] H. Hirschmuller, “Stereo processing by semiglobal matching and mutual information,” IEEE Transactions on pattern analysis and machine intelligence, vol. 30, no. 2, pp. 328–341, 2008.</p>
<p>计算左右图像的视差，然后通过双目相机的几何模型把它变换到相机的3D空间中。SGBM 使用了来自网络的经典参数配置，主要调整了最大和最小视差。视差数据结合相机的内参、基线，即能确定各点在三维空间中的位置。感兴趣可以阅读相关的参考文献[27, 28]。</p>
<p>[27] D. Scharstein and R. Szeliski, “A taxonomy and evaluation of dense two-frame stereo correspondence algorithms,” International journal of computer vision, vol. 47, no. 1-3, pp. 7–42, 2002.</p>
<p>[28] S. M. Seitz, B. Curless, J. Diebel, D. Scharstein, and R. Szeliski, “A comparison and evaluation of multi-view stereo reconstruction algorithms,” in null, pp. 519–528, IEEE, 2006.</p>
<h3 id="4-2-RGB-D-视觉"><a href="#4-2-RGB-D-视觉" class="headerlink" title="4.2 RGB-D 视觉"></a>4.2 RGB-D 视觉</h3><p>RGB-D相机能通过物理方法获得像素深度信息。如果已知相机的内外参，可以计算任何一个像素在世界坐标系下的位置，从而建立一张点云地图。</p>
<p>位于 slambook&#x2F;ch5&#x2F;rgbd 文件夹中有5对图像。在 color&#x2F;下有 1.png 到 5.png 共 5 张 RGB 图，而在 depth&#x2F;下有 5 张对应的深度图。同时，pose.txt 文件给出了5张图像的相机外参位姿。位姿记录的形式为平移向量加旋转四元数： [x, y, z, qx, qy, qz, qw], 其中 qw 是四元数的实部。</p>
<p>这一段程序，完成了两件事：(1). 根据内参计算一对 RGB-D图像对应的点云；(2). 根据各张图的相机位姿（也就是外参），把点云加起来，组成地图。</p>
<p>slambook&#x2F;ch5&#x2F;rgbd&#x2F;jointMap.cpp</p>
<p>运行程序如下：</p>
<img title src="/2022/07/08/Course/SLAM/ch05_camera/2022-07-28-15-26-02-image.png" alt data-align="center">

<h3 id="习题"><a href="#习题" class="headerlink" title="习题"></a><strong>习题</strong></h3><ol>
<li><p>寻找一部相机，标定它的内参。可能会用到标定板， 或者棋盘格。</p>
<p>参考答案<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/388821535?utm_id=0"># 视觉SLAM十四讲（第二版）第5讲习题解答</a></p>
</li>
<li><p>相机内参的物理意义。如果一部相机的分辨率变为原来的两倍而其他地方不变，它的内参如何变化？</p>
</li>
<li><p>搜索特殊相机（鱼眼或全景相机）的标定方法。它们与普通的针孔模型有何不同？</p>
</li>
<li><p>调研全局快门相机（global shutter）和卷帘快门相机（rolling shutter）的异同。它们在SLAM中有何优缺点？</p>
</li>
<li><p>RGB-D 相机是如何标定的？以 Kinect 为例，需要标定哪些参数？（参照<a href="https://link.zhihu.com/?target=https://github.com/code-iai/iai_kinect2">https://github.com/code-iai/iai_kinect2</a>）</p>
</li>
<li><p>除了示例程序演示的遍历图像的方式，还能举出哪些遍历图像的方法？</p>
</li>
<li><p>阅读 OpenCV 官方教程，学习它的基本用法。</p>
</li>
</ol>
<p>习题有代码学习和工程应用的知识，后面实际开发中会很有帮助。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/06/Course/SLAM/ch04_Sophus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/Course/SLAM/ch04_Sophus/" class="post-title-link" itemprop="url">Sophus 基本用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-06 23:00:00" itemprop="dateCreated datePublished" datetime="2022-07-06T23:00:00+00:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:39" itemprop="dateModified" datetime="2025-08-06T08:16:39+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/Sophus/" itemprop="url" rel="index"><span itemprop="name">Sophus</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h2 id="1、李群李代数基础"><a href="#1、李群李代数基础" class="headerlink" title="1、李群李代数基础"></a>1、李群李代数基础</h2><h2 id="2、指数与对数映射"><a href="#2、指数与对数映射" class="headerlink" title="2、指数与对数映射"></a>2、指数与对数映射</h2><h2 id="3、李代数与对数映射"><a href="#3、李代数与对数映射" class="headerlink" title="3、李代数与对数映射"></a>3、李代数与对数映射</h2><h2 id="4、Sophus的基本使用方法"><a href="#4、Sophus的基本使用方法" class="headerlink" title="4、Sophus的基本使用方法"></a>4、Sophus的基本使用方法</h2><h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><p>Sophus 库是Strasdat 维护的 。Sophus 库支持SO(3) 和 SE(3)，此外还含有二维运动 SO(2),SE(2) 以及相似变换 Sim(3) 的内容。它是直接在 Eigen 基础上开发的，不需要安装额外的依赖库。可以直接从 GitHub 上获取 Sophus，在代码目录 slambook&#x2F;3rdparty 下也提供了 Sophus 源代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Eigen::Matrix3d和Sophus::Matrix3d</span><br><span class="line">Eigen::Vector3d和Sophus::Vector3d</span><br></pre></td></tr></table></figure>

<p>此外，为了方便说明SE(4)和se(4)，Sophus库还typedef了Vector4d、Matrix4d、Vector6d和Matrix6d等，即：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Sophus::Vector4d</span><br><span class="line">Sophus::Matrix4d</span><br><span class="line">Sophus::Vector6d</span><br><span class="line">Sophus::Matrix6d</span><br></pre></td></tr></table></figure>

<h3 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/strasdat/Sophus.git</span><br><span class="line"><span class="built_in">cd</span> Sophus</span><br><span class="line">git checkout a621ff</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>李代数so(3)：Sophus::Vector3d &#x2F;&#x2F;因为so(3)仅仅只是一个普通的3维向量</p>
<p>李代数se(3)：Sophus::Vector6d &#x2F;&#x2F;因为se(3)仅仅只是一个普通的6维向量</p>
<h3 id="SO3构造函数"><a href="#SO3构造函数" class="headerlink" title="SO3构造函数"></a>SO3构造函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SO3</span> ();</span><br><span class="line"><span class="built_in">SO3</span> (<span class="type">const</span> SO3 &amp; other);</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">SO3</span> <span class="params">(<span class="type">const</span> Matrix3d &amp; _R)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">SO3</span> <span class="params">(<span class="type">const</span> Quaterniond &amp; unit_quaternion)</span></span>;</span><br><span class="line"><span class="built_in">SO3</span> (<span class="type">double</span> rot_x, <span class="type">double</span> rot_y, <span class="type">double</span> rot_z);</span><br></pre></td></tr></table></figure>

<h3 id="SE3的构造函数"><a href="#SE3的构造函数" class="headerlink" title="SE3的构造函数"></a>SE3的构造函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SE3</span> ();</span><br><span class="line"><span class="built_in">SE3</span> (<span class="type">const</span> SO3 &amp; so3,<span class="type">const</span> Vector3d &amp; translation);</span><br><span class="line"><span class="built_in">SE3</span> (<span class="type">const</span> Matrix3d &amp; rotation_matrix,<span class="type">const</span> Vector3d &amp; translation);</span><br><span class="line"><span class="built_in">SE3</span> (<span class="type">const</span> Quaterniond &amp; unit_quaternion,<span class="type">const</span> Vector3d &amp; translation_);</span><br><span class="line"><span class="built_in">SE3</span> (<span class="type">const</span> SE3 &amp; other);</span><br></pre></td></tr></table></figure>

<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><p>尽管SO3对应于矩阵群，但是SO3在使用cout时是以so3形式输出的，输出的是一个3维向量</p>
<p>  SE3在使用cout输出时输出的是一个6维向量，<strong>其中前3维为对应的so3的值，后3维为实际的平移向量t</strong></p>
<p>  se3在使用cout输出时输出的也是一个6维向量，但是其前3维为平移值ρ</p>
<p>（注意此时的ρ与SE3输出的t是不同的，t&#x3D;Jρ,其中J是雅克比矩阵），后3维为其对应的so3.</p>
<h2 id="SO3-so3-SE3-se3初始化和相互转化关系"><a href="#SO3-so3-SE3-se3初始化和相互转化关系" class="headerlink" title="SO3,so3,SE3,se3初始化和相互转化关系"></a>SO3,so3,SE3,se3初始化和相互转化关系</h2><h3 id="1、转换关系图"><a href="#1、转换关系图" class="headerlink" title="1、转换关系图"></a>1、转换关系图</h3><img title src="/2022/07/06/Course/SLAM/ch04_Sophus/image-20220708021937910.png" alt="image-20220708021937910" data-align="inline">

<p>关于旋转矩阵，旋转向量和四元数的初始化和相互转换关系可以参考另一篇博文：<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011092188/article/details/77430988">http://blog.csdn.net/u011092188/article/details/77430988</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.freesion.com/article/2140799438/">【SOPHUS库 学习笔记 1】 SOPHUS的安装与使用</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU0NjgzMDIxMQ==&mid=2247487439&idx=1&sn=da8c277d40911b114038a415f5873ac9&chksm=fb56ed23cc216435c3bac0429620492e6b4380a63f30f026c8377f37bd81577a320188e1a404&scene=27"># 一文详解四元数、欧拉角、旋转矩阵、轴角如何相互转换 wexin</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://novav.github.io/2022/07/01/Course/SLAM/ch00_env/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Simon Shi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simon Shi的小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/01/Course/SLAM/ch00_env/" class="post-title-link" itemprop="url">SLAM 依赖环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-01 12:00:00" itemprop="dateCreated datePublished" datetime="2022-07-01T12:00:00+00:00">2022-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-06 08:16:39" itemprop="dateModified" datetime="2025-08-06T08:16:39+00:00">2025-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="依赖库"><a href="#依赖库" class="headerlink" title="依赖库"></a>依赖库</h3><p>cmake</p>
<p>eigen</p>
<p>额外的：</p>
<blockquote>
<p>slam1 pcl</p>
</blockquote>
<blockquote>
<p>slam2 pangolin库</p>
</blockquote>
<h3 id="Pangolin-百度云盘–计算机科学–SLAM"><a href="#Pangolin-百度云盘–计算机科学–SLAM" class="headerlink" title="Pangolin(百度云盘–计算机科学–SLAM)"></a><strong>Pangolin(百度云盘–计算机科学–SLAM)</strong></h3><p>依赖安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libglew-dev</span><br><span class="line"><span class="built_in">sudo</span> apt-get install cmake</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libboost-dev libboost-thread-dev libboost-filesystem-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCPP11_NO_BOOST=1 ..</span><br><span class="line">make -j 4</span><br></pre></td></tr></table></figure>

<h3 id="OpenCV"><a href="#OpenCV" class="headerlink" title="OpenCV"></a>OpenCV</h3><p><a target="_blank" rel="noopener" href="https://docs.opencv.org/4.4.0/d2/d85/classcv_1_1StereoSGBM.html#adb7a50ef5f200ad9559e9b0e976cfa59">OpenCV: cv::StereoSGBM Class Reference</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libopencv-dev</span><br><span class="line">pkg-config --modversion opencv</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.csdn.net/tags/NtzaYg1sMTI2OTgtYmxvZwO0O0OO0O0O.html">ORB_SLAM2安装Pangolin ubuntu16.04 - CSDN</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Simon Shi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">322</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">142</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">269</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Simon Shi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
